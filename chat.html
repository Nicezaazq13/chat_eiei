<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ChatApp - ‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó</title>
    <link rel="stylesheet" href="style.css">
    <style>
 <style>
        /* ========== GLOBAL VARIABLES ========== */
        :root {
            --primary-color: #667eea;
            --primary-dark: #5a67d8;
            --secondary-color: #48bb78;
            --danger-color: #f56565;
            --danger-dark: #e53e3e;
            --text-dark: #2d3748;
            --text-light: #718096;
            --bg-light: #f7fafc;
            --bg-white: #ffffff;
            --border-color: #e2e8f0;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 20px;
            --radius-full: 9999px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-dark);
            line-height: 1.5;
        }

        /* ========== CHAT CONTAINER ========== */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: var(--bg-white);
        }

        /* ========== CHAT HEADER ========== */
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: var(--bg-white);
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .chat-header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .current-room-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .current-room-info h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-dark);
            margin: 0;
        }

        .room-badge {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: var(--radius-xl);
            background: var(--bg-light);
            color: var(--text-light);
            font-weight: 500;
        }

        .online-status {
            font-size: 14px;
            color: var(--secondary-color);
            background: #f0fff4;
            padding: 4px 12px;
            border-radius: var(--radius-xl);
            font-weight: 500;
        }

        /* ========== MOBILE MENU BUTTON ========== */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            color: var(--text-light);
            transition: color 0.2s;
            min-width: 44px;
            min-height: 44px;
        }

        .mobile-menu-btn:hover {
            color: var(--primary-color);
        }

        /* ========== ROOM ACTIONS ========== */
        .room-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }

        .delete-room-btn {
            padding: 6px 12px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .delete-room-btn:hover {
            background: var(--danger-dark);
            transform: translateY(-2px);
        }

        .admin-delete-room-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.2s;
        }

        .admin-delete-room-btn:hover {
            background: var(--danger-dark);
            transform: translateY(-2px);
        }

        /* ========== MAIN CHAT AREA ========== */
        .chat-main {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* ========== ROOMS PANEL (‡∏ã‡πâ‡∏≤‡∏¢) ========== */
        .rooms-panel {
            width: 300px;
            background: var(--bg-light);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .rooms-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .create-room-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .create-room-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .room-tabs {
            display: flex;
            padding: 16px 20px;
            gap: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-btn {
            flex: 1;
            padding: 8px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            color: var(--text-light);
        }

        .tab-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .room-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .room-item {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid transparent;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
            cursor: pointer !important;
            pointer-events: auto !important;
        }

        .room-item:hover {
            border-color: var(--primary-color);
            transform: translateX(5px);
            box-shadow: var(--shadow-md);
        }

        .room-item.active {
            background: var(--primary-color);
            color: white;
        }

        .room-item * {
            pointer-events: none;
        }

        .room-item button {
            pointer-events: auto;
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .room-name {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .room-type-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: var(--radius-xl);
            background: var(--bg-light);
            color: var(--text-light);
        }

        .room-item.active .room-type-badge {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .room-meta {
            font-size: 12px;
            color: var(--text-light);
            display: flex;
            gap: 12px;
            margin-bottom: 4px;
        }

        .room-item.active .room-meta {
            color: rgba(255,255,255,0.8);
        }

        /* ========== CHAT CONTENT (‡∏Å‡∏•‡∏≤‡∏á) ========== */
        .chat-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-white);
        }

        .messages-container {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 70%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .own-message {
            margin-left: auto;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .message-content {
            background: var(--bg-light);
            padding: 12px 16px;
            border-radius: 18px 18px 18px 4px;
            box-shadow: var(--shadow-sm);
            max-width: 100%;
            word-break: break-word;
        }

        .own-message .message-content {
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            color: white;
            border-radius: 18px 18px 4px 18px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .message-author {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 14px;
        }

        .own-message .message-author {
            color: rgba(255,255,255,0.95);
        }

        .message-time {
            font-size: 11px;
            color: var(--text-light);
            margin-left: 8px;
        }

        .own-message .message-time {
            color: rgba(255,255,255,0.8);
        }

        .message-body {
            line-height: 1.5;
            font-size: 14px;
        }

        .message-body a {
            color: inherit;
            text-decoration: underline;
        }

        .message.deleted-message {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 12px 16px;
            margin-bottom: 12px;
            opacity: 0.7;
            max-width: 100%;
        }

        .deleted-content {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-light);
            font-style: italic;
        }

        .delete-message-btn {
            background: none;
            border: none;
            color: #a0aec0;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            opacity: 0;
            margin-left: 8px;
            font-size: 14px;
        }

        .message:hover .delete-message-btn {
            opacity: 1;
        }

        .delete-message-btn:hover {
            background: #fed7d7;
            color: var(--danger-dark);
        }

        .message-checkbox {
            display: flex;
            align-items: center;
            margin-right: 8px;
        }

        .message-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary-color);
        }

        .message.selected {
            background-color: rgba(102, 126, 234, 0.1);
            border-radius: var(--radius-lg);
            padding-left: 8px;
        }

        .message-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: var(--radius-lg);
            margin-top: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            border: 2px solid transparent;
        }

        .message-image:hover {
            transform: scale(1.02);
            border-color: var(--primary-color);
        }

        /* ========== INPUT AREA ========== */
        .message-input-area {
            padding: 16px 24px;
            background: var(--bg-white);
            border-top: 1px solid var(--border-color);
        }

        .input-toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            padding: 0 4px;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            padding: 8px 16px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-light);
        }

        .toolbar-btn:hover {
            background: var(--bg-light);
            border-color: var(--primary-color);
            transform: translateY(-2px);
            color: var(--primary-color);
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            background: var(--bg-light);
            border-radius: var(--radius-xl);
            padding: 4px 4px 4px 20px;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .input-wrapper:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-wrapper textarea {
            flex: 1;
            border: none;
            background: transparent;
            padding: 12px 0;
            max-height: 120px;
            font-size: 15px;
            line-height: 1.5;
            resize: none;
        }

        .input-wrapper textarea:focus {
            outline: none;
        }

        .btn-send {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-xl);
            padding: 10px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-send:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .input-footer {
            margin-top: 8px;
            display: flex;
            justify-content: flex-end;
            color: #a0aec0;
            font-size: 13px;
        }

        .image-preview {
            position: relative;
            margin-top: 12px;
            padding: 12px;
            background: var(--bg-light);
            border-radius: var(--radius-md);
            display: inline-block;
        }

        .image-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: var(--radius-md);
            border: 2px solid var(--border-color);
        }

        .remove-preview {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }

        .remove-preview:hover {
            background: var(--danger-dark);
            transform: scale(1.1);
        }

        /* ========== MEMBERS PANEL ========== */
        .members-panel {
            width: 280px;
            background: var(--bg-white);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .members-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .members-header h3 {
            font-size: 16px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .members-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .member-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            background: var(--bg-light);
            transition: all 0.2s;
        }

        .member-item:hover {
            background: #e2e8f0;
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 14px;
        }

        .member-role {
            font-size: 12px;
            color: var(--text-light);
        }

        .kick-btn {
            padding: 6px 12px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .kick-btn:hover {
            background: var(--danger-dark);
            transform: translateY(-2px);
        }

        /* ========== ACTIVITIES PANEL ========== */
        .activities-panel {
            width: 320px;
            background: var(--bg-white);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .activities-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .activities-header h3 {
            font-size: 16px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .create-activity-btn-container {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .activities-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .activity-item {
            background: var(--bg-light);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 16px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .activity-item:hover {
            border-color: var(--primary-color);
            transform: translateX(5px);
            box-shadow: var(--shadow-md);
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .activity-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 16px;
        }

        .activity-type-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: var(--radius-xl);
            background: var(--bg-white);
            color: var(--text-light);
            text-transform: uppercase;
        }

        .activity-creator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            color: var(--text-light);
        }

        .activity-creator-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
        }

        .activity-description {
            font-size: 14px;
            color: var(--text-dark);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .activity-meta {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            font-size: 12px;
            color: var(--text-light);
        }

        .activity-actions {
            display: flex;
            gap: 12px;
        }

        .join-activity-btn {
            flex: 1;
            padding: 8px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .join-activity-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .join-activity-btn.joined {
            background: var(--danger-color);
        }

        .join-activity-btn.joined:hover {
            background: var(--danger-dark);
        }

        .view-activity-btn {
            padding: 8px 16px;
            background: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-activity-btn:hover {
            background: var(--bg-light);
            border-color: var(--primary-color);
        }

        .activity-status {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: var(--radius-xl);
            background: #48bb78;
            color: white;
        }

        .activity-status.ended {
            background: #a0aec0;
        }

        /* ========== PARTICIPANTS LIST ========== */
        .participants-list {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 16px;
        }

        .participant-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            width: 70px;
        }

        .participant-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid var(--primary-color);
            object-fit: cover;
        }

        .participant-name {
            font-size: 12px;
            color: var(--text-light);
            text-align: center;
            word-break: break-word;
        }

        /* ========== READ RECEIPTS ========== */
        .read-by-container {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-top: 8px;
            padding-top: 4px;
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        .own-message .read-by-container {
            justify-content: flex-start;
            flex-direction: row-reverse;
        }

        .read-icon {
            font-size: 12px;
            color: var(--secondary-color);
            margin-right: 6px;
            font-weight: 600;
        }

        .read-by-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 4px;
            border: 2px solid var(--bg-white);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .read-by-avatar:hover {
            transform: scale(1.2);
            z-index: 10;
        }

        .read-by-more {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--border-color);
            color: var(--text-light);
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
        }

        .read-by-more:hover {
            background: #cbd5e0;
        }

        /* ========== MUSIC PLAYER ========== */
        .music-playlist {
            margin-top: 20px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }

        .playlist-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .playlist-item:hover {
            background: var(--bg-light);
        }

        .playlist-info {
            flex: 1;
        }

        .playlist-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .playlist-artist {
            font-size: 12px;
            color: var(--text-light);
        }

        .playlist-controls {
            display: flex;
            gap: 8px;
        }

        .playlist-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
        }

        .playlist-btn:hover {
            background: var(--border-color);
            transform: scale(1.1);
        }

        /* ========== MUSIC BAR ========== */
        .music-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 2000;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
        }

        .music-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .music-icon {
            font-size: 20px;
        }

        .music-title {
            font-weight: 600;
            font-size: 14px;
        }

        .music-controls {
            display: flex;
            gap: 16px;
        }

        .music-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .music-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        /* ========== DELETE SELECTED BUTTON ========== */
        .delete-selected-btn {
            position: sticky;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--danger-color);
            color: white;
            padding: 12px 24px;
            border-radius: var(--radius-xl);
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(245, 101, 101, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            transition: all 0.3s;
            width: fit-content;
            margin: 0 auto 20px;
            border: none;
        }

        .delete-selected-btn:hover {
            background: var(--danger-dark);
            transform: translateX(-50%) scale(1.05);
        }

        /* ========== ADMIN BUTTON ========== */
        .btn-admin {
            background: #805ad5;
            color: white;
            padding: 8px 16px;
            border-radius: var(--radius-md);
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 8px;
        }

        .btn-admin.active {
            background: #6b46c1;
            box-shadow: 0 0 0 2px rgba(128, 90, 213, 0.3);
        }

        .btn-admin:hover {
            background: #6b46c1;
            transform: translateY(-2px);
        }

        /* ========== MODAL STYLES ========== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-white);
            padding: 30px;
            border-radius: var(--radius-lg);
            width: 450px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        /* ========== EMOJI GRID ========== */
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            padding: 8px;
            max-height: 300px;
            overflow-y: auto;
            background: var(--bg-light);
            border-radius: var(--radius-md);
        }

        .emoji-item {
            font-size: 24px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            border-radius: var(--radius-md);
            transition: all 0.2s;
        }

        .emoji-item:hover {
            background: var(--primary-color);
            transform: scale(1.2);
            color: white;
        }

        /* ========== PASSWORD FIELD ========== */
        .password-field {
            display: none;
        }

        .password-field.show {
            display: block;
        }

        /* ========== ACTIVITY FIELDS ========== */
        .activity-field {
            margin-bottom: 16px;
        }

        /* ========== LIGHTBOX ========== */
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            cursor: pointer;
        }

        .lightbox img {
            max-width: 90%;
            max-height: 90%;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
        }

        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transition: all 0.2s;
        }

        .lightbox-close:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        /* ========== BUTTON STYLES ========== */
        .btn {
            display: inline-block;
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--border-color);
            color: var(--text-light);
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-icon {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: var(--bg-light);
        }

        /* ========== FORM STYLES ========== */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-dark);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group small {
            display: block;
            margin-top: 4px;
            color: var(--text-light);
            font-size: 12px;
        }

        /* ========== USER PROFILE ========== */
        .user-profile {
            display: flex;
            align-items: center;
            margin-right: 16px;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .username {
            font-weight: 600;
            color: var(--text-dark);
        }

        /* ========== UTILITIES ========== */
        .text-center {
            text-align: center;
        }

        .text-muted {
            color: var(--text-light);
        }
        body.sidebar-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        /* ========== MOBILE RESPONSIVE ========== */
        @media (max-width: 768px) {
            .chat-main {
                flex-direction: column;
            }

            .rooms-panel {
                position: fixed !important;
                left: -100%;
                top: 0;
                width: 85% !important;
                height: 100vh !important;
                z-index: 2000;
                transition: left 0.3s ease;
                background: var(--bg-white);
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
                overflow-y: auto;
            }

            .rooms-panel.mobile-active {
                left: 0 !important;
            }

            .rooms-panel .room-item {
                pointer-events: auto !important;
                cursor: pointer !important;
            }

            .members-panel,
            .activities-panel {
                position: fixed !important;
                right: -100%;
                top: 0;
                width: 85% !important;
                height: 100vh !important;
                z-index: 2000;
                transition: right 0.3s ease;
                background: var(--bg-white);
                box-shadow: -2px 0 10px rgba(0,0,0,0.1);
                overflow-y: auto;
            }

            .members-panel.active,
            .activities-panel.active {
                right: 0 !important;
            }

            .mobile-menu-btn {
                display: inline-block !important;
            }

            .current-room-info h2 {
                font-size: 18px;
                max-width: 200px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .room-badge,
            .online-status {
                display: none;
            }

            .user-profile .username {
                display: none;
            }

            .avatar {
                margin-right: 0;
            }

            .message {
                max-width: 85%;
            }

            .message-avatar {
                width: 32px;
                height: 32px;
            }

            .message-input-area {
                padding: 12px 16px;
            }

            .toolbar-btn {
                padding: 8px 12px;
                font-size: 14px;
            }

            .input-wrapper textarea {
                font-size: 16px;
            }

            .input-footer {
                display: none;
            }

            .participant-item {
                width: 60px;
            }

            .participant-avatar {
                width: 40px;
                height: 40px;
            }

            .emoji-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        @media (max-width: 375px) {
            .current-room-info h2 {
                max-width: 150px;
                font-size: 16px;
            }

            .toolbar-btn {
                padding: 6px 10px;
                font-size: 13px;
            }

            .message {
                max-width: 90%;
            }

            .emoji-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* ========== KEYBOARD OPEN FIX ========== */
        .keyboard-open .chat-container {
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .keyboard-open .message-input-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-white);
            z-index: 2000;
        }

        .keyboard-open .messages-container {
            padding-bottom: 120px;
        }

        /* ========== iOS SPECIFIC FIXES ========== */
        @supports (-webkit-touch-callout: none) {
            .chat-container {
                height: -webkit-fill-available;
            }

            .message-input-area {
                padding-bottom: max(12px, env(safe-area-inset-bottom, 12px));
            }

            .chat-header {
                padding-top: max(12px, env(safe-area-inset-top, 12px));
            }
        }

        /* ========== ANIMATIONS ========== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }

        @keyframes slideOut {
            from { transform: translateX(0); }
            to { transform: translateX(-100%); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* ========== SCROLLBAR STYLING ========== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-light);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: var(--radius-full);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-light);
        }
        .view-activity-btn {
            pointer-events: auto !important;
            cursor: pointer !important;
            position: relative;
            z-index: 10;
        }
        
        .activity-item {
            position: relative;
            z-index: 1;
        }
        
        .activity-actions {
            position: relative;
            z-index: 5;
        }
        
        /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô event bubbling */
        .activity-item * {
            pointer-events: auto;
        }
        
        /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç z-index ‡∏Ç‡∏≠‡∏á modal */
        #youtubePlayerModal {
            z-index: 9999 !important;
        }
        
        /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏™‡∏¥‡πà‡∏á‡∏≠‡∏∑‡πà‡∏ô */
        .join-activity-btn, .view-activity-btn {
            pointer-events: auto !important;
            cursor: pointer !important;
            opacity: 1 !important;
        }
    <!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ChatApp - ‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ========== CSS ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ ========== */
        /* (‡πÉ‡∏™‡πà CSS ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°) */
        
        /* ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞ z-index */
        .view-activity-btn {
            pointer-events: auto !important;
            cursor: pointer !important;
            position: relative;
            z-index: 100;
            background: var(--bg-white);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 8px 16px;
            border-radius: var(--radius-md);
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .view-activity-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }
        
        .join-activity-btn {
            pointer-events: auto !important;
            cursor: pointer !important;
            position: relative;
            z-index: 100;
        }
        
        .activity-item {
            position: relative;
            z-index: 1;
        }
        
        .activity-actions {
            position: relative;
            z-index: 50;
            pointer-events: auto !important;
        }
        
        .activity-actions button {
            pointer-events: auto !important;
            cursor: pointer !important;
        }
        
        /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç z-index ‡∏Ç‡∏≠‡∏á modal */
        #youtubePlayerModal {
            z-index: 9999 !important;
        }
        
        #youtubePlayerModal .modal-content {
            z-index: 10000;
            position: relative;
        }
        .debug-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 10001;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Debug info (‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ) -->
    <div id="debugInfo" class="debug-info"></div>

    <div class="chat-container">
        <!-- ========== HEADER ========== -->
        <div class="chat-header">
            <div class="chat-header-left">
                <button class="mobile-menu-btn" onclick="window.toggleMobileSidebar()">‚ò∞</button>
                <div class="current-room-info">
                    <h2 id="currentRoomTitle">üí¨ ‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞</h2>
                    <span class="room-badge" id="currentRoomTypeBadge">‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞</span>
                    <div id="roomActions" class="room-actions"></div>
                </div>
                <span class="online-status" id="onlineStatus">üü¢ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</span>
            </div>
            <div class="chat-header-right">
                <div class="user-profile" id="userProfile"></div>
                <button id="adminModeBtn" onclick="window.toggleAdminMode()" class="btn btn-admin" style="display: none;">üëë ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏õ‡∏¥‡∏î)</button>
                <button onclick="window.logout()" class="btn btn-outline">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>

        <!-- ========== MAIN CHAT AREA ========== -->
        <div class="chat-main">
            <!-- ROOMS PANEL (‡∏ã‡πâ‡∏≤‡∏¢) -->
            <div class="rooms-panel">
                <div class="rooms-header">
                    <button class="create-room-btn" onclick="window.showCreateRoomModal()">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
                </div>
                <div class="room-tabs">
                    <button class="tab-btn active" onclick="window.filterRooms('all', this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    <button class="tab-btn" onclick="window.filterRooms('public', this)">‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞</button>
                    <button class="tab-btn" onclick="window.filterRooms('private', this)">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</button>
                </div>
                <div class="room-list" id="roomList">
                    <div style="text-align: center; padding: 40px 20px; color: #a0aec0;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡πâ‡∏≠‡∏á...</div>
                </div>
            </div>

            <!-- MESSAGES AREA (‡∏Å‡∏•‡∏≤‡∏á) -->
            <div class="chat-content">
                <div class="messages-container" id="messagesContainer"></div>
                <div id="deleteSelectedBtn" class="delete-selected-btn" style="display: none;" onclick="window.deleteSelectedMessages()">üóëÔ∏è ‡∏•‡∏ö 0 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</div>
                
                <!-- Input Area -->
                <div class="message-input-area" id="messageInputArea">
                    <div class="input-toolbar">
                        <button type="button" class="toolbar-btn" onclick="window.openEmojiPicker()" title="‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥">üòä</button>
                        <button type="button" class="toolbar-btn" onclick="window.uploadImage()" title="‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û">üì∑</button>
                        <button type="button" class="toolbar-btn" onclick="window.openMusicPlayer()" title="‡πÄ‡∏û‡∏•‡∏á">üéµ</button>
                        <button type="button" class="toolbar-btn" onclick="window.toggleActivitiesPanel()" title="‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°">üéÆ</button>
                        <button type="button" class="toolbar-btn" onclick="window.toggleMembersPanel()" title="‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å">üë•</button>
                        <button type="button" class="toolbar-btn" onclick="window.openYoutubePlaylist()" title="YouTube Playlist">üì∫ ‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå</button>
                    </div>
                    
                    <div class="input-wrapper">
                        <textarea id="messageInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." rows="1"></textarea>
                        <button id="sendButton" class="btn-send">üì§ ‡∏™‡πà‡∏á</button>
                    </div>
                    
                    <div id="imagePreview" class="image-preview" style="display: none;">
                        <img id="previewImg" src="" alt="Preview">
                        <button type="button" class="remove-preview" onclick="window.clearImagePreview()">‚úï</button>
                    </div>
                    
                    <div class="input-footer">
                        <span class="character-count" id="charCount">0/500</span>
                    </div>
                </div>
            </div>

            <!-- MEMBERS PANEL (‡∏Ç‡∏ß‡∏≤) -->
            <div class="members-panel" id="membersPanel">
                <div class="members-header">
                    <h3>üë• ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á</h3>
                    <button onclick="window.toggleMembersPanel()" class="btn-icon">‚úï</button>
                </div>
                <div class="members-list" id="membersList"></div>
            </div>

            <!-- ACTIVITIES PANEL (‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°) -->
            <div class="activities-panel" id="activitiesPanel">
                <div class="activities-header">
                    <h3>üéÆ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á</h3>
                    <button onclick="window.toggleActivitiesPanel()" class="btn-icon">‚úï</button>
                </div>
                
                <div class="create-activity-btn-container">
                    <button onclick="window.showCreateActivityModal()" class="btn btn-primary" style="width: 100%;">
                        ‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
                    </button>
                </div>
                
                <div class="activities-list" id="activitiesList">
                    <div style="text-align: center; padding: 40px 20px; color: #718096;">
                        üéÆ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°<br>
                        <small>‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SIDEBAR OVERLAY -->
    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <!-- ========== MODAL: ‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥ ========== -->
    <div id="emojiPickerModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                <span>üòä</span> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥
            </h3>
            <div class="emoji-grid" id="emojiGrid"></div>
            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button onclick="window.closeEmojiPicker()" class="btn btn-secondary" style="flex: 1;">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <!-- ========== MODAL: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á ========== -->
    <div id="createRoomModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 24px;">üìù ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</h2>
            <form id="createRoomForm">
                <div class="form-group">
                    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á <span style="color: #e53e3e;">*</span></label>
                    <input type="text" id="roomName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°" required>
                </div>
                <div class="form-group">
                    <label>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
                    <textarea id="roomDescription" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡πâ‡∏≠‡∏á..." rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á</label>
                    <select id="roomType" onchange="window.togglePasswordField()">
                        <option value="public">üåç ‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞ - ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏î‡πâ</option>
                        <option value="private">üîí ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß - ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</option>
                    </select>
                </div>
                <div id="passwordField" class="password-field">
                    <div class="form-group">
                        <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏´‡πâ‡∏≠‡∏á</label>
                        <input type="password" id="roomPassword" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                    </div>
                    <div class="form-group">
                        <label>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                        <input type="password" id="confirmPassword" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á">
                    </div>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á</button>
                    <button type="button" class="btn btn-secondary" onclick="window.closeCreateRoomModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ========== MODAL: ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß ========== -->
    <div id="joinPrivateRoomModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 24px;">üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h2>
            <p id="joinRoomName" style="margin-bottom: 20px; font-weight: 600;"></p>
            <div class="form-group">
                <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏´‡πâ‡∏≠‡∏á</label>
                <input type="password" id="joinRoomPassword" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            </div>
            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button onclick="window.confirmJoinPrivateRoom()" class="btn btn-primary" style="flex: 1;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</button>
                <button onclick="window.closeJoinPrivateModal()" class="btn btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- ========== MODAL: ‡πÄ‡∏ï‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ========== -->
    <div id="kickMemberModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 24px;">‚ö†Ô∏è ‡πÄ‡∏ï‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
            <p id="kickMemberName" style="margin-bottom: 20px;"></p>
            <p style="color: #718096; margin-bottom: 24px;">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á?</p>
            <div style="display: flex; gap: 12px;">
                <button onclick="window.confirmKickMember()" class="btn" style="flex: 1; background: #f56565; color: white;">‡πÄ‡∏ï‡∏∞‡∏≠‡∏≠‡∏Å</button>
                <button onclick="window.closeKickModal()" class="btn btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- ========== MODAL: ‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á ========== -->
    <div id="deleteRoomModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 24px; color: #f56565;">‚ö†Ô∏è ‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á</h2>
            <p id="deleteRoomName" style="margin-bottom: 20px; font-weight: 600;"></p>
            <p style="color: #718096; margin-bottom: 24px;">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£<br><strong>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ!</strong></p>
            <div style="display: flex; gap: 12px;">
                <button onclick="window.confirmDeleteRoom()" class="btn" style="flex: 1; background: #f56565; color: white;">üóëÔ∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</button>
                <button onclick="window.closeDeleteRoomModal()" class="btn btn-secondary" style="flex: 1;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- ========== MODAL: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ========== -->
    <div id="createActivityModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                <span>üéÆ</span> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà
            </h3>
            
            <form id="createActivityForm">
                <div class="form-group">
                    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° <span style="color: #e53e3e;">*</span></label>
                    <input type="text" id="activityTitle" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏î‡∏π‡∏´‡∏ô‡∏±‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô, ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°" required>
                </div>
                
                <div class="form-group">
                    <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
                    <select id="activityType" onchange="window.toggleActivityTypeFields()">
                        <option value="youtube">üì∫ ‡∏î‡∏π YouTube ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô</option>
                        <option value="game">üéÆ ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°</option>
                        <option value="poll">üìä ‡πÇ‡∏´‡∏ß‡∏ï</option>
                        <option value="custom">‚ú® ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                    </select>
                </div>
                
                <div id="youtubeField" class="activity-field">
                    <div class="form-group">
                        <label>URL YouTube</label>
                        <input type="text" id="youtubeUrl" placeholder="https://youtube.com/watch?v=...">
                        <small>üìå ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö youtube.com ‡πÅ‡∏•‡∏∞ youtu.be</small>
                    </div>
                </div>
                
                <div id="gameField" class="activity-field" style="display: none;">
                    <div class="form-group">
                        <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏°</label>
                        <input type="text" id="gameName" placeholder="‡πÄ‡∏ä‡πà‡∏ô Among Us, Valorant">
                    </div>
                </div>
                
                <div id="pollField" class="activity-field" style="display: none;">
                    <div class="form-group">
                        <label>‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ,)</label>
                        <input type="text" id="pollOptions" placeholder="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å1, ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å2, ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å3">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
                    <textarea id="activityDescription" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°..." rows="2"></textarea>
                </div>
                
                <div class="form-group">
                    <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (0 = ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î)</label>
                    <input type="number" id="maxParticipants" value="0" min="0" max="50">
                </div>
                
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
                    <button type="button" class="btn btn-secondary" onclick="window.closeCreateActivityModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ========== YOUTUBE PLAYLIST MODAL ========== -->
    <div id="youtubePlaylistModal" class="modal">
        <div class="modal-content">
            <div class="youtube-playlist-header">
                <h3>üì∫ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå YouTube</h3>
                <button onclick="window.closeYoutubePlaylist()" class="btn-icon" style="font-size: 24px;">‚úï</button>
            </div>
            
            <div class="playlist-layout">
                <!-- ‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏•‡∏¥‡∏õ -->
                <div class="search-section">
                    <h4>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏•‡∏¥‡∏õ</h4>
                    <div class="playlist-search">
                        <input type="text" id="youtubeSearchInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
                        <button id="youtubeSearchBtn" onclick="window.searchYoutube()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                    </div>
                    
                    <div id="searchResults" class="search-results">
                        <div style="text-align: center; padding: 40px; color: #718096;">
                            üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏Ñ‡∏•‡∏¥‡∏õ YouTube
                        </div>
                    </div>
                </div>
                
                <!-- ‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤: ‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå -->
                <div class="playlist-section">
                    <h4>
                        üìã ‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á
                        <span class="playlist-count" id="playlistCount">0 ‡∏Ñ‡∏•‡∏¥‡∏õ</span>
                    </h4>
                    
                    <div id="playlistItems" class="playlist-items">
                        <div style="text-align: center; padding: 40px; color: #718096;">
                            üìã ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏•‡∏¥‡∏õ‡πÉ‡∏ô‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå<br>
                            <small>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏¥‡∏õ‡∏à‡∏≤‡∏Å‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px;">
                <button onclick="window.closeYoutubePlaylist()" class="btn btn-secondary" style="flex: 1;">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <!-- ========== YOUTUBE PLAYER MODAL ========== -->
    <div id="youtubePlayerModal" class="modal" style="z-index: 9999;">
        <div class="modal-content" style="max-width: 900px; width: 90%; padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="display: flex; align-items: center; gap: 8px;">
                    <span>üì∫</span> <span id="youtubeActivityTitle">YouTube Player</span>
                </h3>
                <button onclick="window.closeYoutubePlayer()" class="btn-icon" style="font-size: 24px;">‚úï</button>
            </div>
            
            <div id="youtubePlayerContainer" style="position: relative; width: 100%; padding-bottom: 56.25%; background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                <div id="youtube-player" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>
            </div>
            
            <div class="youtube-controls" style="display: flex; gap: 12px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap;">
                <button onclick="window.syncPlayPause()" id="syncPlayPauseBtn" class="btn btn-primary" style="display: flex; align-items: center; gap: 4px;">‚è∏Ô∏è ‡∏´‡∏¢‡∏∏‡∏î</button>
                <button onclick="window.syncSeek(-10)" class="btn btn-secondary" style="display: flex; align-items: center; gap: 4px;">‚è™ -10</button>
                <button onclick="window.syncSeek(10)" class="btn btn-secondary" style="display: flex; align-items: center; gap: 4px;">‚è© +10</button>
                <button onclick="window.syncRestart()" class="btn btn-secondary" style="display: flex; align-items: center; gap: 4px;">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
            </div>
            
            <div id="youtubePlayerState" style="color: var(--text-light); font-size: 14px; text-align: center;">
                ‚è∏Ô∏è ‡∏´‡∏¢‡∏∏‡∏î
            </div>
        </div>
    </div>

    <!-- ========== MUSIC PLAYER MODAL ========== -->
    <div id="musicPlayerModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                <span>üéµ</span> ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏á
            </h3>
            <div class="form-group">
                <label>URL ‡πÄ‡∏û‡∏•‡∏á (MP3 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</label>
                <input type="text" id="musicUrlInput" placeholder="https://example.com/song.mp3">
                <small style="color: #e53e3e;">‚ö†Ô∏è ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå .mp3 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</small>
            </div>
            <button onclick="window.addMusicToRoom()" class="btn btn-primary" style="width: 100%; margin-bottom: 20px;">
                ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏•‡∏á
            </button>
            
            <div class="music-playlist">
                <h4 style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    üìã ‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå‡πÄ‡∏û‡∏•‡∏á
                </h4>
                <div id="musicPlaylistItems" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button onclick="window.closeMusicPlayer()" class="btn btn-secondary" style="flex: 1;">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <!-- ========== MUSIC BAR ========== -->
    <div id="currentMusicBar" class="music-bar" style="display: none;">
        <div class="music-info">
            <span class="music-icon">üéµ</span>
            <span id="currentMusicTitle" class="music-title">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏á...</span>
        </div>
        <div class="music-controls">
            <button onclick="window.togglePlayPause()" id="playPauseBtn" class="music-btn">‚è∏Ô∏è</button>
            <button onclick="window.stopMusic()" class="music-btn">‚èπÔ∏è</button>
            <button onclick="window.hideMusicBar()" class="music-btn">‚úï</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ========== CONFIGURATION ==========
        const SUPABASE_URL = 'https://xaugtjljfkjqfpmnsxko.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhhdWd0amxqZmtqcWZwbW5zeGtvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg5MzY4MDAsImV4cCI6MjA1NDUxMjgwMH0.dQmB1nHJyBJNKswVskAQXYwPsvsy';
        
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase client ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö session ‡πÉ‡∏ô localStorage
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true,
                storage: localStorage
            }
        });
        
        // YouTube API Key
        const YOUTUBE_API_KEY = 'AIzaSyC1-oYQ-P2u7qvIVv9-Dssu64Y3JqyJ62k';
        
        // ========== GLOBAL VARIABLES ==========
        window.currentUser = null;
        window.currentRoom = null;
        window.currentRoomId = '00000000-0000-0000-0000-000000000000';
        window.messageSubscription = null;
        window.messagesContainer = document.getElementById('messagesContainer');
        window.messageInput = document.getElementById('messageInput');
        window.sendButton = document.getElementById('sendButton');
        window.isAdmin = false;
        window.isAdminMode = false;
        window.selectedMessages = new Set();
        window.selectedImageFile = null;
        window.currentMusic = null;
        window.audioPlayer = null;
        
        // YouTube Variables
        window.youtubePlayer = null;
        window.youtubePlayerReady = false;
        window.youtubeApiReady = false;
        window.youtubeActivityId = null;
        window.youtubeLoadAttempts = 0;
        
        // YouTube Playlist Variables
        window.youtubePlaylist = [];
        window.searchTimeout = null;

        const PUBLIC_ROOM_ID = '00000000-0000-0000-0000-000000000000';
        const STORAGE_KEY = 'chat_last_room_id';
        
        const emojiList = ['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üôÉ','üòâ','üòå','üòç','ü•∞','üòò','üòó','üòô','üòö','üòã','üòõ','üòù','üòú','ü§™','ü§®','üßê','ü§ì','üòé','ü•≥','üòè','üòí','üòû','üòî','üòü','üòï','üôÅ','‚òπÔ∏è','üò£','üòñ','üò´','üò©','ü•∫','üò¢','üò≠','üò§','üò†','üò°','ü§¨','ü§Ø','üò≥','ü•µ','ü•∂','üò±','üò®','üò∞','üò•','üòì','ü§ó','ü§î','ü§≠','ü§´','ü§•','üò∂','üòê','üòë','üò¨','üôÑ','üòØ','üò¶','üòß','üòÆ','üò≤','ü•±','üò¥','ü§§','üò™','üòµ','ü§ê','ü•¥','ü§¢','ü§Æ','ü§ß','üò∑','ü§í','ü§ï','ü§ë','ü§†','üòà','üëø','üëπ','üë∫','ü§°','üí©','üëª','üíÄ','‚ò†Ô∏è','üëΩ','üëæ','ü§ñ','üéÉ','üò∫','üò∏','üòπ','üòª','üòº','üòΩ','üôÄ','üòø','üòæ'];

        // ========== DEBUG FUNCTION ==========
        window.debug = function(msg) {
            console.log('üîç DEBUG:', msg);
            const debugEl = document.getElementById('debugInfo');
            if (debugEl) {
                debugEl.innerHTML = msg + '<br>' + debugEl.innerHTML;
                debugEl.style.display = 'block';
                setTimeout(() => {
                    debugEl.style.display = 'none';
                }, 3000);
            }
        };

        // ========== CHECK USER ==========
        window.checkUser = async function() {
            try {
                // ‡∏î‡∏∂‡∏á session ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                
                if (sessionError) {
                    console.error('Session error:', sessionError);
                    return null;
                }
                
                if (!session) {
                    console.log('No session found');
                    return null;
                }
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ token ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
                const expiresAt = session.expires_at;
                if (expiresAt && Date.now() / 1000 > expiresAt) {
                    console.log('Session expired, refreshing...');
                    // Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏•‡∏≠‡∏á refresh
                    const { data: refreshData, error: refreshError } = await supabaseClient.auth.refreshSession();
                    if (refreshError || !refreshData.session) {
                        console.error('Refresh failed:', refreshError);
                        return null;
                    }
                    return refreshData.user;
                }
                
                return session.user;
                
            } catch (error) {
                console.error('Error checking user:', error);
                return null;
            }
        };

        // ========== SESSION MANAGER ==========
        window.setupSessionManager = function() {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö session ‡∏ó‡∏∏‡∏Å‡πÜ 5 ‡∏ô‡∏≤‡∏ó‡∏µ
            setInterval(async () => {
                try {
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    
                    if (!session) {
                        console.log('Session expired, redirecting...');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    // ‡∏ñ‡πâ‡∏≤ token ‡∏à‡∏∞‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å 10 ‡∏ô‡∏≤‡∏ó‡∏µ ‡πÉ‡∏´‡πâ refresh
                    const expiresAt = session.expires_at;
                    const timeUntilExpiry = expiresAt - (Date.now() / 1000);
                    
                    if (timeUntilExpiry < 600) { // ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 10 ‡∏ô‡∏≤‡∏ó‡∏µ
                        console.log('Refreshing session...');
                        const { data, error } = await supabaseClient.auth.refreshSession();
                        if (error) throw error;
                        console.log('Session refreshed successfully');
                    }
                    
                    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
                    if (window.currentUser) {
                        await supabaseClient
                            .from('profiles')
                            .update({ 
                                last_seen: new Date().toISOString(),
                                is_online: true 
                            })
                            .eq('id', window.currentUser.id);
                    }
                } catch (error) {
                    console.error('Session check error:', error);
                }
            }, 60000); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å 1 ‡∏ô‡∏≤‡∏ó‡∏µ
        };

        // ========== YOUTUBE PLAYLIST FUNCTIONS ==========
        window.openYoutubePlaylist = function() {
            const modal = document.getElementById('youtubePlaylistModal');
            if (modal) {
                modal.classList.add('active');
                window.loadYoutubePlaylist();
            }
        };

        window.closeYoutubePlaylist = function() {
            const modal = document.getElementById('youtubePlaylistModal');
            if (modal) modal.classList.remove('active');
        };

        window.searchYoutube = async function() {
            const query = document.getElementById('youtubeSearchInput').value.trim();
            if (!query) {
                alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤');
                return;
            }
            
            const searchBtn = document.getElementById('youtubeSearchBtn');
            searchBtn.disabled = true;
            searchBtn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...';
            
            try {
                const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=20&q=${encodeURIComponent(query)}&type=video&key=${YOUTUBE_API_KEY}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }
                
                const results = document.getElementById('searchResults');
                
                if (!data.items || data.items.length === 0) {
                    results.innerHTML = '<div style="text-align: center; padding: 40px; color: #718096;">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>';
                    return;
                }
                
                const videoIds = data.items.map(item => item.id.videoId).join(',');
                const detailsResponse = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=contentDetails&id=${videoIds}&key=${YOUTUBE_API_KEY}`);
                const detailsData = await detailsResponse.json();
                
                const durationMap = {};
                if (detailsData.items) {
                    detailsData.items.forEach(item => {
                        durationMap[item.id] = item.contentDetails.duration;
                    });
                }
                
                results.innerHTML = data.items.map(item => {
                    const videoId = item.id.videoId;
                    const title = item.snippet.title;
                    const channel = item.snippet.channelTitle;
                    const thumbnail = item.snippet.thumbnails.medium.url;
                    const duration = window.formatDuration(durationMap[videoId]);
                    const isInPlaylist = window.youtubePlaylist.some(v => v.video_id === videoId);
                    
                    return `
                        <div class="search-result-item">
                            <img src="${thumbnail}" alt="${title}" class="search-result-thumbnail" onclick="window.playYoutubeVideo('${videoId}')">
                            <div class="search-result-info">
                                <div class="search-result-title" title="${title}">${title}</div>
                                <div class="search-result-channel">${channel}</div>
                                <div class="search-result-duration">‚è±Ô∏è ${duration}</div>
                            </div>
                            <button class="search-result-add ${isInPlaylist ? 'added' : ''}" onclick="window.addToYoutubePlaylist('${videoId}', '${title.replace(/'/g, "\\'")}', '${channel.replace(/'/g, "\\'")}', '${thumbnail}')">
                                ${isInPlaylist ? '‚úì ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß' : '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°'}
                            </button>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('‚ùå Error searching YouTube:', error);
                document.getElementById('searchResults').innerHTML = `<div style="text-align: center; padding: 40px; color: #f56565;">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</div>`;
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
            }
        };

        window.formatDuration = function(duration) {
            if (!duration) return '00:00';
            
            const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
            
            const hours = (match[1] || '').replace('H', '');
            const minutes = (match[2] || '').replace('M', '');
            const seconds = (match[3] || '').replace('S', '');
            
            if (hours) {
                return `${hours.padStart(2, '0')}:${(minutes || '0').padStart(2, '0')}:${(seconds || '0').padStart(2, '0')}`;
            } else {
                return `${(minutes || '0').padStart(2, '0')}:${(seconds || '0').padStart(2, '0')}`;
            }
        };

        window.addToYoutubePlaylist = async function(videoId, title, channel, thumbnail) {
            if (!window.currentRoomId) {
                alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }
            
            try {
                if (window.youtubePlaylist.some(v => v.video_id === videoId)) {
                    alert('‚ö†Ô∏è ‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß');
                    return;
                }
                
                const newItem = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                    room_id: window.currentRoomId,
                    user_id: window.currentUser.id,
                    video_id: videoId,
                    title: title,
                    channel: channel,
                    thumbnail: thumbnail,
                    added_at: new Date().toISOString(),
                    added_by: window.currentUser.user_metadata?.display_name || window.currentUser.user_metadata?.username || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'
                };
                
                window.youtubePlaylist.unshift(newItem);
                window.displayYoutubePlaylist(window.youtubePlaylist);
                
                const addBtn = document.querySelector(`.search-result-add[onclick*="${videoId}"]`);
                if (addBtn) {
                    addBtn.classList.add('added');
                    addBtn.textContent = '‚úì ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß';
                }
                
                alert('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏¥‡∏õ‡∏•‡∏á‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß');
                
            } catch (error) {
                console.error('‚ùå Error adding to playlist:', error);
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏¥‡∏õ‡πÑ‡∏î‡πâ: ' + error.message);
            }
        };

        window.loadYoutubePlaylist = async function() {
            if (!window.currentRoomId) return;
            
            try {
                const roomPlaylist = window.youtubePlaylist.filter(item => item.room_id === window.currentRoomId);
                window.displayYoutubePlaylist(roomPlaylist);
                
            } catch (error) {
                console.error('‚ùå Error loading playlist:', error);
            }
        };

        window.displayYoutubePlaylist = function(playlist) {
            const container = document.getElementById('playlistItems');
            const countEl = document.getElementById('playlistCount');
            
            if (!container) return;
            
            if (countEl) {
                countEl.textContent = `${playlist.length} ‡∏Ñ‡∏•‡∏¥‡∏õ`;
            }
            
            if (playlist.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #718096;">üìã ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏•‡∏¥‡∏õ‡πÉ‡∏ô‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå<br><small>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏¥‡∏õ‡∏à‡∏≤‡∏Å‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢</small></div>';
                return;
            }
            
            container.innerHTML = playlist.map(item => {
                const isOwner = item.user_id === window.currentUser?.id;
                
                return `
                    <div class="playlist-item">
                        <img src="${item.thumbnail || `https://img.youtube.com/vi/${item.video_id}/mqdefault.jpg`}" 
                             alt="${item.title}" 
                             class="playlist-item-thumbnail" 
                             onclick="window.playYoutubeVideo('${item.video_id}')">
                        <div class="playlist-item-info">
                            <div class="playlist-item-title" title="${item.title}">${item.title}</div>
                            <div class="playlist-item-channel">${item.channel}</div>
                            <div class="playlist-item-added-by">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢ ${item.added_by}</div>
                        </div>
                        <div class="playlist-item-controls">
                            <button class="playlist-item-play" onclick="window.playYoutubeVideo('${item.video_id}')">‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô</button>
                            ${isOwner || window.isAdmin ? 
                                `<button class="playlist-item-remove" onclick="window.removeFromYoutubePlaylist('${item.id}')">üóëÔ∏è ‡∏•‡∏ö</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        };

        window.removeFromYoutubePlaylist = async function(playlistId) {
            if (!confirm('üóëÔ∏è ‡∏•‡∏ö‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå?')) return;
            
            try {
                window.youtubePlaylist = window.youtubePlaylist.filter(item => item.id !== playlistId);
                window.displayYoutubePlaylist(window.youtubePlaylist);
                alert('‚úÖ ‡∏•‡∏ö‡∏Ñ‡∏•‡∏¥‡∏õ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß');
                
            } catch (error) {
                console.error('‚ùå Error removing from playlist:', error);
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ñ‡∏•‡∏¥‡∏õ‡πÑ‡∏î‡πâ');
            }
        };

        window.playYoutubeVideo = function(videoId) {
            window.openYoutubePlayer(videoId);
        };

        // ========== YOUTUBE PLAYER FUNCTIONS ==========
        window.loadYouTubeAPI = function() {
            if (window.YT && window.YT.Player) {
                window.youtubeApiReady = true;
                console.log('‚úÖ YouTube API already loaded');
                return;
            }
            
            console.log('üì¶ Loading YouTube API...');
            const tag = document.createElement('script');
            tag.src = 'https://www.youtube.com/iframe_api';
            const firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        };

        window.onYouTubeIframeAPIReady = function() {
            window.youtubeApiReady = true;
            console.log('‚úÖ YouTube API Ready');
            window.debug('YouTube API ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
        };

        window.openYoutubePlayerFromActivity = function(videoId, activityId) {
            console.log('üé¨ Opening YouTube player from activity:', videoId, activityId);
            window.debug('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î YouTube: ' + videoId);
            
            if (!videoId) {
                alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Video ID');
                return;
            }
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î YouTube Player
            window.openYoutubePlayer(videoId);
            
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ activityId ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
            if (activityId) {
                window.youtubeActivityId = activityId;
            }
        };

        window.openYoutubePlayer = function(videoId) {
            console.log('üé¨ Opening YouTube player with videoId:', videoId);
            window.debug('‡πÄ‡∏õ‡∏¥‡∏î YouTube Player: ' + videoId);
            
            if (!videoId) {
                alert('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ Video ID');
                return;
            }
            
            const modal = document.getElementById('youtubePlayerModal');
            const container = document.getElementById('youtube-player');
            const titleEl = document.getElementById('youtubeActivityTitle');
            
            if (!modal) {
                console.error('‚ùå Modal not found');
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö Modal YouTube Player');
                return;
            }
            
            if (!container) {
                console.error('‚ùå Container not found');
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö Container YouTube Player');
                return;
            }
            
            // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î API
            if (!window.youtubeApiReady) {
                window.loadYouTubeAPI();
                
                window.youtubeLoadAttempts++;
                if (window.youtubeLoadAttempts > 3) {
                    alert('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î YouTube Player ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
                    window.youtubeLoadAttempts = 0;
                    return;
                }
                
                alert('‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î YouTube Player ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...');
                
                // ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                setTimeout(() => {
                    if (window.youtubeApiReady) {
                        window.openYoutubePlayer(videoId);
                    } else {
                        window.openYoutubePlayer(videoId); // ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                    }
                }, 2000);
                return;
            }
            
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡∏ô‡∏±‡∏ö‡∏•‡∏≠‡∏á
            window.youtubeLoadAttempts = 0;
            
            // ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ player ‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
            if (window.youtubePlayer) {
                try {
                    window.youtubePlayer.destroy();
                } catch (e) {
                    console.log('Error destroying old player:', e);
                }
                window.youtubePlayer = null;
            }
            
            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° container
            container.innerHTML = '';
            
            const playerContainer = document.createElement('div');
            playerContainer.id = 'youtube-player-container';
            playerContainer.style.width = '100%';
            playerContainer.style.height = '100%';
            container.appendChild(playerContainer);
            
            if (titleEl) {
                titleEl.textContent = 'YouTube Player';
            }
            
            // ‡πÅ‡∏™‡∏î‡∏á modal
            modal.style.display = 'flex';
            modal.classList.add('active');
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á player ‡πÉ‡∏´‡∏°‡πà
            try {
                console.log('üé¨ Creating new YT.Player with videoId:', videoId);
                
                window.youtubePlayer = new YT.Player('youtube-player-container', {
                    height: '100%',
                    width: '100%',
                    videoId: videoId,
                    playerVars: {
                        'autoplay': 1,
                        'controls': 1,
                        'rel': 0,
                        'modestbranding': 1,
                        'enablejsapi': 1,
                        'playsinline': 1
                    },
                    events: {
                        'onReady': function(event) {
                            console.log('‚úÖ YouTube Player ready');
                            window.youtubePlayerReady = true;
                            const btn = document.getElementById('syncPlayPauseBtn');
                            if (btn) btn.innerHTML = '‚è∏Ô∏è ‡∏´‡∏¢‡∏∏‡∏î';
                            window.debug('YouTube Player ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                        },
                        'onStateChange': function(event) {
                            const state = event.data;
                            const btn = document.getElementById('syncPlayPauseBtn');
                            const stateEl = document.getElementById('youtubePlayerState');
                            
                            if (btn) {
                                if (state === YT.PlayerState.PLAYING) {
                                    btn.innerHTML = '‚è∏Ô∏è ‡∏´‡∏¢‡∏∏‡∏î';
                                    if (stateEl) stateEl.textContent = '‚ñ∂Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô';
                                } else if (state === YT.PlayerState.PAUSED) {
                                    btn.innerHTML = '‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô';
                                    if (stateEl) stateEl.textContent = '‚è∏Ô∏è ‡∏´‡∏¢‡∏∏‡∏î';
                                } else if (state === YT.PlayerState.ENDED) {
                                    btn.innerHTML = '‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà';
                                    if (stateEl) stateEl.textContent = '‚èπÔ∏è ‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß';
                                }
                            }
                        },
                        'onError': function(event) {
                            console.error('‚ùå YouTube error:', event.data);
                            let msg = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡πà‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ';
                            if (event.data === 2) msg = '‚ùå Video ID ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                            if (event.data === 5) msg = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡πà‡∏ô HTML5 player ‡πÑ‡∏î‡πâ';
                            if (event.data === 100) msg = '‚ùå ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡∏•‡∏ö';
                            if (event.data === 101 || event.data === 150) msg = '‚ùå ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πà‡∏ô';
                            alert(msg);
                            window.debug('YouTube Error: ' + msg);
                        }
                    }
                });
                
                console.log('‚úÖ YouTube Player created successfully');
                window.debug('‡∏™‡∏£‡πâ‡∏≤‡∏á YouTube Player ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                
            } catch (e) {
                console.error('‚ùå Error creating YouTube player:', e);
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á YouTube Player ‡πÑ‡∏î‡πâ: ' + e.message);
                window.debug('Error: ' + e.message);
            }
        };

        window.closeYoutubePlayer = function() {
            const modal = document.getElementById('youtubePlayerModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('active');
            }
            
            if (window.youtubePlayer) {
                try {
                    window.youtubePlayer.destroy();
                } catch (e) {}
                window.youtubePlayer = null;
            }
            
            const container = document.getElementById('youtube-player');
            if (container) {
                container.innerHTML = '';
            }
            
            window.youtubePlayerReady = false;
            window.debug('‡∏õ‡∏¥‡∏î YouTube Player');
        };

        window.syncPlayPause = function() {
            if (!window.youtubePlayer || !window.youtubePlayerReady) {
                alert('Player ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°');
                return;
            }
            try {
                const state = window.youtubePlayer.getPlayerState();
                if (state === YT.PlayerState.PLAYING) {
                    window.youtubePlayer.pauseVideo();
                } else {
                    window.youtubePlayer.playVideo();
                }
            } catch (e) {
                console.error('Error toggling play/pause:', e);
            }
        };

        window.syncSeek = function(seconds) {
            if (!window.youtubePlayer || !window.youtubePlayerReady) return;
            try {
                const time = window.youtubePlayer.getCurrentTime();
                window.youtubePlayer.seekTo(time + seconds, true);
            } catch (e) {
                console.error('Error seeking:', e);
            }
        };

        window.syncRestart = function() {
            if (!window.youtubePlayer || !window.youtubePlayerReady) return;
            try {
                window.youtubePlayer.seekTo(0, true);
                window.youtubePlayer.playVideo();
            } catch (e) {
                console.error('Error restarting:', e);
            }
        };

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                window.messagesContainer = document.getElementById('messagesContainer');
                window.messageInput = document.getElementById('messageInput');
                window.sendButton = document.getElementById('sendButton');

                window.currentUser = await window.checkUser();
                if (!window.currentUser) {
                    console.log('No user, redirecting to login...');
                    window.location.href = 'login.html';
                    return;
                }

                console.log('‚úÖ User logged in:', window.currentUser.email);
                
                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ session manager
                window.setupSessionManager();

                await window.checkAdminStatus();
                window.displayUserInfo();
                await window.loadRooms();
                
                const lastRoomId = localStorage.getItem(STORAGE_KEY);
                const initialRoomId = lastRoomId || PUBLIC_ROOM_ID;
                
                await window.selectRoom(initialRoomId);
                window.setupEventListeners();
                
                // ‡πÇ‡∏´‡∏•‡∏î YouTube API
                setTimeout(() => {
                    window.loadYouTubeAPI();
                }, 1000);

                console.log('‚úÖ Chat initialized');
                window.debug('‡πÅ‡∏≠‡∏û‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                
            } catch (error) {
                console.error('‚ùå Init error:', error);
                window.location.href = 'login.html';
            }
        });

        // ========== LOAD ROOMS ==========
        window.loadRooms = async function(filter = 'all') {
            try {
                let query = supabaseClient.from('rooms')
                    .select('*, owner:owner_id(username, display_name), room_members(user_id, role)')
                    .order('created_at', { ascending: false });
                
                if (filter === 'public') query = query.eq('room_type', 'public');
                else if (filter === 'private') query = query.eq('room_type', 'private');
                
                const { data: rooms, error } = await query;
                if (error) throw error;
                window.displayRooms(rooms);
            } catch (error) {
                console.error('‚ùå Error loading rooms:', error);
            }
        };

        window.displayRooms = function(rooms) {
            const roomList = document.getElementById('roomList');
            if (!roomList) return;
            if (rooms.length === 0) {
                roomList.innerHTML = '<div style="text-align: center; padding: 40px 20px; color: #a0aec0;">üì≠ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó<br><small>‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</small></div>';
                return;
            }
            roomList.innerHTML = rooms.map(room => {
                const isOwner = room.owner_id === window.currentUser?.id;
                const memberCount = room.room_members?.length || 0;
                const isActive = window.currentRoomId === room.id;
                return `<div class="room-item ${isActive ? 'active' : ''}" onclick="window.selectRoom('${room.id}')">
                    <div class="room-header">
                        <span class="room-name">${room.room_type === 'private' ? 'üîí' : 'üåç'} ${room.name}</span>
                        <span class="room-type-badge">${room.room_type === 'private' ? '‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß' : '‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞'}</span>
                    </div>
                    <div class="room-meta">
                        <span>üë§ ${room.owner?.display_name || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á'}</span>
                        <span>üë• ${memberCount} ‡∏Ñ‡∏ô</span>
                        ${isOwner ? '<span style="color: #48bb78;">üëë ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</span>' : ''}
                    </div>
                    ${room.description ? `<small style="color: #718096;">${room.description}</small>` : ''}
                </div>`;
            }).join('');
        };

        // ========== SELECT ROOM ==========
        window.selectRoom = async function(roomId) {
            try {
                const { data: room, error } = await supabaseClient.from('rooms').select('*').eq('id', roomId).single();
                if (error) throw error;
                
                window.currentRoom = room;
                window.currentRoomId = room.id;
                
                localStorage.setItem(STORAGE_KEY, room.id);
                
                document.getElementById('currentRoomTitle').innerHTML = `${room.room_type === 'private' ? 'üîí' : 'üí¨'} ${room.name}`;
                document.getElementById('currentRoomTypeBadge').textContent = room.room_type === 'private' ? '‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß' : '‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞';
                
                document.getElementById('messageInputArea').style.display = 'block';
                
                await window.loadMessages(room.id);
                await window.loadYoutubePlaylist();
                
                window.loadRooms();
            } catch (error) {
                console.error('‚ùå Error selecting room:', error);
            }
        };

        // ========== MESSAGES ==========
        window.loadMessages = async function(roomId) {
            try {
                if (!window.messagesContainer) window.messagesContainer = document.getElementById('messagesContainer');
                if (!window.messagesContainer) return;
                
                const { data: messages, error } = await supabaseClient.from('messages')
                    .select('*, profiles:user_id(username, display_name, avatar_url)')
                    .eq('room_id', roomId).order('created_at', { ascending: true }).limit(50);
                
                if (error) throw error;
                
                window.messagesContainer.innerHTML = '';
                
                if (messages.length === 0) {
                    window.messagesContainer.innerHTML = '<div style="text-align: center; padding: 50px; color: #a0aec0;">üí¨ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°<br><small>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢!</small></div>';
                } else {
                    messages.forEach(msg => window.displayMessage(msg));
                }
                
                window.scrollToBottom();
            } catch (error) {
                console.error('‚ùå Error loading messages:', error);
            }
        };

        window.displayMessage = function(message) {
            if (!window.messagesContainer) return;
            
            const isOwnMessage = message.user_id === window.currentUser?.id;
            const author = message.profiles?.display_name || message.profiles?.username || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
            const avatarUrl = message.profiles?.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(author)}&background=667eea&color=fff`;
            
            let messageText = message.message || '';
            let imageHtml = '';
            const imageMatch = messageText.match(/\[IMAGE\](.*?)\[\/IMAGE\]/);
            if (imageMatch) {
                const imageUrl = imageMatch[1];
                imageHtml = `<img src="${imageUrl}" class="message-image" onclick="window.openLightbox('${imageUrl}')">`;
                messageText = messageText.replace(/\[IMAGE\].*?\[\/IMAGE\]/, '').trim();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isOwnMessage ? 'own-message' : ''}`;
            messageDiv.dataset.messageId = message.id;
            messageDiv.dataset.userId = message.user_id;
            
            messageDiv.innerHTML = `
                <img src="${avatarUrl}" alt="${author}" class="message-avatar" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(author)}&background=667eea&color=fff'">
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">${author}</span>
                        <span class="message-time">${window.formatTime(message.created_at)}</span>
                    </div>
                    ${messageText ? `<div class="message-body">${window.linkify(messageText)}</div>` : ''}
                    ${imageHtml}
                </div>
            `;
            
            window.messagesContainer.appendChild(messageDiv);
            window.scrollToBottom();
        };

        window.sendMessage = async function() {
            const messageInput = document.getElementById('messageInput');
            if (!messageInput) return;
            const message = messageInput.value.trim();
            const hasImage = window.selectedImageFile !== null;
            if (!message && !hasImage) return;
            if (!window.currentRoomId) { 
                alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°'); 
                return; 
            }
            
            try {
                let imageUrl = null;
                if (hasImage) {
                    const fileExt = window.selectedImageFile.name.split('.').pop();
                    const fileName = `${window.currentUser.id}/${Date.now()}.${fileExt}`;
                    const { error: uploadError } = await supabaseClient.storage.from('chat_files').upload(fileName, window.selectedImageFile);
                    if (uploadError) throw uploadError;
                    const { data: { publicUrl } } = supabaseClient.storage.from('chat_files').getPublicUrl(fileName);
                    imageUrl = publicUrl;
                }
                const messageText = imageUrl ? `${message} [IMAGE]${imageUrl}[/IMAGE]` : message;
                const { error } = await supabaseClient.from('messages').insert([{
                    user_id: window.currentUser.id,
                    room_id: window.currentRoomId,
                    message: messageText,
                    created_at: new Date().toISOString()
                }]);
                if (error) throw error;
                messageInput.value = '';
                window.clearImagePreview();
                const charCount = document.getElementById('charCount');
                if (charCount) charCount.textContent = '0/500';
            } catch (error) {
                console.error('‚ùå Error sending message:', error);
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ: ' + error.message);
            }
        };

        // ========== IMAGE ==========
        window.uploadImage = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    window.selectedImageFile = file;
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById('imagePreview');
                        const img = document.getElementById('previewImg');
                        if (preview && img) { img.src = e.target.result; preview.style.display = 'inline-block'; }
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        };

        window.clearImagePreview = function() {
            window.selectedImageFile = null;
            const preview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            if (preview) preview.style.display = 'none';
            if (previewImg) previewImg.src = '';
        };

        // ========== LIGHTBOX ==========
        window.openLightbox = function(imageUrl) {
            const lightbox = document.createElement('div');
            lightbox.className = 'lightbox';
            lightbox.onclick = function() { document.body.removeChild(lightbox); };
            const img = document.createElement('img');
            img.src = imageUrl;
            const closeBtn = document.createElement('span');
            closeBtn.className = 'lightbox-close';
            closeBtn.innerHTML = '‚úï';
            closeBtn.onclick = function(e) { e.stopPropagation(); document.body.removeChild(lightbox); };
            lightbox.appendChild(img);
            lightbox.appendChild(closeBtn);
            document.body.appendChild(lightbox);
        };

        // ========== EMOJI ==========
        window.openEmojiPicker = function() {
            const modal = document.getElementById('emojiPickerModal');
            const grid = document.getElementById('emojiGrid');
            if (!modal || !grid) return;
            grid.innerHTML = emojiList.map(emoji => `<div class="emoji-item" onclick="window.insertEmoji('${emoji}')">${emoji}</div>`).join('');
            modal.classList.add('active');
        };

        window.closeEmojiPicker = function() { 
            const modal = document.getElementById('emojiPickerModal'); 
            if (modal) modal.classList.remove('active'); 
        };

        window.insertEmoji = function(emoji) { 
            const input = document.getElementById('messageInput'); 
            if (input) { 
                input.value += emoji; 
                input.focus(); 
                window.closeEmojiPicker(); 
            } 
        };

        // ========== MUSIC PLAYER ==========
        window.openMusicPlayer = function() { 
            const modal = document.getElementById('musicPlayerModal'); 
            if (modal) { 
                modal.classList.add('active'); 
                window.loadMusicPlaylist(); 
            } 
        };

        window.closeMusicPlayer = function() { 
            const modal = document.getElementById('musicPlayerModal'); 
            if (modal) modal.classList.remove('active'); 
        };

        window.addMusicToRoom = async function() {
            const urlInput = document.getElementById('musicUrlInput');
            if (!urlInput) return;
            const url = urlInput.value.trim();
            if (!url) { alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL ‡πÄ‡∏û‡∏•‡∏á'); return; }
            if (!url.toLowerCase().endsWith('.mp3')) {
                alert('‚ùå ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå .mp3 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                return;
            }
            try {
                const musicInfo = { 
                    title: url.split('/').pop() || '‡πÄ‡∏û‡∏•‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠', 
                    artist: window.currentUser.user_metadata?.username || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ' 
                };
                const { error } = await supabaseClient.from('room_music').insert([{
                    room_id: window.currentRoomId,
                    user_id: window.currentUser.id,
                    music_url: url,
                    music_title: musicInfo.title,
                    music_artist: musicInfo.artist,
                    is_playing: false
                }]);
                if (error) throw error;
                urlInput.value = '';
                alert('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏•‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                window.loadMusicPlaylist();
            } catch (error) { 
                console.error('‚ùå Error adding music:', error); 
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏•‡∏á‡πÑ‡∏î‡πâ'); 
            }
        };

        window.loadMusicPlaylist = async function() {
            if (!window.currentRoomId) return;
            try {
                const { data: playlist, error } = await supabaseClient.from('room_music')
                    .select('*, profiles:user_id(username, display_name)')
                    .eq('room_id', window.currentRoomId)
                    .order('created_at', { ascending: false });
                if (error) throw error;
                const container = document.getElementById('musicPlaylistItems');
                if (!container) return;
                if (playlist.length === 0) { 
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">üéµ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏•‡∏á‡πÉ‡∏ô‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå</div>'; 
                    return; 
                }
                container.innerHTML = playlist.map(song => `
                    <div class="playlist-item">
                        <div class="playlist-info">
                            <div class="playlist-title">${song.music_title}</div>
                            <div class="playlist-artist">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢ ${song.profiles?.display_name || song.profiles?.username}</div>
                        </div>
                        <div class="playlist-controls">
                            <button onclick="window.playMusic('${song.id}', '${song.music_url}')" class="playlist-btn">‚ñ∂Ô∏è</button>
                            ${song.user_id === window.currentUser.id || window.isAdmin ? 
                                `<button onclick="window.removeMusic('${song.id}')" class="playlist-btn">üóëÔ∏è</button>` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (error) { console.error('‚ùå Error loading playlist:', error); }
        };

        window.playMusic = async function(musicId, url) {
            try {
                if (window.audioPlayer) { 
                    window.audioPlayer.pause(); 
                    window.audioPlayer = null; 
                }
                if (!url.toLowerCase().endsWith('.mp3')) {
                    alert('‚ùå ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå .mp3 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                    return;
                }
                window.audioPlayer = new Audio(url);
                await window.audioPlayer.play();
                window.currentMusic = { id: musicId, url };
                const musicBar = document.getElementById('currentMusicBar');
                const musicTitle = document.getElementById('currentMusicTitle');
                const playPauseBtn = document.getElementById('playPauseBtn');
                if (musicBar) musicBar.style.display = 'flex';
                if (musicTitle) musicTitle.textContent = document.querySelector(`[onclick*="${musicId}"]`)?.closest('.playlist-item')?.querySelector('.playlist-title')?.textContent || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏á...';
                if (playPauseBtn) playPauseBtn.innerHTML = '‚è∏Ô∏è';
                await supabaseClient.from('room_music').update({ is_playing: true }).eq('id', musicId);
            } catch (error) { 
                console.error('‚ùå Error playing music:', error); 
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏á‡πÑ‡∏î‡πâ'); 
            }
        };

        window.togglePlayPause = function() {
            if (!window.audioPlayer) return;
            const playPauseBtn = document.getElementById('playPauseBtn');
            if (!playPauseBtn) return;
            if (window.audioPlayer.paused) { 
                window.audioPlayer.play(); 
                playPauseBtn.innerHTML = '‚è∏Ô∏è'; 
            } else { 
                window.audioPlayer.pause(); 
                playPauseBtn.innerHTML = '‚ñ∂Ô∏è'; 
            }
        };

        window.stopMusic = function() {
            if (window.audioPlayer) { 
                window.audioPlayer.pause(); 
                window.audioPlayer.currentTime = 0; 
                window.audioPlayer = null; 
            }
            window.currentMusic = null;
            const musicBar = document.getElementById('currentMusicBar');
            if (musicBar) musicBar.style.display = 'none';
        };

        window.hideMusicBar = function() { 
            const musicBar = document.getElementById('currentMusicBar'); 
            if (musicBar) musicBar.style.display = 'none'; 
            if (window.audioPlayer) window.audioPlayer.pause();
        };

        window.removeMusic = async function(musicId) {
            if (!confirm('üóëÔ∏è ‡∏•‡∏ö‡πÄ‡∏û‡∏•‡∏á‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå?')) return;
            try {
                const { error } = await supabaseClient.from('room_music').delete().eq('id', musicId);
                if (error) throw error;
                if (window.currentMusic?.id === musicId) window.stopMusic();
                alert('‚úÖ ‡∏•‡∏ö‡πÄ‡∏û‡∏•‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                window.loadMusicPlaylist();
            } catch (error) { console.error('‚ùå Error removing music:', error); alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÄ‡∏û‡∏•‡∏á‡πÑ‡∏î‡πâ'); }
        };

        // ========== ROOM MODAL CONTROLS ==========
        window.showCreateRoomModal = function() { 
            const modal = document.getElementById('createRoomModal'); 
            if (modal) modal.classList.add('active'); 
        };

        window.closeCreateRoomModal = function() {
            const modal = document.getElementById('createRoomModal');
            const form = document.getElementById('createRoomForm');
            const passwordField = document.getElementById('passwordField');
            if (modal) modal.classList.remove('active');
            if (form) form.reset();
            if (passwordField) passwordField.classList.remove('show');
        };

        window.togglePasswordField = function() {
            const roomType = document.getElementById('roomType');
            const passwordField = document.getElementById('passwordField');
            if (roomType && passwordField) passwordField.classList.toggle('show', roomType.value === 'private');
        };

        window.showJoinPrivateModal = function(room) {
            const nameEl = document.getElementById('joinRoomName');
            const modal = document.getElementById('joinPrivateRoomModal');
            if (nameEl) nameEl.textContent = `‡∏´‡πâ‡∏≠‡∏á: ${room.name}`;
            if (modal) { modal.dataset.roomId = room.id; modal.classList.add('active'); }
        };

        window.closeJoinPrivateModal = function() {
            const modal = document.getElementById('joinPrivateRoomModal');
            const passwordInput = document.getElementById('joinRoomPassword');
            if (modal) modal.classList.remove('active');
            if (passwordInput) passwordInput.value = '';
        };

        window.confirmJoinPrivateRoom = async function() {
            const modal = document.getElementById('joinPrivateRoomModal');
            const passwordInput = document.getElementById('joinRoomPassword');
            if (!modal || !passwordInput) return;
            const roomId = modal.dataset.roomId;
            const password = passwordInput.value;
            if (!password) { alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'); return; }
            try {
                const { data: room, error } = await supabaseClient.from('rooms').select('*').eq('id', roomId).single();
                if (error) throw error;
                if (room.password !== password) { alert('‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
                window.closeJoinPrivateModal();
                const { data: existingMember } = await supabaseClient.from('room_members').select('*').eq('room_id', roomId).eq('user_id', window.currentUser.id).maybeSingle();
                if (!existingMember) {
                    await supabaseClient.from('room_members').insert([{ room_id: roomId, user_id: window.currentUser.id, role: 'member', joined_at: new Date().toISOString() }]);
                }
                await window.selectRoom(roomId);
            } catch (error) { console.error('‚ùå Error joining private room:', error); alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ' + error.message); }
        };

        // ========== KICK MEMBER ==========
        window.kickMemberId = null;
        window.showKickModal = function(userId, username) {
            window.kickMemberId = userId;
            const modal = document.getElementById('kickMemberModal');
            const nameEl = document.getElementById('kickMemberName');
            if (nameEl) nameEl.textContent = `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏∞ "${username}" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á?`;
            if (modal) modal.classList.add('active');
        };

        window.closeKickModal = function() {
            window.kickMemberId = null;
            const modal = document.getElementById('kickMemberModal');
            if (modal) modal.classList.remove('active');
        };

        window.confirmKickMember = async function() {
            if (!window.kickMemberId || !window.currentRoomId) return;
            try {
                const { error } = await supabaseClient.from('room_members').delete().eq('room_id', window.currentRoomId).eq('user_id', window.kickMemberId);
                if (error) throw error;
                alert('‚úÖ ‡πÄ‡∏ï‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß');
                window.closeKickModal();
                await window.loadRoomMembers(window.currentRoomId);
            } catch (error) { console.error('‚ùå Error kicking member:', error); alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ï‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÑ‡∏î‡πâ'); }
        };

        window.loadRoomMembers = async function(roomId) {
            try {
                const { data: members, error } = await supabaseClient.from('room_members')
                    .select('user_id, role, joined_at, profiles:user_id(username, display_name, avatar_url, is_admin)')
                    .eq('room_id', roomId);
                if (error) throw error;
                window.displayRoomMembers(members);
            } catch (error) { console.error('‚ùå Error loading members:', error); }
        };

        window.displayRoomMembers = function(members) {
            const container = document.getElementById('membersList');
            if (!container) return;
            const isOwner = window.currentRoom?.owner_id === window.currentUser.id;
            container.innerHTML = members.map(member => {
                const profile = member.profiles;
                const isCurrentUser = member.user_id === window.currentUser.id;
                const canKick = (isOwner || window.isAdmin) && !isCurrentUser && member.role !== 'owner';
                return `<div class="member-item">
                    <img src="${profile?.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(profile?.display_name || profile?.username)}&background=667eea&color=fff`}" alt="${profile?.display_name}" class="member-avatar">
                    <div class="member-info">
                        <div class="member-name">${profile?.display_name || profile?.username}${isCurrentUser ? ' (‡∏Ñ‡∏∏‡∏ì)' : ''}${profile?.is_admin ? ' üëë' : ''}</div>
                        <div class="member-role">${member.role === 'owner' ? 'üëë ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á' : 'üë§ ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å'}</div>
                    </div>
                    ${canKick ? `<button class="kick-btn" onclick="window.showKickModal('${member.user_id}', '${profile?.display_name || profile?.username}')">‡πÄ‡∏ï‡∏∞‡∏≠‡∏≠‡∏Å</button>` : ''}
                </div>`;
            }).join('');
        };

        // ========== ADMIN FUNCTIONS ==========
        window.checkAdminStatus = async function() {
            try {
                if (!window.currentUser) return false;
                const { data, error } = await supabaseClient.from('profiles').select('is_admin').eq('id', window.currentUser.id).single();
                if (error) throw error;
                window.isAdmin = data?.is_admin || false;
                const adminBtn = document.getElementById('adminModeBtn');
                if (adminBtn) adminBtn.style.display = window.isAdmin ? 'inline-block' : 'none';
                return window.isAdmin;
            } catch (error) { return false; }
        };

        window.toggleAdminMode = async function() {
            if (!window.isAdmin) { alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô'); return; }
            window.isAdminMode = !window.isAdminMode;
            const adminBtn = document.getElementById('adminModeBtn');
            if (adminBtn) {
                adminBtn.innerHTML = window.isAdminMode ? 'üëë ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡πÄ‡∏õ‡∏¥‡∏î)' : 'üëë ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏õ‡∏¥‡∏î)';
                adminBtn.classList.toggle('active', window.isAdminMode);
            }
            alert(window.isAdminMode ? '‚úÖ ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‚ùå ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
        };

        window.adminDeleteRoom = async function(roomId, roomName) {
            if (!window.isAdmin) { alert('‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ'); return; }
            if (!confirm(`‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á "${roomName}" ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô\n\n‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö!\n\n‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠?`)) return;
            try {
                const { error } = await supabaseClient.from('rooms').delete().eq('id', roomId);
                if (error) throw error;
                alert('‚úÖ ‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                if (window.currentRoomId === roomId) {
                    await window.selectRoom(PUBLIC_ROOM_ID);
                } else {
                    await window.loadRooms();
                }
            } catch (error) { console.error('‚ùå Error deleting room:', error); alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ' + error.message); }
        };

        // ========== DELETE ROOM (OWNER) ==========
        window.showDeleteRoomModal = function() {
            if (!window.currentRoom) return;
            document.getElementById('deleteRoomName').innerHTML = `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á: <strong>${window.currentRoom.name}</strong>?`;
            document.getElementById('deleteRoomModal').classList.add('active');
        };

        window.closeDeleteRoomModal = function() { 
            document.getElementById('deleteRoomModal').classList.remove('active'); 
        };

        window.confirmDeleteRoom = async function() {
            if (!window.currentRoomId || window.currentRoomId === PUBLIC_ROOM_ID) { 
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞‡πÑ‡∏î‡πâ'); 
                window.closeDeleteRoomModal(); 
                return; 
            }
            try {
                const { error } = await supabaseClient.from('rooms').delete().eq('id', window.currentRoomId).eq('owner_id', window.currentUser.id);
                if (error) throw error;
                alert('‚úÖ ‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                window.closeDeleteRoomModal();
                if (localStorage.getItem(STORAGE_KEY) === window.currentRoomId) {
                    localStorage.removeItem(STORAGE_KEY);
                }
                await window.selectRoom(PUBLIC_ROOM_ID);
                await window.loadRooms();
            } catch (error) { console.error('‚ùå Error deleting room:', error); alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ' + error.message); window.closeDeleteRoomModal(); }
        };

        // ========== CREATE ROOM ==========
        window.createRoom = async function(event) {
            event.preventDefault();
            try {
                const name = document.getElementById('roomName').value;
                const description = document.getElementById('roomDescription').value;
                const roomType = document.getElementById('roomType').value;
                const password = document.getElementById('roomPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (roomType === 'private') {
                    if (!password) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß'); return; }
                    if (password !== confirmPassword) { alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô'); return; }
                    if (password.length < 4) { alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£'); return; }
                }
                
                const { data: room, error } = await supabaseClient.from('rooms').insert([{
                    name, description, room_type: roomType,
                    password: roomType === 'private' ? password : null,
                    owner_id: window.currentUser.id,
                    created_at: new Date().toISOString()
                }]).select().single();
                
                if (error) throw error;
                await supabaseClient.from('room_members').insert([{
                    room_id: room.id,
                    user_id: window.currentUser.id,
                    role: 'owner',
                    joined_at: new Date().toISOString()
                }]);
                alert('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                window.closeCreateRoomModal();
                await window.loadRooms();
                await window.selectRoom(room.id);
            } catch (error) { console.error('‚ùå Error creating room:', error); alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á: ' + error.message); }
        };

        // ========== ACTIVITIES ==========
        window.loadActivities = async function() {
            if (!window.currentRoomId) return;
            try {
                const { data: activities, error } = await supabaseClient
                    .from('activities')
                    .select(`
                        *,
                        creator:user_id (
                            username,
                            display_name,
                            avatar_url
                        ),
                        participants:activity_participants (
                            user_id,
                            joined_at,
                            profiles:user_id (
                                username,
                                display_name,
                                avatar_url
                            )
                        )
                    `)
                    .eq('room_id', window.currentRoomId)
                    .eq('status', 'active')
                    .order('created_at', { ascending: false });
                if (error) throw error;
                window.displayActivities(activities || []);
            } catch (error) { console.error('‚ùå Error loading activities:', error); }
        };

        window.displayActivities = function(activities) {
            const container = document.getElementById('activitiesList');
            if (!container) return;
            if (activities.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px 20px; color: #718096;">üéÆ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°<br><small>‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</small></div>';
                return;
            }
            
            container.innerHTML = activities.map(activity => {
                const isCreator = activity.user_id === window.currentUser.id;
                const isJoined = activity.participants?.some(p => p.user_id === window.currentUser.id);
                const participantsCount = activity.participants?.length || 1;
                let activityIcon = '‚ú®';
                if (activity.activity_type === 'youtube') activityIcon = 'üì∫';
                else if (activity.activity_type === 'game') activityIcon = 'üéÆ';
                else if (activity.activity_type === 'poll') activityIcon = 'üìä';
                
                const videoId = activity.content || '';
                
                return `<div class="activity-item" id="activity-${activity.id}" data-activity-id="${activity.id}">
                    <div class="activity-header">
                        <div class="activity-title"><span>${activityIcon}</span> ${activity.title}</div>
                        <span class="activity-type-badge">${activity.activity_type}</span>
                    </div>
                    <div class="activity-creator">
                        <img src="${activity.creator?.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(activity.creator?.display_name || activity.creator?.username)}&background=667eea&color=fff`}" alt="creator" class="activity-creator-avatar">
                        <span>${activity.creator?.display_name || activity.creator?.username}</span>
                        ${isCreator ? '<span style="color: #48bb78;">üëë</span>' : ''}
                    </div>
                    ${activity.description ? `<div class="activity-description">${activity.description}</div>` : ''}
                    <div class="activity-meta">
                        <span>üë• ${participantsCount}/${activity.max_participants || '‚àû'}</span>
                        <span>üïê ${window.formatTime(activity.created_at)}</span>
                    </div>
                    <div class="activity-actions" onclick="event.stopPropagation()">
                        ${activity.activity_type === 'youtube' && videoId ? `
                            <button type="button" 
                                    class="view-activity-btn" 
                                    data-video-id="${videoId}"
                                    data-activity-id="${activity.id}"
                                    onclick="event.stopPropagation(); window.openYoutubePlayerFromActivity('${videoId}', '${activity.id}'); return false;">
                                üì∫ ‡∏î‡∏π
                            </button>
                        ` : ''}
                        <button type="button"
                                class="join-activity-btn ${isJoined ? 'joined' : ''}"
                                data-activity-id="${activity.id}"
                                onclick="event.stopPropagation(); window.toggleJoinActivity('${activity.id}'); return false;">
                            ${isJoined ? '‚ùå ‡∏≠‡∏≠‡∏Å' : '‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°'}
                        </button>
                        ${isCreator || window.isAdmin ? `
                            <button type="button"
                                    class="btn" 
                                    style="background: #f56565; color: white; padding: 8px; border-radius: 6px;"
                                    data-activity-id="${activity.id}"
                                    onclick="event.stopPropagation(); window.endActivity('${activity.id}'); return false;">
                                ‚úï ‡∏à‡∏ö
                            </button>
                        ` : ''}
                    </div>
                </div>`;
            }).join('');
            
            // ‡∏ú‡∏π‡∏Å event listeners ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡πà‡πÉ‡∏à
            setTimeout(() => {
                document.querySelectorAll('.view-activity-btn').forEach(btn => {
                    btn.removeEventListener('click', window.handleViewActivityClick);
                    btn.addEventListener('click', window.handleViewActivityClick);
                });
                
                document.querySelectorAll('.join-activity-btn').forEach(btn => {
                    btn.removeEventListener('click', window.handleJoinActivityClick);
                    btn.addEventListener('click', window.handleJoinActivityClick);
                });
            }, 100);
        };

        window.handleViewActivityClick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            const videoId = this.dataset.videoId;
            const activityId = this.dataset.activityId;
            console.log('View activity clicked:', videoId, activityId);
            if (videoId) {
                window.openYoutubePlayerFromActivity(videoId, activityId);
            }
        };

        window.handleJoinActivityClick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            const activityId = this.dataset.activityId;
            if (activityId) {
                window.toggleJoinActivity(activityId);
            }
        };

        window.createActivity = async function(event) {
            event.preventDefault();
            try {
                const title = document.getElementById('activityTitle').value;
                const description = document.getElementById('activityDescription').value;
                const activityType = document.getElementById('activityType').value;
                const maxParticipants = parseInt(document.getElementById('maxParticipants').value) || 0;
                let content = '';
                let videoId = '';
                
                if (activityType === 'youtube') {
                    let url = document.getElementById('youtubeUrl').value;
                    if (!url) {
                        alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL YouTube');
                        return;
                    }
                    
                    if (url.includes('youtube.com/watch?v=')) {
                        videoId = url.split('v=')[1]?.split('&')[0];
                    } else if (url.includes('youtu.be/')) {
                        videoId = url.split('youtu.be/')[1];
                    } else if (url.includes('youtube.com/embed/')) {
                        videoId = url.split('/embed/')[1].split('?')[0];
                    }
                    
                    if (!videoId) {
                        alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Video ID ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL');
                        return;
                    }
                    content = videoId;
                } else if (activityType === 'game') {
                    content = document.getElementById('gameName').value;
                } else if (activityType === 'poll') {
                    content = document.getElementById('pollOptions').value;
                }
                
                const { data, error } = await supabaseClient.from('activities').insert([{
                    room_id: window.currentRoomId,
                    user_id: window.currentUser.id,
                    title,
                    description,
                    activity_type: activityType,
                    content,
                    max_participants: maxParticipants,
                    participants_count: 1,
                    status: 'active',
                    created_at: new Date().toISOString()
                }]).select().single();
                
                if (error) throw error;
                
                await supabaseClient.from('activity_participants').insert([{
                    activity_id: data.id,
                    user_id: window.currentUser.id
                }]);
                
                alert('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                window.closeCreateActivityModal();
                window.loadActivities();
            } catch (error) { 
                console.error('‚ùå Error creating activity:', error); 
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏î‡πâ: ' + error.message); 
            }
        };

        window.toggleJoinActivity = async function(activityId) {
            try {
                const { data: existing } = await supabaseClient.from('activity_participants')
                    .select('*').eq('activity_id', activityId).eq('user_id', window.currentUser.id).maybeSingle();
                
                if (existing) {
                    await supabaseClient.from('activity_participants').delete()
                        .eq('activity_id', activityId).eq('user_id', window.currentUser.id);
                } else {
                    await supabaseClient.from('activity_participants').insert([{
                        activity_id: activityId,
                        user_id: window.currentUser.id
                    }]);
                }
                
                const { data: participants } = await supabaseClient.from('activity_participants')
                    .select('*').eq('activity_id', activityId);
                await supabaseClient.from('activities').update({ 
                    participants_count: participants.length 
                }).eq('id', activityId);
                
                window.loadActivities();
            } catch (error) { 
                console.error('‚ùå Error joining activity:', error); 
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏î‡πâ'); 
            }
        };

        window.endActivity = async function(activityId) {
            if (!confirm('‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ?')) return;
            try {
                await supabaseClient
                    .from('activities')
                    .update({ status: 'ended', ended_at: new Date().toISOString() })
                    .eq('id', activityId);
                
                alert('‚úÖ ‡∏à‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡πâ‡∏ß');
                window.loadActivities();
                
                if (window.youtubeActivityId === activityId) {
                    window.closeYoutubePlayer();
                }
            } catch (error) { 
                console.error('‚ùå Error ending activity:', error); 
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏î‡πâ'); 
            }
        };

        window.toggleActivityTypeFields = function() {
            const type = document.getElementById('activityType').value;
            document.getElementById('youtubeField').style.display = type === 'youtube' ? 'block' : 'none';
            document.getElementById('gameField').style.display = type === 'game' ? 'block' : 'none';
            document.getElementById('pollField').style.display = type === 'poll' ? 'block' : 'none';
        };

        window.showCreateActivityModal = function() {
            const modal = document.getElementById('createActivityModal');
            if (modal) modal.classList.add('active');
            window.toggleActivityTypeFields();
        };

        window.closeCreateActivityModal = function() {
            const modal = document.getElementById('createActivityModal');
            const form = document.getElementById('createActivityForm');
            if (modal) modal.classList.remove('active');
            if (form) form.reset();
        };

        // ========== DELETE SELECTED MESSAGES ==========
        window.deleteSelectedMessages = async function() {
            if (window.selectedMessages.size === 0) return;
            if (!window.isAdminMode) {
                const messageIds = Array.from(window.selectedMessages);
                const { data: messages } = await supabaseClient.from('messages').select('user_id').in('id', messageIds);
                const hasOtherMessages = messages.some(msg => msg.user_id !== window.currentUser.id);
                if (hasOtherMessages) { alert('‚ùå ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô'); return; }
            }
            const confirmMsg = window.isAdminMode ? `‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏•‡∏ö ${window.selectedMessages.size} ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)` : `‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏•‡∏ö ${window.selectedMessages.size} ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á`;
            if (!confirm(confirmMsg + '\n\n‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠?')) return;
            try {
                const messageIds = Array.from(window.selectedMessages);
                const { data: userData } = await supabaseClient.from('profiles').select('username, display_name').eq('id', window.currentUser.id).single();
                const deletedByName = userData?.display_name || userData?.username || (window.isAdminMode ? '‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô' : '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
                const { error } = await supabaseClient.from('messages').update({
                    is_deleted: true,
                    deleted_by: window.currentUser.id,
                    deleted_at: new Date().toISOString(),
                    message: `[‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÇ‡∏î‡∏¢ ${deletedByName}]`
                }).in('id', messageIds);
                if (error) throw error;
                alert(`‚úÖ ‡∏•‡∏ö ${messageIds.length} ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                window.clearSelectedMessages();
                await window.loadMessages(window.currentRoomId);
            } catch (error) { console.error('‚ùå Error deleting messages:', error); alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ: ' + error.message); }
        };

        window.toggleSelectMessage = function(messageId, element) {
            if (window.selectedMessages.has(messageId)) { 
                window.selectedMessages.delete(messageId); 
                element.classList.remove('selected'); 
            } else { 
                window.selectedMessages.add(messageId); 
                element.classList.add('selected'); 
            }
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            if (deleteSelectedBtn) {
                deleteSelectedBtn.style.display = window.selectedMessages.size > 0 ? 'flex' : 'none';
                deleteSelectedBtn.innerHTML = `üóëÔ∏è ‡∏•‡∏ö ${window.selectedMessages.size} ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°`;
            }
        };

        window.clearSelectedMessages = function() {
            window.selectedMessages.clear();
            document.querySelectorAll('.message.selected').forEach(el => el.classList.remove('selected'));
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            if (deleteSelectedBtn) deleteSelectedBtn.style.display = 'none';
        };

        // ========== UI CONTROLS ==========
        window.filterRooms = function(filter, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            window.loadRooms(filter);
        };

        window.toggleMembersPanel = function() {
            const panel = document.getElementById('membersPanel');
            if (panel) panel.classList.toggle('active');
            if (panel.classList.contains('active')) {
                window.loadRoomMembers(window.currentRoomId);
            }
        };

        window.toggleActivitiesPanel = function() {
            const panel = document.getElementById('activitiesPanel');
            if (panel) {
                panel.classList.toggle('active');
                if (panel.classList.contains('active')) {
                    window.loadActivities();
                }
            }
        };

        window.toggleMobileSidebar = function() {
            const sidebar = document.querySelector('.rooms-panel');
            const overlay = document.getElementById('sidebarOverlay');
            if (!sidebar) return;
            sidebar.classList.toggle('mobile-active');
            if (overlay) {
                overlay.classList.toggle('active', sidebar.classList.contains('mobile-active'));
            }
            document.body.style.overflow = sidebar.classList.contains('mobile-active') ? 'hidden' : '';
        };

        window.closeMobileSidebar = function() {
            const sidebar = document.querySelector('.rooms-panel');
            const overlay = document.getElementById('sidebarOverlay');
            if (sidebar) sidebar.classList.remove('mobile-active');
            if (overlay) overlay.classList.remove('active');
            document.body.style.overflow = '';
        };

        window.displayUserInfo = function() {
            const userProfile = document.getElementById('userProfile');
            const username = window.currentUser.user_metadata?.display_name || window.currentUser.user_metadata?.username || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
            userProfile.innerHTML = `<img src="https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=667eea&color=fff" alt="${username}" class="avatar"><span class="username">${username} ${window.isAdmin ? 'üëë' : ''}</span>`;
        };

        // ========== EVENT LISTENERS ==========
        window.setupEventListeners = function() {
            if (window.sendButton) { 
                window.sendButton.removeEventListener('click', window.sendMessage); 
                window.sendButton.addEventListener('click', window.sendMessage); 
            }
            if (window.messageInput) {
                window.messageInput.removeEventListener('keydown', handleKeyDown);
                window.messageInput.addEventListener('keydown', handleKeyDown);
                window.messageInput.removeEventListener('input', handleInput);
                window.messageInput.addEventListener('input', handleInput);
            }
            
            const createRoomForm = document.getElementById('createRoomForm');
            if (createRoomForm) { 
                createRoomForm.removeEventListener('submit', window.createRoom); 
                createRoomForm.addEventListener('submit', window.createRoom); 
            }
            
            const createActivityForm = document.getElementById('createActivityForm');
            if (createActivityForm) {
                createActivityForm.removeEventListener('submit', window.createActivity);
                createActivityForm.addEventListener('submit', window.createActivity);
            }
            
            const searchInput = document.getElementById('youtubeSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    if (window.searchTimeout) {
                        clearTimeout(window.searchTimeout);
                    }
                    window.searchTimeout = setTimeout(() => {
                        if (this.value.trim().length >= 3) {
                            window.searchYoutube();
                        }
                    }, 500);
                });
                
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        window.searchYoutube();
                    }
                });
            }
        };

        function handleKeyDown(e) { 
            if (e.key === 'Enter' && !e.shiftKey) { 
                e.preventDefault(); 
                window.sendMessage(); 
            } 
        }

        function handleInput() {
            if (!window.messageInput) return;
            const count = window.messageInput.value.length;
            const charCount = document.getElementById('charCount');
            if (charCount) charCount.textContent = `${count}/500`;
            if (count > 500) window.messageInput.value = window.messageInput.value.slice(0, 500);
        }

        // ========== UTILITIES ==========
        window.formatTime = function(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            if (date.toDateString() === now.toDateString()) return date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
            if (diff < 86400000 * 2) return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô';
            return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
        };

        window.linkify = function(text) {
            if (!text) return '';
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
        };

        window.scrollToBottom = function() { 
            if (window.messagesContainer) window.messagesContainer.scrollTop = window.messagesContainer.scrollHeight; 
        };

        window.logout = async function() { 
            try {
                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ offline
                if (window.currentUser) {
                    await supabaseClient
                        .from('profiles')
                        .update({ 
                            is_online: false,
                            last_seen: new Date().toISOString() 
                        })
                        .eq('id', window.currentUser.id);
                }
                
                // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å subscriptions ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                if (window.messageSubscription) window.messageSubscription.unsubscribe();
                
                // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                await supabaseClient.auth.signOut();
                
                // ‡∏•‡πâ‡∏≤‡∏á localStorage
                localStorage.removeItem(STORAGE_KEY);
                
                // ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ login
                window.location.href = 'login.html'; 
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = 'login.html';
            }
        };

        // ========== CLEANUP ==========
        window.addEventListener('beforeunload', () => {
            if (window.messageSubscription) window.messageSubscription.unsubscribe();
            if (window.audioPlayer) { window.audioPlayer.pause(); window.audioPlayer = null; }
            if (window.youtubePlayer) {
                try {
                    window.youtubePlayer.destroy();
                } catch (e) {}
            }
        });

        // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
        setTimeout(() => {
            console.log('Testing YouTube functions:');
            console.log('openYoutubePlayer function exists:', typeof window.openYoutubePlayer === 'function');
            console.log('openYoutubePlayerFromActivity exists:', typeof window.openYoutubePlayerFromActivity === 'function');
        }, 2000);
    </script>
</body>
</html>
