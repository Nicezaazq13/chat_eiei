<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ChatApp - ห้องแชท</title>
    <style>
        /* ========== GLOBAL VARIABLES ========== */
        :root {
            --primary-color: #667eea;
            --primary-dark: #5a67d8;
            --secondary-color: #48bb78;
            --danger-color: #f56565;
            --danger-dark: #e53e3e;
            --text-dark: #2d3748;
            --text-light: #718096;
            --bg-light: #f7fafc;
            --bg-white: #ffffff;
            --border-color: #e2e8f0;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 20px;
            --radius-full: 9999px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-dark);
            line-height: 1.5;
        }

        /* ========== CHAT CONTAINER ========== */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: var(--bg-white);
        }

        /* ========== CHAT HEADER ========== */
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: var(--bg-white);
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .chat-header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .current-room-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .current-room-info h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-dark);
            margin: 0;
        }

        .room-badge {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: var(--radius-xl);
            background: var(--bg-light);
            color: var(--text-light);
            font-weight: 500;
        }

        .online-status {
            font-size: 14px;
            color: var(--secondary-color);
            background: #f0fff4;
            padding: 4px 12px;
            border-radius: var(--radius-xl);
            font-weight: 500;
        }

        /* ========== MOBILE MENU BUTTON ========== */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            color: var(--text-light);
            transition: color 0.2s;
            min-width: 44px;
            min-height: 44px;
        }

        .mobile-menu-btn:hover {
            color: var(--primary-color);
        }

        /* ========== ROOM ACTIONS ========== */
        .room-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }

        .delete-room-btn {
            padding: 6px 12px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .delete-room-btn:hover {
            background: var(--danger-dark);
            transform: translateY(-2px);
        }

        .admin-delete-room-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.2s;
        }

        .admin-delete-room-btn:hover {
            background: var(--danger-dark);
            transform: translateY(-2px);
        }

        /* ========== MAIN CHAT AREA ========== */
        .chat-main {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* ========== ROOMS PANEL (ซ้าย) ========== */
        .rooms-panel {
            width: 300px;
            background: var(--bg-light);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .rooms-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .create-room-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .create-room-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .room-tabs {
            display: flex;
            padding: 16px 20px;
            gap: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-btn {
            flex: 1;
            padding: 8px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            color: var(--text-light);
        }

        .tab-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .room-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .room-item {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid transparent;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
            cursor: pointer !important;
            pointer-events: auto !important;
        }

        .room-item:hover {
            border-color: var(--primary-color);
            transform: translateX(5px);
            box-shadow: var(--shadow-md);
        }

        .room-item.active {
            background: var(--primary-color);
            color: white;
        }

        .room-item * {
            pointer-events: none;
        }

        .room-item button {
            pointer-events: auto;
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .room-name {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .room-type-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: var(--radius-xl);
            background: var(--bg-light);
            color: var(--text-light);
        }

        .room-item.active .room-type-badge {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .room-meta {
            font-size: 12px;
            color: var(--text-light);
            display: flex;
            gap: 12px;
            margin-bottom: 4px;
        }

        .room-item.active .room-meta {
            color: rgba(255,255,255,0.8);
        }

        /* ========== CHAT CONTENT (กลาง) ========== */
        .chat-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-white);
        }

        .messages-container {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 70%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .own-message {
            margin-left: auto;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .message-content {
            background: var(--bg-light);
            padding: 12px 16px;
            border-radius: 18px 18px 18px 4px;
            box-shadow: var(--shadow-sm);
            max-width: 100%;
            word-break: break-word;
        }

        .own-message .message-content {
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            color: white;
            border-radius: 18px 18px 4px 18px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .message-author {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 14px;
        }

        .own-message .message-author {
            color: rgba(255,255,255,0.95);
        }

        .message-time {
            font-size: 11px;
            color: var(--text-light);
            margin-left: 8px;
        }

        .own-message .message-time {
            color: rgba(255,255,255,0.8);
        }

        .message-body {
            line-height: 1.5;
            font-size: 14px;
        }

        .message-body a {
            color: inherit;
            text-decoration: underline;
        }

        .message.deleted-message {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 12px 16px;
            margin-bottom: 12px;
            opacity: 0.7;
            max-width: 100%;
        }

        .deleted-content {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-light);
            font-style: italic;
        }

        .delete-message-btn {
            background: none;
            border: none;
            color: #a0aec0;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            opacity: 0;
            margin-left: 8px;
            font-size: 14px;
        }

        .message:hover .delete-message-btn {
            opacity: 1;
        }

        .delete-message-btn:hover {
            background: #fed7d7;
            color: var(--danger-dark);
        }

        .message-checkbox {
            display: flex;
            align-items: center;
            margin-right: 8px;
        }

        .message-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary-color);
        }

        .message.selected {
            background-color: rgba(102, 126, 234, 0.1);
            border-radius: var(--radius-lg);
            padding-left: 8px;
        }

        .message-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: var(--radius-lg);
            margin-top: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            border: 2px solid transparent;
        }

        .message-image:hover {
            transform: scale(1.02);
            border-color: var(--primary-color);
        }

        /* ========== INPUT AREA ========== */
        .message-input-area {
            padding: 16px 24px;
            background: var(--bg-white);
            border-top: 1px solid var(--border-color);
        }

        .input-toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            padding: 0 4px;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            padding: 8px 16px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-light);
        }

        .toolbar-btn:hover {
            background: var(--bg-light);
            border-color: var(--primary-color);
            transform: translateY(-2px);
            color: var(--primary-color);
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            background: var(--bg-light);
            border-radius: var(--radius-xl);
            padding: 4px 4px 4px 20px;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .input-wrapper:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-wrapper textarea {
            flex: 1;
            border: none;
            background: transparent;
            padding: 12px 0;
            max-height: 120px;
            font-size: 15px;
            line-height: 1.5;
            resize: none;
        }

        .input-wrapper textarea:focus {
            outline: none;
        }

        .btn-send {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-xl);
            padding: 10px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-send:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .input-footer {
            margin-top: 8px;
            display: flex;
            justify-content: flex-end;
            color: #a0aec0;
            font-size: 13px;
        }

        .image-preview {
            position: relative;
            margin-top: 12px;
            padding: 12px;
            background: var(--bg-light);
            border-radius: var(--radius-md);
            display: inline-block;
        }

        .image-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: var(--radius-md);
            border: 2px solid var(--border-color);
        }

        .remove-preview {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }

        .remove-preview:hover {
            background: var(--danger-dark);
            transform: scale(1.1);
        }

        /* ========== MEMBERS PANEL ========== */
        .members-panel {
            width: 280px;
            background: var(--bg-white);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .members-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .members-header h3 {
            font-size: 16px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .members-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .member-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            background: var(--bg-light);
            transition: all 0.2s;
        }

        .member-item:hover {
            background: #e2e8f0;
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 14px;
        }

        .member-role {
            font-size: 12px;
            color: var(--text-light);
        }

        .kick-btn {
            padding: 6px 12px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .kick-btn:hover {
            background: var(--danger-dark);
            transform: translateY(-2px);
        }

        /* ========== ACTIVITIES PANEL ========== */
        .activities-panel {
            width: 320px;
            background: var(--bg-white);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .activities-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .activities-header h3 {
            font-size: 16px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .create-activity-btn-container {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .activities-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .activity-item {
            background: var(--bg-light);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 16px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .activity-item:hover {
            border-color: var(--primary-color);
            transform: translateX(5px);
            box-shadow: var(--shadow-md);
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .activity-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 16px;
        }

        .activity-type-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: var(--radius-xl);
            background: var(--bg-white);
            color: var(--text-light);
            text-transform: uppercase;
        }

        .activity-creator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            color: var(--text-light);
        }

        .activity-creator-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
        }

        .activity-description {
            font-size: 14px;
            color: var(--text-dark);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .activity-meta {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            font-size: 12px;
            color: var(--text-light);
        }

        .activity-actions {
            display: flex;
            gap: 12px;
            position: relative;
            z-index: 10;
        }

        .join-activity-btn {
            flex: 1;
            padding: 8px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .join-activity-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .join-activity-btn.joined {
            background: var(--danger-color);
        }

        .join-activity-btn.joined:hover {
            background: var(--danger-dark);
        }

        .view-activity-btn {
            padding: 8px 16px;
            background: var(--bg-white);
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            border-radius: var(--radius-md);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            pointer-events: auto !important;
            position: relative;
            z-index: 100;
        }

        .view-activity-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .activity-status {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: var(--radius-xl);
            background: #48bb78;
            color: white;
        }

        .activity-status.ended {
            background: #a0aec0;
        }

        /* ========== PARTICIPANTS LIST ========== */
        .participants-list {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 16px;
        }

        .participant-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            width: 70px;
        }

        .participant-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid var(--primary-color);
            object-fit: cover;
        }

        .participant-name {
            font-size: 12px;
            color: var(--text-light);
            text-align: center;
            word-break: break-word;
        }

        /* ========== READ RECEIPTS ========== */
        .read-by-container {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-top: 8px;
            padding-top: 4px;
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        .own-message .read-by-container {
            justify-content: flex-start;
            flex-direction: row-reverse;
        }

        .read-icon {
            font-size: 12px;
            color: var(--secondary-color);
            margin-right: 6px;
            font-weight: 600;
        }

        .read-by-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 4px;
            border: 2px solid var(--bg-white);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .read-by-avatar:hover {
            transform: scale(1.2);
            z-index: 10;
        }

        .read-by-more {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--border-color);
            color: var(--text-light);
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
        }

        .read-by-more:hover {
            background: #cbd5e0;
        }

        /* ========== MUSIC PLAYER ========== */
        .music-playlist {
            margin-top: 20px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }

        .playlist-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .playlist-item:hover {
            background: var(--bg-light);
        }

        .playlist-info {
            flex: 1;
        }

        .playlist-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .playlist-artist {
            font-size: 12px;
            color: var(--text-light);
        }

        .playlist-controls {
            display: flex;
            gap: 8px;
        }

        .playlist-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
        }

        .playlist-btn:hover {
            background: var(--border-color);
            transform: scale(1.1);
        }

        /* ========== MUSIC BAR ========== */
        .music-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 2000;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
        }

        .music-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .music-icon {
            font-size: 20px;
        }

        .music-title {
            font-weight: 600;
            font-size: 14px;
        }

        .music-controls {
            display: flex;
            gap: 16px;
        }

        .music-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .music-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        /* ========== DELETE SELECTED BUTTON ========== */
        .delete-selected-btn {
            position: sticky;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--danger-color);
            color: white;
            padding: 12px 24px;
            border-radius: var(--radius-xl);
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(245, 101, 101, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            transition: all 0.3s;
            width: fit-content;
            margin: 0 auto 20px;
            border: none;
        }

        .delete-selected-btn:hover {
            background: var(--danger-dark);
            transform: translateX(-50%) scale(1.05);
        }

        /* ========== ADMIN BUTTON ========== */
        .btn-admin {
            background: #805ad5;
            color: white;
            padding: 8px 16px;
            border-radius: var(--radius-md);
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 8px;
        }

        .btn-admin.active {
            background: #6b46c1;
            box-shadow: 0 0 0 2px rgba(128, 90, 213, 0.3);
        }

        .btn-admin:hover {
            background: #6b46c1;
            transform: translateY(-2px);
        }

        /* ========== MODAL STYLES ========== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-white);
            padding: 30px;
            border-radius: var(--radius-lg);
            width: 450px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        /* ========== YOUTUBE PLAYLIST STYLES ========== */
        #youtubePlaylistModal .modal-content {
            width: 800px;
            max-width: 95%;
        }

        .youtube-playlist-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .youtube-playlist-header h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 20px;
        }

        .playlist-layout {
            display: flex;
            gap: 20px;
            min-height: 500px;
        }

        .search-section {
            flex: 1;
            border-right: 1px solid var(--border-color);
            padding-right: 20px;
        }

        .search-section h4 {
            margin-bottom: 15px;
            color: var(--text-dark);
        }

        .playlist-search {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .playlist-search input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 14px;
        }

        .playlist-search input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .playlist-search button {
            padding: 12px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            white-space: nowrap;
        }

        .playlist-search button:hover {
            background: var(--primary-dark);
        }

        .playlist-search button:disabled {
            background: var(--border-color);
            cursor: not-allowed;
        }

        .search-results {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
        }

        .search-result-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: var(--bg-light);
        }

        .search-result-thumbnail {
            width: 120px;
            height: 68px;
            border-radius: var(--radius-sm);
            object-fit: cover;
            cursor: pointer;
            background: #000;
        }

        .search-result-info {
            flex: 1;
            min-width: 0;
        }

        .search-result-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-result-channel {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .search-result-duration {
            font-size: 11px;
            color: var(--text-light);
        }

        .search-result-add {
            padding: 6px 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            height: fit-content;
        }

        .search-result-add:hover {
            background: var(--primary-dark);
        }

        .search-result-add.added {
            background: var(--secondary-color);
        }

        .search-result-add.added:hover {
            background: var(--danger-color);
        }

        .playlist-section {
            flex: 1;
            padding-left: 20px;
        }

        .playlist-section h4 {
            margin-bottom: 15px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        #youtubePlaylistModal .modal-content {
            width: 800px;
            max-width: 95%;
            padding: 20px;
        }
        
        .youtube-playlist-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .playlist-layout {
            display: flex;
            gap: 20px;
            min-height: 500px;
        }
        
        .search-section {
            flex: 1;
            border-right: 1px solid var(--border-color);
            padding-right: 20px;
        }
        
        .search-section h4 {
            margin-bottom: 15px;
            color: var(--text-dark);
        }
        
        .playlist-search {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .playlist-search input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 14px;
        }
        
        .playlist-search input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .playlist-search button {
            padding: 12px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .playlist-search button:hover {
            background: var(--primary-dark);
        }
        
        .playlist-search button:disabled {
            background: var(--border-color);
            cursor: not-allowed;
        }
        
        .search-results {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
        }
        
        .playlist-section {
            flex: 1;
            padding-left: 20px;
        }
        
        .playlist-section h4 {
            margin-bottom: 15px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .playlist-count {
            font-size: 13px;
            color: var(--text-light);
            background: var(--bg-light);
            padding: 4px 10px;
            border-radius: var(--radius-xl);
        }
        
        .playlist-items {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
        }
        
        .search-result-item:hover,
        .playlist-item:hover {
            background: var(--bg-light);
        }
        
        .search-result-add.added {
            background: var(--secondary-color);
        }
        
        .search-result-add.added:hover {
            background: var(--danger-color);
        }
        
        .playlist-item-play:hover {
            background: #38a169;
        }
        
        .playlist-item-remove:hover {
            background: var(--danger-dark);
        }
        
        @media (max-width: 768px) {
            .playlist-layout {
                flex-direction: column;
            }
            
            .search-section {
                border-right: none;
                padding-right: 0;
                border-bottom: 1px solid var(--border-color);
                padding-bottom: 20px;
            }
            
            .playlist-section {
                padding-left: 0;
                padding-top: 20px;
            }
            
            .search-result-thumbnail,
            .playlist-item-thumbnail {
                width: 80px;
                height: 45px;
            }
        }
        .playlist-count {
            font-size: 13px;
            color: var(--text-light);
            background: var(--bg-light);
            padding: 4px 10px;
            border-radius: var(--radius-xl);
        }

        .playlist-items {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
        }

        .playlist-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .playlist-item:last-child {
            border-bottom: none;
        }

        .playlist-item:hover {
            background: var(--bg-light);
        }

        .playlist-item-thumbnail {
            width: 100px;
            height: 56px;
            border-radius: var(--radius-sm);
            object-fit: cover;
            cursor: pointer;
            background: #000;
        }

        .playlist-item-info {
            flex: 1;
            min-width: 0;
        }

        .playlist-item-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-item-channel {
            font-size: 11px;
            color: var(--text-light);
            margin-bottom: 2px;
        }

        .playlist-item-added-by {
            font-size: 10px;
            color: var(--text-light);
        }

        .playlist-item-controls {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .playlist-item-play {
            padding: 4px 8px;
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 11px;
            cursor: pointer;
        }

        .playlist-item-play:hover {
            background: #38a169;
        }

        .playlist-item-remove {
            padding: 4px 8px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 11px;
            cursor: pointer;
        }

        .playlist-item-remove:hover {
            background: var(--danger-dark);
        }

        /* ========== EMOJI GRID ========== */
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            padding: 8px;
            max-height: 300px;
            overflow-y: auto;
            background: var(--bg-light);
            border-radius: var(--radius-md);
        }

        .emoji-item {
            font-size: 24px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            border-radius: var(--radius-md);
            transition: all 0.2s;
        }

        .emoji-item:hover {
            background: var(--primary-color);
            transform: scale(1.2);
            color: white;
        }

        /* ========== PASSWORD FIELD ========== */
        .password-field {
            display: none;
        }

        .password-field.show {
            display: block;
        }

        /* ========== ACTIVITY FIELDS ========== */
        .activity-field {
            margin-bottom: 16px;
        }

        /* ========== LIGHTBOX ========== */
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            cursor: pointer;
        }

        .lightbox img {
            max-width: 90%;
            max-height: 90%;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
        }

        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transition: all 0.2s;
        }

        .lightbox-close:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        /* ========== BUTTON STYLES ========== */
        .btn {
            display: inline-block;
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--border-color);
            color: var(--text-light);
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-icon {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: var(--bg-light);
        }

        /* ========== FORM STYLES ========== */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-dark);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group small {
            display: block;
            margin-top: 4px;
            color: var(--text-light);
            font-size: 12px;
        }

        /* ========== USER PROFILE ========== */
        .user-profile {
            display: flex;
            align-items: center;
            margin-right: 16px;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .username {
            font-weight: 600;
            color: var(--text-dark);
        }

        /* ========== UTILITIES ========== */
        .text-center {
            text-align: center;
        }

        .text-muted {
            color: var(--text-light);
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
        }

        .sidebar-overlay.active {
            display: block;
        }

        body.sidebar-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        /* ========== YOUTUBE PLAYER MODAL ========== */
        #youtubePlayerModal {
            z-index: 9999 !important;
        }

        #youtubePlayerModal .modal-content {
            max-width: 900px;
            width: 90%;
            padding: 20px;
            z-index: 10000;
            position: relative;
        }

        #youtubePlayerContainer {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        #youtube-player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .youtube-controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        #youtubePlayerState {
            color: var(--text-light);
            font-size: 14px;
            text-align: center;
            margin-bottom: 12px;
        }

        /* ========== DEBUG INFO ========== */
        .debug-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 10001;
            display: none;
        }

        /* ========== MOBILE RESPONSIVE ========== */
        @media (max-width: 768px) {
            .chat-main {
                flex-direction: column;
            }

            .rooms-panel {
                position: fixed !important;
                left: -100%;
                top: 0;
                width: 85% !important;
                height: 100vh !important;
                z-index: 2000;
                transition: left 0.3s ease;
                background: var(--bg-white);
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
                overflow-y: auto;
            }

            .rooms-panel.mobile-active {
                left: 0 !important;
            }

            .members-panel,
            .activities-panel {
                position: fixed !important;
                right: -100%;
                top: 0;
                width: 85% !important;
                height: 100vh !important;
                z-index: 2000;
                transition: right 0.3s ease;
                background: var(--bg-white);
                box-shadow: -2px 0 10px rgba(0,0,0,0.1);
                overflow-y: auto;
            }

            .members-panel.active,
            .activities-panel.active {
                right: 0 !important;
            }

            .mobile-menu-btn {
                display: inline-block !important;
            }

            .current-room-info h2 {
                font-size: 18px;
                max-width: 200px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .room-badge,
            .online-status {
                display: none;
            }

            .user-profile .username {
                display: none;
            }

            .avatar {
                margin-right: 0;
            }

            .message {
                max-width: 85%;
            }

            .message-avatar {
                width: 32px;
                height: 32px;
            }

            .message-input-area {
                padding: 12px 16px;
            }

            .toolbar-btn {
                padding: 6px 10px;
                font-size: 13px;
            }

            .input-wrapper textarea {
                font-size: 16px;
            }

            .input-footer {
                display: none;
            }

            .participant-item {
                width: 60px;
            }

            .participant-avatar {
                width: 40px;
                height: 40px;
            }

            .emoji-grid {
                grid-template-columns: repeat(5, 1fr);
            }

            .playlist-layout {
                flex-direction: column;
            }

            .search-section {
                border-right: none;
                padding-right: 0;
                border-bottom: 1px solid var(--border-color);
                padding-bottom: 20px;
            }

            .playlist-section {
                padding-left: 0;
                padding-top: 20px;
            }
        }

        /* ========== KEYBOARD OPEN FIX ========== */
        .keyboard-open .chat-container {
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .keyboard-open .message-input-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-white);
            z-index: 2000;
        }

        .keyboard-open .messages-container {
            padding-bottom: 120px;
        }

        /* ========== iOS SPECIFIC FIXES ========== */
        @supports (-webkit-touch-callout: none) {
            .chat-container {
                height: -webkit-fill-available;
            }

            .message-input-area {
                padding-bottom: max(12px, env(safe-area-inset-bottom, 12px));
            }

            .chat-header {
                padding-top: max(12px, env(safe-area-inset-top, 12px));
            }
        }

        /* ========== SCROLLBAR STYLING ========== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-light);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: var(--radius-full);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-light);
        }
    </style>
</head>
<body>
    <!-- Debug info -->
    <div id="debugInfo" class="debug-info"></div>

    <div class="chat-container">
        <!-- ========== HEADER ========== -->
        <div class="chat-header">
            <div class="chat-header-left">
                <button class="mobile-menu-btn" onclick="window.toggleMobileSidebar()">☰</button>
                <div class="current-room-info">
                    <h2 id="currentRoomTitle">💬 ห้องแชทสาธารณะ</h2>
                    <span class="room-badge" id="currentRoomTypeBadge">สาธารณะ</span>
                    <div id="roomActions" class="room-actions"></div>
                </div>
                <span class="online-status" id="onlineStatus">🟢 ออนไลน์</span>
            </div>
            <div class="chat-header-right">
                <div class="user-profile" id="userProfile"></div>
                <button id="adminModeBtn" onclick="window.toggleAdminMode()" class="btn btn-admin" style="display: none;">👑 แอดมิน (ปิด)</button>
                <button onclick="window.logout()" class="btn btn-outline">ออกจากระบบ</button>
            </div>
        </div>

        <!-- ========== MAIN CHAT AREA ========== -->
        <div class="chat-main">
            <!-- ROOMS PANEL (ซ้าย) -->
            <div class="rooms-panel">
                <div class="rooms-header">
                    <button class="create-room-btn" onclick="window.showCreateRoomModal()">+ สร้างห้องใหม่</button>
                </div>
                <div class="room-tabs">
                    <button class="tab-btn active" onclick="window.filterRooms('all', this)">ทั้งหมด</button>
                    <button class="tab-btn" onclick="window.filterRooms('public', this)">สาธารณะ</button>
                    <button class="tab-btn" onclick="window.filterRooms('private', this)">ส่วนตัว</button>
                </div>
                <div class="room-list" id="roomList">
                    <div style="text-align: center; padding: 40px 20px; color: #a0aec0;">⏳ กำลังโหลดห้อง...</div>
                </div>
            </div>

            <!-- MESSAGES AREA (กลาง) -->
            <div class="chat-content">
                <div class="messages-container" id="messagesContainer"></div>
                <div id="deleteSelectedBtn" class="delete-selected-btn" style="display: none;" onclick="window.deleteSelectedMessages()">🗑️ ลบ 0 ข้อความ</div>
                
                <!-- Input Area -->
                <div class="message-input-area" id="messageInputArea">
                    <div class="input-toolbar">
                        <button type="button" class="toolbar-btn" onclick="window.openEmojiPicker()" title="อิโมจิ">😊</button>
                        <button type="button" class="toolbar-btn" onclick="window.uploadImage()" title="รูปภาพ">📷</button>
                        <button type="button" class="toolbar-btn" onclick="window.openMusicPlayer()" title="เพลง">🎵</button>
                        <button type="button" class="toolbar-btn" onclick="window.toggleActivitiesPanel()" title="กิจกรรม">🎮</button>
                        <button type="button" class="toolbar-btn" onclick="window.toggleMembersPanel()" title="สมาชิก">👥</button>
                        <button type="button" class="toolbar-btn" onclick="window.openYoutubePlaylist()" title="YouTube Playlist">📺 เพลย์ลิสต์</button>
                    </div>
                    
                    <div class="input-wrapper">
                        <textarea id="messageInput" placeholder="พิมพ์ข้อความ..." rows="1"></textarea>
                        <button id="sendButton" class="btn-send">📤 ส่ง</button>
                    </div>
                    
                    <div id="imagePreview" class="image-preview" style="display: none;">
                        <img id="previewImg" src="" alt="Preview">
                        <button type="button" class="remove-preview" onclick="window.clearImagePreview()">✕</button>
                    </div>
                    
                    <div class="input-footer">
                        <span class="character-count" id="charCount">0/500</span>
                    </div>
                </div>
            </div>

            <!-- MEMBERS PANEL (ขวา) -->
            <div class="members-panel" id="membersPanel">
                <div class="members-header">
                    <h3>👥 สมาชิกในห้อง</h3>
                    <button onclick="window.toggleMembersPanel()" class="btn-icon">✕</button>
                </div>
                <div class="members-list" id="membersList"></div>
            </div>

            <!-- ACTIVITIES PANEL (กิจกรรม) -->
            <div class="activities-panel" id="activitiesPanel">
                <div class="activities-header">
                    <h3>🎮 กิจกรรมในห้อง</h3>
                    <button onclick="window.toggleActivitiesPanel()" class="btn-icon">✕</button>
                </div>
                
                <div class="create-activity-btn-container">
                    <button onclick="window.showCreateActivityModal()" class="btn btn-primary" style="width: 100%;">
                        ➕ สร้างกิจกรรม
                    </button>
                </div>
                
                <div class="activities-list" id="activitiesList">
                    <div style="text-align: center; padding: 40px 20px; color: #718096;">
                        🎮 ยังไม่มีกิจกรรม<br>
                        <small>คลิก "สร้างกิจกรรม" เพื่อเริ่มต้น</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SIDEBAR OVERLAY -->
    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <!-- ========== MODAL: อิโมจิ ========== -->
    <div id="emojiPickerModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                <span>😊</span> เลือกอิโมจิ
            </h3>
            <div class="emoji-grid" id="emojiGrid"></div>
            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button onclick="window.closeEmojiPicker()" class="btn btn-secondary" style="flex: 1;">ปิด</button>
            </div>
        </div>
    </div>

    <!-- ========== MODAL: สร้างห้อง ========== -->
    <div id="createRoomModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 24px;">📝 สร้างห้องใหม่</h2>
            <form id="createRoomForm">
                <div class="form-group">
                    <label>ชื่อห้อง <span style="color: #e53e3e;">*</span></label>
                    <input type="text" id="roomName" placeholder="เช่น ห้องเล่นเกม" required>
                </div>
                <div class="form-group">
                    <label>คำอธิบาย</label>
                    <textarea id="roomDescription" placeholder="รายละเอียดห้อง..." rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>ประเภทห้อง</label>
                    <select id="roomType" onchange="window.togglePasswordField()">
                        <option value="public">🌍 สาธารณะ - ทุกคนเข้าได้</option>
                        <option value="private">🔒 ส่วนตัว - ต้องใช้รหัสผ่าน</option>
                    </select>
                </div>
                <div id="passwordField" class="password-field">
                    <div class="form-group">
                        <label>รหัสผ่านห้อง</label>
                        <input type="password" id="roomPassword" placeholder="ตั้งรหัสผ่าน">
                    </div>
                    <div class="form-group">
                        <label>ยืนยันรหัสผ่าน</label>
                        <input type="password" id="confirmPassword" placeholder="พิมพ์รหัสผ่านอีกครั้ง">
                    </div>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">สร้างห้อง</button>
                    <button type="button" class="btn btn-secondary" onclick="window.closeCreateRoomModal()">ยกเลิก</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ========== MODAL: เข้าร่วมห้องส่วนตัว ========== -->
    <div id="joinPrivateRoomModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 24px;">🔐 เข้าร่วมห้องส่วนตัว</h2>
            <p id="joinRoomName" style="margin-bottom: 20px; font-weight: 600;"></p>
            <div class="form-group">
                <label>รหัสผ่านห้อง</label>
                <input type="password" id="joinRoomPassword" placeholder="กรอกรหัสผ่าน">
            </div>
            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button onclick="window.confirmJoinPrivateRoom()" class="btn btn-primary" style="flex: 1;">เข้าร่วม</button>
                <button onclick="window.closeJoinPrivateModal()" class="btn btn-secondary">ยกเลิก</button>
            </div>
        </div>
    </div>

    <!-- ========== MODAL: เตะสมาชิก ========== -->
    <div id="kickMemberModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 24px;">⚠️ เตะสมาชิก</h2>
            <p id="kickMemberName" style="margin-bottom: 20px;"></p>
            <p style="color: #718096; margin-bottom: 24px;">คุณแน่ใจหรือไม่ว่าต้องการเตะสมาชิกคนนี้ออกจากห้อง?</p>
            <div style="display: flex; gap: 12px;">
                <button onclick="window.confirmKickMember()" class="btn" style="flex: 1; background: #f56565; color: white;">เตะออก</button>
                <button onclick="window.closeKickModal()" class="btn btn-secondary">ยกเลิก</button>
            </div>
        </div>
    </div>

    <!-- ========== MODAL: ลบห้อง ========== -->
    <div id="deleteRoomModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 24px; color: #f56565;">⚠️ ลบห้อง</h2>
            <p id="deleteRoomName" style="margin-bottom: 20px; font-weight: 600;"></p>
            <p style="color: #718096; margin-bottom: 24px;">ข้อความและสมาชิกทั้งหมดจะถูกลบอย่างถาวร<br><strong>การดำเนินการนี้ไม่สามารถเรียกคืนได้!</strong></p>
            <div style="display: flex; gap: 12px;">
                <button onclick="window.confirmDeleteRoom()" class="btn" style="flex: 1; background: #f56565; color: white;">🗑️ ยืนยันการลบ</button>
                <button onclick="window.closeDeleteRoomModal()" class="btn btn-secondary" style="flex: 1;">ยกเลิก</button>
            </div>
        </div>
    </div>

    <!-- ========== MODAL: สร้างกิจกรรม ========== -->
    <div id="createActivityModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                <span>🎮</span> สร้างกิจกรรมใหม่
            </h3>
            
            <form id="createActivityForm">
                <div class="form-group">
                    <label>ชื่อกิจกรรม <span style="color: #e53e3e;">*</span></label>
                    <input type="text" id="activityTitle" placeholder="เช่น ดูหนังด้วยกัน, เล่นเกม" required>
                </div>
                
                <div class="form-group">
                    <label>ประเภทกิจกรรม</label>
                    <select id="activityType" onchange="window.toggleActivityTypeFields()">
                        <option value="youtube">📺 ดู YouTube ด้วยกัน</option>
                        <option value="game">🎮 เล่นเกม</option>
                        <option value="poll">📊 โหวต</option>
                        <option value="custom">✨ กิจกรรมทั่วไป</option>
                    </select>
                </div>
                
                <div id="youtubeField" class="activity-field">
                    <div class="form-group">
                        <label>URL YouTube</label>
                        <input type="text" id="youtubeUrl" placeholder="https://youtube.com/watch?v=...">
                        <small>📌 รองรับ youtube.com และ youtu.be</small>
                    </div>
                </div>
                
                <div id="gameField" class="activity-field" style="display: none;">
                    <div class="form-group">
                        <label>ชื่อเกม</label>
                        <input type="text" id="gameName" placeholder="เช่น Among Us, Valorant">
                    </div>
                </div>
                
                <div id="pollField" class="activity-field" style="display: none;">
                    <div class="form-group">
                        <label>ตัวเลือก (คั่นด้วย ,)</label>
                        <input type="text" id="pollOptions" placeholder="ตัวเลือก1, ตัวเลือก2, ตัวเลือก3">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>คำอธิบาย</label>
                    <textarea id="activityDescription" placeholder="รายละเอียดกิจกรรม..." rows="2"></textarea>
                </div>
                
                <div class="form-group">
                    <label>จำนวนผู้เข้าร่วมสูงสุด (0 = ไม่จำกัด)</label>
                    <input type="number" id="maxParticipants" value="0" min="0" max="50">
                </div>
                
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">สร้างกิจกรรม</button>
                    <button type="button" class="btn btn-secondary" onclick="window.closeCreateActivityModal()">ยกเลิก</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ========== YOUTUBE PLAYLIST MODAL ========== -->
    <div id="youtubePlaylistModal" class="modal">
        <div class="modal-content">
            <div class="youtube-playlist-header">
                <h3>📺 จัดการเพลย์ลิสต์ YouTube</h3>
                <button onclick="window.closeYoutubePlaylist()" class="btn-icon" style="font-size: 24px;">✕</button>
            </div>
            
            <div class="playlist-layout">
                <!-- ฝั่งซ้าย: ค้นหาคลิป -->
                <div class="search-section">
                    <h4>🔍 ค้นหาคลิป</h4>
                    <div class="playlist-search">
                        <input type="text" id="youtubeSearchInput" placeholder="พิมพ์ชื่อคลิปที่ต้องการค้นหา...">
                        <button id="youtubeSearchBtn" onclick="window.searchYoutube()">ค้นหา</button>
                    </div>
                    
                    <div id="searchResults" class="search-results">
                        <div style="text-align: center; padding: 40px; color: #718096;">
                            🔍 พิมพ์คำค้นหาเพื่อหาคลิป YouTube
                        </div>
                    </div>
                </div>
                
                <!-- ฝั่งขวา: เพลย์ลิสต์ -->
                <div class="playlist-section">
                    <h4>
                        📋 เพลย์ลิสต์ของห้อง
                        <span class="playlist-count" id="playlistCount">0 คลิป</span>
                    </h4>
                    
                    <div id="playlistItems" class="playlist-items">
                        <div style="text-align: center; padding: 40px; color: #718096;">
                            📋 ยังไม่มีคลิปในเพลย์ลิสต์<br>
                            <small>ค้นหาและเพิ่มคลิปจากฝั่งซ้าย</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px;">
                <button onclick="window.closeYoutubePlaylist()" class="btn btn-secondary" style="flex: 1;">ปิด</button>
            </div>
        </div>
    </div>

    <!-- ========== YOUTUBE PLAYER MODAL ========== -->
    <div id="youtubePlayerModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="display: flex; align-items: center; gap: 8px;">
                    <span>📺</span> <span id="youtubeActivityTitle">YouTube Player</span>
                </h3>
                <button onclick="window.closeYoutubePlayer()" class="btn-icon" style="font-size: 24px;">✕</button>
            </div>
            
            <div id="youtubePlayerContainer">
                <div id="youtube-player"></div>
            </div>
            
            <div class="youtube-controls">
                <button onclick="window.syncPlayPause()" id="syncPlayPauseBtn" class="btn btn-primary">⏸️ หยุด</button>
                <button onclick="window.syncSeek(-10)" class="btn btn-secondary">⏪ -10</button>
                <button onclick="window.syncSeek(10)" class="btn btn-secondary">⏩ +10</button>
                <button onclick="window.syncRestart()" class="btn btn-secondary">🔄 เริ่มใหม่</button>
            </div>
            
            <div id="youtubePlayerState" style="color: var(--text-light); font-size: 14px; text-align: center;">
                ⏸️ หยุด
            </div>
        </div>
    </div>

    <!-- ========== MUSIC PLAYER MODAL ========== -->
    <div id="musicPlayerModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                <span>🎵</span> เครื่องเล่นเพลง
            </h3>
            <div class="form-group">
                <label>URL เพลง (MP3 เท่านั้น)</label>
                <input type="text" id="musicUrlInput" placeholder="https://example.com/song.mp3">
                <small style="color: #e53e3e;">⚠️ รองรับเฉพาะไฟล์ .mp3 เท่านั้น</small>
            </div>
            <button onclick="window.addMusicToRoom()" class="btn btn-primary" style="width: 100%; margin-bottom: 20px;">
                ➕ เพิ่มเพลง
            </button>
            
            <div class="music-playlist">
                <h4 style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    📋 เพลย์ลิสต์เพลง
                </h4>
                <div id="musicPlaylistItems" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button onclick="window.closeMusicPlayer()" class="btn btn-secondary" style="flex: 1;">ปิด</button>
            </div>
        </div>
    </div>

    <!-- ========== MUSIC BAR ========== -->
    <div id="currentMusicBar" class="music-bar" style="display: none;">
        <div class="music-info">
            <span class="music-icon">🎵</span>
            <span id="currentMusicTitle" class="music-title">กำลังเล่นเพลง...</span>
        </div>
        <div class="music-controls">
            <button onclick="window.togglePlayPause()" id="playPauseBtn" class="music-btn">⏸️</button>
            <button onclick="window.stopMusic()" class="music-btn">⏹️</button>
            <button onclick="window.hideMusicBar()" class="music-btn">✕</button>
        </div>
    </div>
<!-- ========== YOUTUBE PLAYLIST MODAL ========== -->
<div id="youtubePlaylistModal" class="modal">
    <div class="modal-content" style="width: 800px; max-width: 95%;">
        <div class="youtube-playlist-header">
            <h3 style="display: flex; align-items: center; gap: 8px;">
                <span>📺</span> จัดการเพลย์ลิสต์ YouTube
            </h3>
            <button onclick="window.closeYoutubePlaylist()" class="btn-icon" style="font-size: 24px;">✕</button>
        </div>
        
        <div style="display: flex; gap: 20px; min-height: 500px;">
            <!-- ฝั่งซ้าย: ค้นหาคลิป -->
            <div style="flex: 1; border-right: 1px solid var(--border-color); padding-right: 20px;">
                <h4 style="margin-bottom: 15px;">🔍 ค้นหาคลิป</h4>
                <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                    <input type="text" id="youtubeSearchInput" placeholder="พิมพ์ชื่อคลิปที่ต้องการค้นหา..." style="flex: 1; padding: 12px; border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: 14px;">
                    <button id="youtubeSearchBtn" onclick="window.searchYoutube()" style="padding: 12px 20px; background: var(--primary-color); color: white; border: none; border-radius: var(--radius-md); cursor: pointer; font-weight: 500;">ค้นหา</button>
                </div>
                
                <div id="searchResults" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--radius-md);">
                    <div style="text-align: center; padding: 40px; color: #718096;">
                        🔍 พิมพ์คำค้นหาเพื่อหาคลิป YouTube
                    </div>
                </div>
            </div>
            
            <!-- ฝั่งขวา: เพลย์ลิสต์ -->
            <div style="flex: 1; padding-left: 20px;">
                <h4 style="margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between;">
                    📋 เพลย์ลิสต์ของห้อง
                    <span id="playlistCount" style="font-size: 13px; color: var(--text-light); background: var(--bg-light); padding: 4px 10px; border-radius: var(--radius-xl);">0 คลิป</span>
                </h4>
                
                <div id="playlistItems" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--radius-md);">
                    <div style="text-align: center; padding: 40px; color: #718096;">
                        📋 ยังไม่มีคลิปในเพลย์ลิสต์<br>
                        <small>ค้นหาและเพิ่มคลิปจากฝั่งซ้าย</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div style="display: flex; gap: 12px; margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px;">
            <button onclick="window.closeYoutubePlaylist()" class="btn btn-secondary" style="flex: 1;">ปิด</button>
        </div>
    </div>
</div>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ========== CONFIGURATION ==========
        const SUPABASE_URL = 'https://xaugtjljfkjqfpmnsxko.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_bBVN1rHJyBJN_KswV_skAQ_XYwPsvsy';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true,
                storage: localStorage
            }
        });
        
        const YOUTUBE_API_KEY = 'AIzaSyC1-oYQ-P2u7qvIVv9-Dssu64Y3JqyJ62k';
        
// ========== GLOBAL VARIABLES ==========
window.currentUser = null;
window.currentRoom = null;
window.currentRoomId = '00000000-0000-0000-0000-000000000000';
window.messageSubscription = null;
window.messagesContainer = document.getElementById('messagesContainer');
window.messageInput = document.getElementById('messageInput');
window.sendButton = document.getElementById('sendButton');
window.isAdmin = false;
window.isAdminMode = false;
window.selectedMessages = new Set();
window.selectedImageFile = null;
window.currentMusic = null;
window.audioPlayer = null;
window.kickMemberId = null;

// YouTube Variables
window.youtubePlayer = null;
window.youtubePlayerReady = false;
window.youtubeApiReady = false;
window.youtubeActivityId = null;
window.youtubeLoadAttempts = 0;

// YouTube Playlist Variables
window.youtubePlaylist = [];
window.searchTimeout = null;

const PUBLIC_ROOM_ID = '00000000-0000-0000-0000-000000000000';
const STORAGE_KEY = 'chat_last_room_id';

const emojiList = ['😀','😃','😄','😁','😆','😅','😂','🤣','😊','😇','🙂','🙃','😉','😌','😍','🥰','😘','😗','😙','😚','😋','😛','😝','😜','🤪','🤨','🧐','🤓','😎','🥳','😏','😒','😞','😔','😟','😕','🙁','☹️','😣','😖','😫','😩','🥺','😢','😭','😤','😠','😡','🤬','🤯','😳','🥵','🥶','😱','😨','😰','😥','😓','🤗','🤔','🤭','🤫','🤥','😶','😐','😑','😬','🙄','😯','😦','😧','😮','😲','🥱','😴','🤤','😪','😵','🤐','🥴','🤢','🤮','🤧','😷','🤒','🤕','🤑','🤠','😈','👿','👹','👺','🤡','💩','👻','💀','☠️','👽','👾','🤖','🎃','😺','😸','😹','😻','😼','😽','🙀','😿','😾'];

// ========== DEBUG FUNCTION ==========
window.debug = function(msg) {
    console.log('🔍 DEBUG:', msg);
    const debugEl = document.getElementById('debugInfo');
    if (debugEl) {
        debugEl.innerHTML = msg + '<br>' + debugEl.innerHTML;
        debugEl.style.display = 'block';
        setTimeout(() => {
            debugEl.style.display = 'none';
        }, 3000);
    }
};

// ========== CHECK USER ==========
window.checkUser = async function() {
    try {
        const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
        
        if (sessionError) {
            console.error('Session error:', sessionError);
            return null;
        }
        
        if (!session) {
            console.log('No session found');
            return null;
        }
        
        const expiresAt = session.expires_at;
        if (expiresAt && Date.now() / 1000 > expiresAt) {
            console.log('Session expired, refreshing...');
            const { data: refreshData, error: refreshError } = await supabaseClient.auth.refreshSession();
            if (refreshError || !refreshData.session) {
                console.error('Refresh failed:', refreshError);
                return null;
            }
            return refreshData.user;
        }
        
        return session.user;
        
    } catch (error) {
        console.error('Error checking user:', error);
        return null;
    }
};

// ========== SESSION MANAGER ==========
window.setupSessionManager = function() {
    setInterval(async () => {
        try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (!session) {
                console.log('Session expired, redirecting...');
                window.location.href = 'login.html';
                return;
            }
            
            const expiresAt = session.expires_at;
            const timeUntilExpiry = expiresAt - (Date.now() / 1000);
            
            if (timeUntilExpiry < 600) {
                console.log('Refreshing session...');
                await supabaseClient.auth.refreshSession();
            }
            
            if (window.currentUser) {
                await supabaseClient
                    .from('profiles')
                    .update({ 
                        last_seen: new Date().toISOString(),
                        is_online: true 
                    })
                    .eq('id', window.currentUser.id);
            }
        } catch (error) {
            console.error('Session check error:', error);
        }
    }, 60000);
};

// ========== YOUTUBE API ==========
window.loadYouTubeAPI = function() {
    if (window.YT && window.YT.Player) {
        window.youtubeApiReady = true;
        console.log('✅ YouTube API already loaded');
        return;
    }
    
    console.log('📦 Loading YouTube API...');
    const tag = document.createElement('script');
    tag.src = 'https://www.youtube.com/iframe_api';
    const firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
};

window.onYouTubeIframeAPIReady = function() {
    window.youtubeApiReady = true;
    console.log('✅ YouTube API Ready');
    window.debug('YouTube API พร้อมใช้งาน');
};

window.openYoutubePlayer = function(videoId) {
    console.log('🎬 Opening YouTube player with videoId:', videoId);
    window.debug('เปิด YouTube Player: ' + videoId);
    
    if (!videoId) {
        alert('❌ ไม่มี Video ID');
        return;
    }
    
    const modal = document.getElementById('youtubePlayerModal');
    const container = document.getElementById('youtube-player');
    const titleEl = document.getElementById('youtubeActivityTitle');
    
    if (!modal || !container) {
        console.error('❌ Modal or container not found');
        return;
    }
    
    if (!window.youtubeApiReady) {
        window.loadYouTubeAPI();
        
        window.youtubeLoadAttempts++;
        if (window.youtubeLoadAttempts > 3) {
            alert('❌ ไม่สามารถโหลด YouTube Player ได้ กรุณาลองใหม่');
            window.youtubeLoadAttempts = 0;
            return;
        }
        
        alert('⏳ กำลังโหลด YouTube Player กรุณารอสักครู่...');
        
        setTimeout(() => {
            if (window.youtubeApiReady) {
                window.openYoutubePlayer(videoId);
            } else {
                window.openYoutubePlayer(videoId);
            }
        }, 2000);
        return;
    }
    
    window.youtubeLoadAttempts = 0;
    
    if (window.youtubePlayer) {
        try {
            window.youtubePlayer.destroy();
        } catch (e) {}
        window.youtubePlayer = null;
    }
    
    container.innerHTML = '';
    
    const playerContainer = document.createElement('div');
    playerContainer.id = 'youtube-player-container';
    playerContainer.style.width = '100%';
    playerContainer.style.height = '100%';
    container.appendChild(playerContainer);
    
    if (titleEl) {
        titleEl.textContent = 'YouTube Player';
    }
    
    modal.classList.add('active');
    
    try {
        window.youtubePlayer = new YT.Player('youtube-player-container', {
            height: '100%',
            width: '100%',
            videoId: videoId,
            playerVars: {
                'autoplay': 1,
                'controls': 1,
                'rel': 0,
                'modestbranding': 1,
                'enablejsapi': 1,
                'playsinline': 1
            },
            events: {
                'onReady': function() {
                    window.youtubePlayerReady = true;
                    const btn = document.getElementById('syncPlayPauseBtn');
                    if (btn) btn.innerHTML = '⏸️ หยุด';
                    window.debug('YouTube Player พร้อมใช้งาน');
                },
                'onStateChange': function(event) {
                    const state = event.data;
                    const btn = document.getElementById('syncPlayPauseBtn');
                    const stateEl = document.getElementById('youtubePlayerState');
                    
                    if (btn) {
                        if (state === YT.PlayerState.PLAYING) {
                            btn.innerHTML = '⏸️ หยุด';
                            if (stateEl) stateEl.textContent = '▶️ กำลังเล่น';
                        } else if (state === YT.PlayerState.PAUSED) {
                            btn.innerHTML = '▶️ เล่น';
                            if (stateEl) stateEl.textContent = '⏸️ หยุด';
                        } else if (state === YT.PlayerState.ENDED) {
                            btn.innerHTML = '▶️ เล่นใหม่';
                            if (stateEl) stateEl.textContent = '⏹️ จบแล้ว';
                        }
                    }
                },
                'onError': function(event) {
                    console.error('❌ YouTube error:', event.data);
                    let msg = 'ไม่สามารถเล่นวิดีโอนี้ได้';
                    if (event.data === 2) msg = '❌ Video ID ไม่ถูกต้อง';
                    if (event.data === 5) msg = '❌ ไม่สามารถเล่น HTML5 player ได้';
                    if (event.data === 100) msg = '❌ วิดีโอไม่พบหรือถูกลบ';
                    if (event.data === 101 || event.data === 150) msg = '❌ ไม่ได้รับอนุญาตให้เล่น';
                    alert(msg);
                }
            }
        });
        
        console.log('✅ YouTube Player created successfully');
        
    } catch (e) {
        console.error('❌ Error creating YouTube player:', e);
        alert('ไม่สามารถสร้าง YouTube Player ได้: ' + e.message);
    }
};

window.closeYoutubePlayer = function() {
    const modal = document.getElementById('youtubePlayerModal');
    if (modal) modal.classList.remove('active');
    
    if (window.youtubePlayer) {
        try {
            window.youtubePlayer.destroy();
        } catch (e) {}
        window.youtubePlayer = null;
    }
    
    const container = document.getElementById('youtube-player');
    if (container) container.innerHTML = '';
    
    window.youtubePlayerReady = false;
};

window.syncPlayPause = function() {
    if (!window.youtubePlayer || !window.youtubePlayerReady) {
        alert('Player ยังไม่พร้อม');
        return;
    }
    try {
        const state = window.youtubePlayer.getPlayerState();
        if (state === YT.PlayerState.PLAYING) {
            window.youtubePlayer.pauseVideo();
        } else {
            window.youtubePlayer.playVideo();
        }
    } catch (e) {}
};

window.syncSeek = function(seconds) {
    if (!window.youtubePlayer || !window.youtubePlayerReady) return;
    try {
        const time = window.youtubePlayer.getCurrentTime();
        window.youtubePlayer.seekTo(time + seconds, true);
    } catch (e) {}
};

window.syncRestart = function() {
    if (!window.youtubePlayer || !window.youtubePlayerReady) return;
    try {
        window.youtubePlayer.seekTo(0, true);
        window.youtubePlayer.playVideo();
    } catch (e) {}
};

window.openYoutubePlayerFromActivity = function(videoId, activityId) {
    console.log('🎬 Opening YouTube from activity:', videoId, activityId);
    window.debug('กำลังเปิด YouTube: ' + videoId);
    
    if (!videoId) {
        alert('❌ ไม่พบ Video ID');
        return;
    }
    
    window.openYoutubePlayer(videoId);
    
    if (activityId) {
        window.youtubeActivityId = activityId;
    }
};

window.playYoutubeVideo = function(videoId) {
    window.openYoutubePlayer(videoId);
};

window.openYoutubePlaylist = function() {
    const modal = document.getElementById('youtubePlaylistModal');
    if (modal) {
        modal.classList.add('active');
        window.loadYoutubePlaylist();
        
        // รีเซ็ตการค้นหา
        const searchInput = document.getElementById('youtubeSearchInput');
        if (searchInput) searchInput.value = '';
        document.getElementById('searchResults').innerHTML = '<div style="text-align: center; padding: 40px; color: #718096;">🔍 พิมพ์คำค้นหาเพื่อหาคลิป YouTube</div>';
    }
};

window.closeYoutubePlaylist = function() {
    const modal = document.getElementById('youtubePlaylistModal');
    if (modal) modal.classList.remove('active');
};

window.formatDuration = function(duration) {
    if (!duration) return '00:00';
    const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
    const hours = (match[1] || '').replace('H', '');
    const minutes = (match[2] || '').replace('M', '');
    const seconds = (match[3] || '').replace('S', '');
    
    if (hours) {
        return `${hours.padStart(2, '0')}:${(minutes || '0').padStart(2, '0')}:${(seconds || '0').padStart(2, '0')}`;
    } else {
        return `${(minutes || '0').padStart(2, '0')}:${(seconds || '0').padStart(2, '0')}`;
    }
};

window.searchYoutube = async function() {
    const query = document.getElementById('youtubeSearchInput').value.trim();
    if (!query) {
        alert('❌ กรุณาพิมพ์คำค้นหา');
        return;
    }
    
    const searchBtn = document.getElementById('youtubeSearchBtn');
    searchBtn.disabled = true;
    searchBtn.textContent = '⏳ กำลังค้นหา...';
    
    try {
        const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=20&q=${encodeURIComponent(query)}&type=video&key=${YOUTUBE_API_KEY}`);
        const data = await response.json();
        
        if (data.error) throw new Error(data.error.message);
        
        const results = document.getElementById('searchResults');
        
        if (!data.items || data.items.length === 0) {
            results.innerHTML = '<div style="text-align: center; padding: 40px; color: #718096;">❌ ไม่พบคลิปที่ค้นหา</div>';
            return;
        }
        
        const videoIds = data.items.map(item => item.id.videoId).join(',');
        const detailsResponse = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=contentDetails&id=${videoIds}&key=${YOUTUBE_API_KEY}`);
        const detailsData = await detailsResponse.json();
        
        const durationMap = {};
        if (detailsData.items) {
            detailsData.items.forEach(item => {
                durationMap[item.id] = item.contentDetails.duration;
            });
        }
        
        results.innerHTML = data.items.map(item => {
            const videoId = item.id.videoId;
            const title = item.snippet.title;
            const channel = item.snippet.channelTitle;
            const thumbnail = item.snippet.thumbnails.medium.url;
            const duration = window.formatDuration(durationMap[videoId]);
            const isInPlaylist = window.youtubePlaylist.some(v => v.video_id === videoId);
            
            return `
                <div class="search-result-item" style="display: flex; gap: 12px; padding: 12px; border-bottom: 1px solid var(--border-color);">
                    <img src="${thumbnail}" alt="${title}" 
                         style="width: 120px; height: 68px; border-radius: var(--radius-sm); object-fit: cover; cursor: pointer; background: #000;"
                         onclick="window.playYoutubeVideo('${videoId}')">
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 600; margin-bottom: 4px; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${title}">${title}</div>
                        <div style="font-size: 12px; color: var(--text-light); margin-bottom: 4px;">${channel}</div>
                        <div style="font-size: 11px; color: var(--text-light);">⏱️ ${duration}</div>
                    </div>
                    <button class="search-result-add ${isInPlaylist ? 'added' : ''}" 
                            style="padding: 6px 12px; background: ${isInPlaylist ? 'var(--secondary-color)' : 'var(--primary-color)'}; color: white; border: none; border-radius: var(--radius-sm); font-size: 12px; cursor: pointer; height: fit-content;"
                            onclick="window.addToYoutubePlaylist('${videoId}', '${title.replace(/'/g, "\\'")}', '${channel.replace(/'/g, "\\'")}', '${thumbnail}')">
                        ${isInPlaylist ? '✓ เพิ่มแล้ว' : '➕ เพิ่ม'}
                    </button>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('❌ Error searching YouTube:', error);
        document.getElementById('searchResults').innerHTML = `<div style="text-align: center; padding: 40px; color: #f56565;">❌ เกิดข้อผิดพลาด: ${error.message}</div>`;
    } finally {
        searchBtn.disabled = false;
        searchBtn.textContent = 'ค้นหา';
    }
};

// บันทึกเพลย์ลิสต์ลงฐานข้อมูล
window.saveYoutubePlaylistToDB = async function(item) {
    try {
        const { error } = await supabaseClient
            .from('room_youtube_playlist')
            .insert([{
                room_id: item.room_id,
                user_id: item.user_id,
                video_id: item.video_id,
                title: item.title,
                channel: item.channel,
                thumbnail: item.thumbnail,
                added_by: item.added_by,
                created_at: item.added_at
            }]);
        
        if (error) throw error;
        return true;
    } catch (error) {
        console.error('❌ Error saving to DB:', error);
        return false;
    }
};

// โหลดเพลย์ลิสต์จากฐานข้อมูล
window.loadYoutubePlaylistFromDB = async function() {
    if (!window.currentRoomId) return [];
    
    try {
        const { data: playlist, error } = await supabaseClient
            .from('room_youtube_playlist')
            .select('*')
            .eq('room_id', window.currentRoomId)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        // แปลงข้อมูลให้ตรงกับ format ที่ใช้
        return (playlist || []).map(item => ({
            id: item.id,
            room_id: item.room_id,
            user_id: item.user_id,
            video_id: item.video_id,
            title: item.title,
            channel: item.channel,
            thumbnail: item.thumbnail,
            added_at: item.created_at,
            added_by: item.added_by
        }));
        
    } catch (error) {
        console.error('❌ Error loading from DB:', error);
        return [];
    }
};

window.loadYoutubePlaylist = async function() {
    if (!window.currentRoomId) return;
    
    try {
        // โหลดจาก localStorage ก่อน
        const savedPlaylist = localStorage.getItem(`youtube_playlist_${window.currentRoomId}`);
        let localPlaylist = savedPlaylist ? JSON.parse(savedPlaylist) : [];
        
        // โหลดจากฐานข้อมูล
        const dbPlaylist = await window.loadYoutubePlaylistFromDB();
        
        // รวมข้อมูลและลบรายการซ้ำ
        const allItems = [...dbPlaylist, ...localPlaylist];
        const uniqueItems = [];
        const seen = new Set();
        
        allItems.forEach(item => {
            if (!seen.has(item.video_id)) {
                seen.add(item.video_id);
                uniqueItems.push(item);
            }
        });
        
        window.youtubePlaylist = uniqueItems;
        
        // อัพเดท localStorage
        localStorage.setItem(`youtube_playlist_${window.currentRoomId}`, JSON.stringify(window.youtubePlaylist));
        
        window.displayYoutubePlaylist(window.youtubePlaylist);
        
    } catch (error) {
        console.error('❌ Error loading playlist:', error);
    }
};

window.addToYoutubePlaylist = async function(videoId, title, channel, thumbnail) {
    if (!window.currentRoomId) {
        alert('❌ กรุณาเลือกห้องก่อน');
        return;
    }
    
    if (window.youtubePlaylist.some(v => v.video_id === videoId)) {
        alert('⚠️ คลิปนี้อยู่ในเพลย์ลิสต์แล้ว');
        return;
    }
    
    const newItem = {
        id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
        room_id: window.currentRoomId,
        user_id: window.currentUser.id,
        video_id: videoId,
        title: title,
        channel: channel,
        thumbnail: thumbnail,
        added_at: new Date().toISOString(),
        added_by: window.currentUser.user_metadata?.display_name || window.currentUser.user_metadata?.username || 'ผู้ใช้'
    };
    
    // เพิ่มลงใน array
    window.youtubePlaylist.unshift(newItem);
    
    // บันทึกลง localStorage
    localStorage.setItem(`youtube_playlist_${window.currentRoomId}`, JSON.stringify(window.youtubePlaylist));
    
    // บันทึกลงฐานข้อมูล
    await window.saveYoutubePlaylistToDB(newItem);
    
    window.displayYoutubePlaylist(window.youtubePlaylist);
    
    // อัพเดทปุ่มในผลการค้นหา
    const addBtn = document.querySelector(`.search-result-add[onclick*="${videoId}"]`);
    if (addBtn) {
        addBtn.classList.add('added');
        addBtn.textContent = '✓ เพิ่มแล้ว';
        addBtn.style.background = 'var(--secondary-color)';
    }
    
    alert('✅ เพิ่มคลิปลงเพลย์ลิสต์แล้ว');
};

window.displayYoutubePlaylist = function(playlist) {
    const container = document.getElementById('playlistItems');
    const countEl = document.getElementById('playlistCount');
    
    if (!container) return;
    
    if (countEl) countEl.textContent = `${playlist.length} คลิป`;
    
    if (playlist.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #718096;">📋 ยังไม่มีคลิปในเพลย์ลิสต์<br><small>ค้นหาและเพิ่มคลิปจากฝั่งซ้าย</small></div>';
        return;
    }
    
    container.innerHTML = playlist.map(item => {
        const isOwner = item.user_id === window.currentUser?.id;
        
        return `
            <div class="playlist-item" style="display: flex; gap: 12px; padding: 12px; border-bottom: 1px solid var(--border-color);">
                <img src="${item.thumbnail || `https://img.youtube.com/vi/${item.video_id}/mqdefault.jpg`}" 
                     alt="${item.title}" 
                     style="width: 100px; height: 56px; border-radius: var(--radius-sm); object-fit: cover; cursor: pointer; background: #000;"
                     onclick="window.playYoutubeVideo('${item.video_id}')">
                <div style="flex: 1; min-width: 0;">
                    <div style="font-weight: 600; margin-bottom: 4px; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${item.title}">${item.title}</div>
                    <div style="font-size: 11px; color: var(--text-light); margin-bottom: 2px;">${item.channel}</div>
                    <div style="font-size: 10px; color: var(--text-light);">เพิ่มโดย ${item.added_by}</div>
                </div>
                <div style="display: flex; gap: 6px; align-items: center;">
                    <button onclick="window.playYoutubeVideo('${item.video_id}')" 
                            style="padding: 4px 8px; background: var(--secondary-color); color: white; border: none; border-radius: var(--radius-sm); font-size: 11px; cursor: pointer;">
                        ▶️ เล่น
                    </button>
                    ${isOwner || window.isAdmin ? 
                        `<button onclick="window.removeFromYoutubePlaylist('${item.id}')" 
                                style="padding: 4px 8px; background: var(--danger-color); color: white; border: none; border-radius: var(--radius-sm); font-size: 11px; cursor: pointer;">
                            🗑️ ลบ
                        </button>` : ''}
                </div>
            </div>
        `;
    }).join('');
};

window.removeFromYoutubePlaylist = async function(playlistId) {
    if (!confirm('🗑️ ลบคลิปนี้ออกจากเพลย์ลิสต์?')) return;
    
    const itemToRemove = window.youtubePlaylist.find(item => item.id === playlistId);
    
    // ลบจาก array
    window.youtubePlaylist = window.youtubePlaylist.filter(item => item.id !== playlistId);
    
    // อัพเดท localStorage
    localStorage.setItem(`youtube_playlist_${window.currentRoomId}`, JSON.stringify(window.youtubePlaylist));
    
    // ลบจากฐานข้อมูล
    try {
        await supabaseClient
            .from('room_youtube_playlist')
            .delete()
            .eq('video_id', itemToRemove.video_id)
            .eq('room_id', window.currentRoomId);
    } catch (error) {
        console.error('❌ Error removing from DB:', error);
    }
    
    window.displayYoutubePlaylist(window.youtubePlaylist);
    
    // อัพเดทปุ่มในผลการค้นหา
    const addBtn = document.querySelector(`.search-result-add[onclick*="${itemToRemove.video_id}"]`);
    if (addBtn) {
        addBtn.classList.remove('added');
        addBtn.textContent = '➕ เพิ่ม';
        addBtn.style.background = 'var(--primary-color)';
    }
    
    alert('✅ ลบคลิปออกจากเพลย์ลิสต์แล้ว');
};

// เล่นวิดีโอจาก playlist
window.playYoutubeVideo = function(videoId) {
    window.openYoutubePlayer(videoId);
};

// แก้ไขฟังก์ชัน selectRoom ให้โหลด playlist
const originalSelectRoom = window.selectRoom;
window.selectRoom = async function(roomId) {
    await originalSelectRoom(roomId);
    await window.loadYoutubePlaylist();
};

// เพิ่ม event listener สำหรับค้นหาอัตโนมัติ
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('youtubeSearchInput');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                if (this.value.trim().length >= 3) {
                    window.searchYoutube();
                }
            }, 500);
        });
        
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                window.searchYoutube();
            }
        });
    }
});
// ========== ACTIVITIES FUNCTIONS ==========
window.loadActivities = async function() {
    if (!window.currentRoomId) {
        console.log('No room selected');
        return;
    }
    
    try {
        console.log('Loading activities for room:', window.currentRoomId);
        
        const { data: activities, error } = await supabaseClient
            .from('activities')
            .select(`
                *,
                creator:user_id (
                    username,
                    display_name,
                    avatar_url
                ),
                participants:activity_participants (
                    user_id,
                    joined_at,
                    profiles:user_id (
                        username,
                        display_name,
                        avatar_url
                    )
                )
            `)
            .eq('room_id', window.currentRoomId)
            .eq('status', 'active')
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        console.log('Activities loaded:', activities);
        window.displayActivities(activities || []);
        
    } catch (error) { 
        console.error('❌ Error loading activities:', error); 
    }
};

window.displayActivities = function(activities) {
    const container = document.getElementById('activitiesList');
    if (!container) return;
    
    if (activities.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px 20px; color: #718096;">🎮 ยังไม่มีกิจกรรม<br><small>คลิก "สร้างกิจกรรม" เพื่อเริ่มต้น</small></div>';
        return;
    }
    
    container.innerHTML = activities.map(activity => {
        const isCreator = activity.user_id === window.currentUser?.id;
        const isJoined = activity.participants?.some(p => p.user_id === window.currentUser?.id);
        const participantsCount = activity.participants?.length || 1;
        
        let activityIcon = '✨';
        if (activity.activity_type === 'youtube') activityIcon = '📺';
        else if (activity.activity_type === 'game') activityIcon = '🎮';
        else if (activity.activity_type === 'poll') activityIcon = '📊';
        
        const videoId = activity.content || '';
        
        return `<div class="activity-item" id="activity-${activity.id}" data-activity-id="${activity.id}">
            <div class="activity-header">
                <div class="activity-title"><span>${activityIcon}</span> ${activity.title}</div>
                <span class="activity-type-badge">${activity.activity_type}</span>
            </div>
            <div class="activity-creator">
                <img src="${activity.creator?.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(activity.creator?.display_name || activity.creator?.username)}&background=667eea&color=fff`}" alt="creator" class="activity-creator-avatar">
                <span>${activity.creator?.display_name || activity.creator?.username}</span>
                ${isCreator ? '<span style="color: #48bb78;">👑</span>' : ''}
            </div>
            ${activity.description ? `<div class="activity-description">${activity.description}</div>` : ''}
            <div class="activity-meta">
                <span>👥 ${participantsCount}/${activity.max_participants || '∞'}</span>
                <span>🕐 ${window.formatTime(activity.created_at)}</span>
            </div>
            <div class="activity-actions" onclick="event.stopPropagation()">
                ${activity.activity_type === 'youtube' && videoId ? `
                    <button type="button" 
                            class="view-activity-btn" 
                            data-video-id="${videoId}"
                            data-activity-id="${activity.id}"
                            onclick="event.stopPropagation(); window.openYoutubePlayerFromActivity('${videoId}', '${activity.id}'); return false;">
                        📺 ดู
                    </button>
                ` : ''}
                <button type="button"
                        class="join-activity-btn ${isJoined ? 'joined' : ''}"
                        data-activity-id="${activity.id}"
                        onclick="event.stopPropagation(); window.toggleJoinActivity('${activity.id}'); return false;">
                    ${isJoined ? '❌ ออก' : '✅ เข้าร่วม'}
                </button>
                ${isCreator || window.isAdmin ? `
                    <button type="button"
                            class="btn" 
                            style="background: #f56565; color: white; padding: 8px; border-radius: 6px;"
                            data-activity-id="${activity.id}"
                            onclick="event.stopPropagation(); window.endActivity('${activity.id}'); return false;">
                        ✕ จบ
                    </button>
                ` : ''}
            </div>
        </div>`;
    }).join('');
};

window.createActivity = async function(event) {
    event.preventDefault();
    
    try {
        const title = document.getElementById('activityTitle').value;
        const description = document.getElementById('activityDescription').value;
        const activityType = document.getElementById('activityType').value;
        const maxParticipants = parseInt(document.getElementById('maxParticipants').value) || 0;
        
        if (!title) {
            alert('❌ กรุณากรอกชื่อกิจกรรม');
            return;
        }
        
        let content = '';
        let videoId = '';
        
        if (activityType === 'youtube') {
            let url = document.getElementById('youtubeUrl').value;
            if (!url) {
                alert('❌ กรุณาใส่ URL YouTube');
                return;
            }
            
            if (url.includes('youtube.com/watch?v=')) {
                videoId = url.split('v=')[1]?.split('&')[0];
            } else if (url.includes('youtu.be/')) {
                videoId = url.split('youtu.be/')[1];
            } else if (url.includes('youtube.com/embed/')) {
                videoId = url.split('/embed/')[1].split('?')[0];
            }
            
            if (!videoId) {
                alert('❌ ไม่พบ Video ID กรุณาตรวจสอบ URL');
                return;
            }
            content = videoId;
            
        } else if (activityType === 'game') {
            content = document.getElementById('gameName').value;
            if (!content) {
                alert('❌ กรุณากรอกชื่อเกม');
                return;
            }
            
        } else if (activityType === 'poll') {
            content = document.getElementById('pollOptions').value;
            if (!content) {
                alert('❌ กรุณากรอกตัวเลือกโหวต');
                return;
            }
        }
        
        console.log('Creating activity:', {
            room_id: window.currentRoomId,
            user_id: window.currentUser.id,
            title,
            description,
            activity_type: activityType,
            content,
            max_participants: maxParticipants
        });
        
        const { data, error } = await supabaseClient.from('activities').insert([{
            room_id: window.currentRoomId,
            user_id: window.currentUser.id,
            title: title,
            description: description,
            activity_type: activityType,
            content: content,
            max_participants: maxParticipants,
            participants_count: 1,
            status: 'active',
            created_at: new Date().toISOString()
        }]).select().single();
        
        if (error) throw error;
        
        console.log('Activity created:', data);
        
        await supabaseClient.from('activity_participants').insert([{
            activity_id: data.id,
            user_id: window.currentUser.id,
            joined_at: new Date().toISOString()
        }]);
        
        if (activityType === 'youtube' && videoId) {
            await supabaseClient.from('activity_sync').insert([{
                activity_id: data.id,
                user_id: window.currentUser.id,
                player_state: 2,
                playback_time: 0,
                video_id: videoId,
                updated_at: new Date().toISOString()
            }]);
        }
        
        alert('✅ สร้างกิจกรรมสำเร็จ!');
        window.closeCreateActivityModal();
        window.loadActivities();
        
    } catch (error) { 
        console.error('❌ Error creating activity:', error); 
        alert('ไม่สามารถสร้างกิจกรรมได้: ' + error.message); 
    }
};

window.toggleJoinActivity = async function(activityId) {
    try {
        console.log('Toggling join for activity:', activityId);
        
        const { data: existing, error: checkError } = await supabaseClient
            .from('activity_participants')
            .select('*')
            .eq('activity_id', activityId)
            .eq('user_id', window.currentUser.id)
            .maybeSingle();
        
        if (checkError) throw checkError;
        
        if (existing) {
            const { error: deleteError } = await supabaseClient
                .from('activity_participants')
                .delete()
                .eq('activity_id', activityId)
                .eq('user_id', window.currentUser.id);
            
            if (deleteError) throw deleteError;
            
            await supabaseClient
                .from('activity_sync')
                .delete()
                .eq('activity_id', activityId)
                .eq('user_id', window.currentUser.id);
                
        } else {
            const { error: insertError } = await supabaseClient
                .from('activity_participants')
                .insert([{
                    activity_id: activityId,
                    user_id: window.currentUser.id,
                    joined_at: new Date().toISOString()
                }]);
            
            if (insertError) throw insertError;
            
            const { data: activity } = await supabaseClient
                .from('activities')
                .select('activity_type, content')
                .eq('id', activityId)
                .single();
            
            if (activity?.activity_type === 'youtube' && activity.content) {
                const { data: otherSync } = await supabaseClient
                    .from('activity_sync')
                    .select('player_state, playback_time, video_id')
                    .eq('activity_id', activityId)
                    .neq('user_id', window.currentUser.id)
                    .limit(1)
                    .maybeSingle();
                
                await supabaseClient
                    .from('activity_sync')
                    .insert([{
                        activity_id: activityId,
                        user_id: window.currentUser.id,
                        player_state: otherSync?.player_state || 2,
                        playback_time: otherSync?.playback_time || 0,
                        video_id: otherSync?.video_id || activity.content,
                        updated_at: new Date().toISOString()
                    }]);
            }
        }
        
        const { data: participants } = await supabaseClient
            .from('activity_participants')
            .select('*')
            .eq('activity_id', activityId);
        
        await supabaseClient
            .from('activities')
            .update({ participants_count: participants.length })
            .eq('id', activityId);
        
        window.loadActivities();
        
    } catch (error) { 
        console.error('❌ Error joining activity:', error); 
        alert('ไม่สามารถเข้าร่วมกิจกรรมได้: ' + error.message); 
    }
};

window.endActivity = async function(activityId) {
    if (!confirm('⚠️ คุณแน่ใจหรือไม่ว่าต้องการจบกิจกรรมนี้?')) return;
    
    try {
        console.log('Ending activity:', activityId);
        
        const { error } = await supabaseClient
            .from('activities')
            .update({ 
                status: 'ended', 
                ended_at: new Date().toISOString() 
            })
            .eq('id', activityId);
        
        if (error) throw error;
        
        await supabaseClient
            .from('activity_sync')
            .delete()
            .eq('activity_id', activityId);
        
        alert('✅ จบกิจกรรมแล้ว');
        window.loadActivities();
        
        if (window.youtubeActivityId === activityId) {
            window.closeYoutubePlayer();
        }
        
    } catch (error) { 
        console.error('❌ Error ending activity:', error); 
        alert('ไม่สามารถจบกิจกรรมได้: ' + error.message); 
    }
};

window.toggleActivityTypeFields = function() {
    const type = document.getElementById('activityType').value;
    document.getElementById('youtubeField').style.display = type === 'youtube' ? 'block' : 'none';
    document.getElementById('gameField').style.display = type === 'game' ? 'block' : 'none';
    document.getElementById('pollField').style.display = type === 'poll' ? 'block' : 'none';
};

window.showCreateActivityModal = function() {
    const modal = document.getElementById('createActivityModal');
    if (modal) {
        modal.classList.add('active');
        window.toggleActivityTypeFields();
    }
};

window.closeCreateActivityModal = function() {
    const modal = document.getElementById('createActivityModal');
    const form = document.getElementById('createActivityForm');
    if (modal) {
        modal.classList.remove('active');
        if (form) form.reset();
    }
};

// ========== MUSIC PLAYER FUNCTIONS ==========
window.openMusicPlayer = function() {
    document.getElementById('musicPlayerModal')?.classList.add('active');
    window.loadMusicPlaylist();
};

window.closeMusicPlayer = function() {
    document.getElementById('musicPlayerModal')?.classList.remove('active');
};

window.loadMusicPlaylist = async function() {
    if (!window.currentRoomId) return;
    
    try {
        const { data: playlist, error } = await supabaseClient
            .from('room_music')
            .select('*, profiles:user_id(username, display_name)')
            .eq('room_id', window.currentRoomId)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        const container = document.getElementById('musicPlaylistItems');
        if (!container) return;
        
        if (playlist.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">🎵 ยังไม่มีเพลงในเพลย์ลิสต์</div>';
            return;
        }
        
        container.innerHTML = playlist.map(song => `
            <div class="playlist-item">
                <div class="playlist-info">
                    <div class="playlist-title">${song.music_title}</div>
                    <div class="playlist-artist">เพิ่มโดย ${song.profiles?.display_name || song.profiles?.username}</div>
                </div>
                <div class="playlist-controls">
                    <button onclick="window.playMusic('${song.id}', '${song.music_url}')" class="playlist-btn">▶️</button>
                    ${song.user_id === window.currentUser.id || window.isAdmin ? 
                        `<button onclick="window.removeMusic('${song.id}')" class="playlist-btn">🗑️</button>` : ''}
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('❌ Error loading music playlist:', error);
    }
};

window.addMusicToRoom = async function() {
    const urlInput = document.getElementById('musicUrlInput');
    if (!urlInput) return;
    
    const url = urlInput.value.trim();
    if (!url) {
        alert('❌ กรุณาใส่ URL เพลง');
        return;
    }
    
    if (!url.toLowerCase().endsWith('.mp3')) {
        alert('❌ รองรับเฉพาะไฟล์ .mp3 เท่านั้น');
        return;
    }
    
    try {
        const musicInfo = { 
            title: url.split('/').pop() || 'เพลงไม่มีชื่อ', 
            artist: window.currentUser.user_metadata?.username || 'ผู้ใช้' 
        };
        
        const { error } = await supabaseClient.from('room_music').insert([{
            room_id: window.currentRoomId,
            user_id: window.currentUser.id,
            music_url: url,
            music_title: musicInfo.title,
            music_artist: musicInfo.artist,
            is_playing: false
        }]);
        
        if (error) throw error;
        
        urlInput.value = '';
        alert('✅ เพิ่มเพลงสำเร็จ');
        window.loadMusicPlaylist();
        
    } catch (error) { 
        console.error('❌ Error adding music:', error); 
        alert('ไม่สามารถเพิ่มเพลงได้: ' + error.message); 
    }
};

window.playMusic = async function(musicId, url) {
    try {
        if (window.audioPlayer) { 
            window.audioPlayer.pause(); 
            window.audioPlayer = null; 
        }
        
        window.audioPlayer = new Audio(url);
        await window.audioPlayer.play();
        
        window.currentMusic = { id: musicId, url };
        
        const musicBar = document.getElementById('currentMusicBar');
        const musicTitle = document.getElementById('currentMusicTitle');
        const playPauseBtn = document.getElementById('playPauseBtn');
        
        if (musicBar) musicBar.style.display = 'flex';
        if (musicTitle) musicTitle.textContent = document.querySelector(`[onclick*="${musicId}"]`)?.closest('.playlist-item')?.querySelector('.playlist-title')?.textContent || 'กำลังเล่นเพลง...';
        if (playPauseBtn) playPauseBtn.innerHTML = '⏸️';
        
        await supabaseClient.from('room_music').update({ is_playing: true }).eq('id', musicId);
        
    } catch (error) { 
        console.error('❌ Error playing music:', error); 
        alert('ไม่สามารถเล่นเพลงได้: ' + error.message); 
    }
};

window.togglePlayPause = function() {
    if (!window.audioPlayer) return;
    
    const playPauseBtn = document.getElementById('playPauseBtn');
    if (!playPauseBtn) return;
    
    if (window.audioPlayer.paused) { 
        window.audioPlayer.play(); 
        playPauseBtn.innerHTML = '⏸️'; 
    } else { 
        window.audioPlayer.pause(); 
        playPauseBtn.innerHTML = '▶️'; 
    }
};

window.stopMusic = function() {
    if (window.audioPlayer) { 
        window.audioPlayer.pause(); 
        window.audioPlayer.currentTime = 0; 
        window.audioPlayer = null; 
    }
    window.currentMusic = null;
    document.getElementById('currentMusicBar').style.display = 'none';
};

window.hideMusicBar = function() { 
    document.getElementById('currentMusicBar').style.display = 'none'; 
    if (window.audioPlayer) window.audioPlayer.pause();
};

window.removeMusic = async function(musicId) {
    if (!confirm('🗑️ ลบเพลงนี้ออกจากเพลย์ลิสต์?')) return;
    
    try {
        const { error } = await supabaseClient.from('room_music').delete().eq('id', musicId);
        if (error) throw error;
        
        if (window.currentMusic?.id === musicId) window.stopMusic();
        
        alert('✅ ลบเพลงสำเร็จ');
        window.loadMusicPlaylist();
        
    } catch (error) { 
        console.error('❌ Error removing music:', error); 
        alert('ไม่สามารถลบเพลงได้: ' + error.message); 
    }
};

// ========== ROOM FUNCTIONS ==========
window.createRoom = async function(event) {
    event.preventDefault();
    
    try {
        const name = document.getElementById('roomName').value;
        const description = document.getElementById('roomDescription').value;
        const roomType = document.getElementById('roomType').value;
        const password = document.getElementById('roomPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (roomType === 'private') {
            if (!password) {
                alert('❌ กรุณาตั้งรหัสผ่านสำหรับห้องส่วนตัว');
                return;
            }
            if (password !== confirmPassword) {
                alert('❌ รหัสผ่านไม่ตรงกัน');
                return;
            }
            if (password.length < 4) {
                alert('❌ รหัสผ่านต้องมีอย่างน้อย 4 ตัวอักษร');
                return;
            }
        }
        
        const { data: room, error } = await supabaseClient.from('rooms').insert([{
            name,
            description,
            room_type: roomType,
            password: roomType === 'private' ? password : null,
            owner_id: window.currentUser.id,
            created_at: new Date().toISOString()
        }]).select().single();
        
        if (error) throw error;
        
        await supabaseClient.from('room_members').insert([{
            room_id: room.id,
            user_id: window.currentUser.id,
            role: 'owner',
            joined_at: new Date().toISOString()
        }]);
        
        alert('✅ สร้างห้องสำเร็จ!');
        window.closeCreateRoomModal();
        await window.loadRooms();
        await window.selectRoom(room.id);
        
    } catch (error) {
        console.error('❌ Error creating room:', error);
        alert('ไม่สามารถสร้างห้องได้: ' + error.message);
    }
};

window.confirmJoinPrivateRoom = async function() {
    const modal = document.getElementById('joinPrivateRoomModal');
    const passwordInput = document.getElementById('joinRoomPassword');
    
    if (!modal || !passwordInput) return;
    
    const roomId = modal.dataset.roomId;
    const password = passwordInput.value;
    
    if (!password) {
        alert('❌ กรุณากรอกรหัสผ่าน');
        return;
    }
    
    try {
        const { data: room, error } = await supabaseClient.from('rooms').select('*').eq('id', roomId).single();
        if (error) throw error;
        
        if (room.password !== password) {
            alert('❌ รหัสผ่านไม่ถูกต้อง');
            return;
        }
        
        window.closeJoinPrivateModal();
        
        const { data: existingMember } = await supabaseClient.from('room_members').select('*').eq('room_id', roomId).eq('user_id', window.currentUser.id).maybeSingle();
        
        if (!existingMember) {
            await supabaseClient.from('room_members').insert([{
                room_id: roomId,
                user_id: window.currentUser.id,
                role: 'member',
                joined_at: new Date().toISOString()
            }]);
        }
        
        await window.selectRoom(roomId);
        
    } catch (error) {
        console.error('❌ Error joining private room:', error);
        alert('ไม่สามารถเข้าร่วมห้องได้: ' + error.message);
    }
};

window.confirmKickMember = async function() {
    if (!window.kickMemberId || !window.currentRoomId) return;
    
    try {
        const { error } = await supabaseClient.from('room_members').delete().eq('room_id', window.currentRoomId).eq('user_id', window.kickMemberId);
        if (error) throw error;
        
        alert('✅ เตะสมาชิกออกจากห้องแล้ว');
        window.closeKickModal();
        await window.loadRoomMembers(window.currentRoomId);
        
    } catch (error) {
        console.error('❌ Error kicking member:', error);
        alert('ไม่สามารถเตะสมาชิกได้: ' + error.message);
    }
};

window.confirmDeleteRoom = async function() {
    if (!window.currentRoomId || window.currentRoomId === PUBLIC_ROOM_ID) { 
        alert('ไม่สามารถลบห้องสาธารณะได้'); 
        window.closeDeleteRoomModal(); 
        return; 
    }
    
    try {
        const { error } = await supabaseClient.from('rooms').delete().eq('id', window.currentRoomId).eq('owner_id', window.currentUser.id);
        if (error) throw error;
        
        alert('✅ ลบห้องสำเร็จ');
        window.closeDeleteRoomModal();
        
        if (localStorage.getItem(STORAGE_KEY) === window.currentRoomId) {
            localStorage.removeItem(STORAGE_KEY);
        }
        
        await window.selectRoom(PUBLIC_ROOM_ID);
        await window.loadRooms();
        
    } catch (error) {
        console.error('❌ Error deleting room:', error);
        alert('ไม่สามารถลบห้องได้: ' + error.message);
        window.closeDeleteRoomModal();
    }
};

window.toggleAdminMode = function() {
    if (!window.isAdmin) { 
        alert('คุณไม่ใช่แอดมิน'); 
        return; 
    }
    window.isAdminMode = !window.isAdminMode;
    
    const adminBtn = document.getElementById('adminModeBtn');
    if (adminBtn) {
        adminBtn.innerHTML = window.isAdminMode ? '👑 แอดมิน (เปิด)' : '👑 แอดมิน (ปิด)';
        adminBtn.classList.toggle('active', window.isAdminMode);
    }
    
    alert(window.isAdminMode ? '✅ โหมดแอดมินเปิดใช้งาน' : '❌ โหมดแอดมินปิดใช้งาน');
};

window.adminDeleteRoom = async function(roomId, roomName) {
    if (!window.isAdmin) { 
        alert('เฉพาะแอดมินเท่านั้นที่ลบห้องนี้ได้'); 
        return; 
    }
    
    if (!confirm(`⚠️ คุณกำลังจะลบห้อง "${roomName}" ในฐานะแอดมิน\n\nข้อความและสมาชิกทั้งหมดจะถูกลบ!\n\nดำเนินการต่อ?`)) return;
    
    try {
        const { error } = await supabaseClient.from('rooms').delete().eq('id', roomId);
        if (error) throw error;
        
        alert('✅ ลบห้องสำเร็จ');
        
        if (window.currentRoomId === roomId) {
            await window.selectRoom(PUBLIC_ROOM_ID);
        } else {
            await window.loadRooms();
        }
        
    } catch (error) {
        console.error('❌ Error deleting room:', error);
        alert('ไม่สามารถลบห้องได้: ' + error.message);
    }
};

window.loadRoomMembers = async function(roomId) {
    try {
        const { data: members, error } = await supabaseClient.from('room_members')
            .select('user_id, role, joined_at, profiles:user_id(username, display_name, avatar_url, is_admin)')
            .eq('room_id', roomId);
            
        if (error) throw error;
        
        window.displayRoomMembers(members);
        
    } catch (error) {
        console.error('❌ Error loading members:', error);
    }
};

window.displayRoomMembers = function(members) {
    const container = document.getElementById('membersList');
    if (!container) return;
    
    const isOwner = window.currentRoom?.owner_id === window.currentUser.id;
    
    container.innerHTML = members.map(member => {
        const profile = member.profiles;
        const isCurrentUser = member.user_id === window.currentUser.id;
        const canKick = (isOwner || window.isAdmin) && !isCurrentUser && member.role !== 'owner';
        
        return `<div class="member-item">
            <img src="${profile?.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(profile?.display_name || profile?.username)}&background=667eea&color=fff`}" alt="${profile?.display_name}" class="member-avatar">
            <div class="member-info">
                <div class="member-name">${profile?.display_name || profile?.username}${isCurrentUser ? ' (คุณ)' : ''}${profile?.is_admin ? ' 👑' : ''}</div>
                <div class="member-role">${member.role === 'owner' ? '👑 เจ้าของห้อง' : '👤 สมาชิก'}</div>
            </div>
            ${canKick ? `<button class="kick-btn" onclick="window.showKickModal('${member.user_id}', '${profile?.display_name || profile?.username}')">เตะออก</button>` : ''}
        </div>`;
    }).join('');
};

// ========== DELETE MESSAGES ==========
window.deleteSelectedMessages = async function() {
    if (window.selectedMessages.size === 0) return;
    
    if (!window.isAdminMode) {
        const messageIds = Array.from(window.selectedMessages);
        const { data: messages } = await supabaseClient.from('messages').select('user_id').in('id', messageIds);
        const hasOtherMessages = messages.some(msg => msg.user_id !== window.currentUser.id);
        
        if (hasOtherMessages) {
            alert('❌ คุณสามารถลบได้เฉพาะข้อความของตัวเองเท่านั้น');
            return;
        }
    }
    
    const confirmMsg = window.isAdminMode 
        ? `⚠️ คุณกำลังจะลบ ${window.selectedMessages.size} ข้อความ (ในฐานะแอดมิน)` 
        : `⚠️ คุณกำลังจะลบ ${window.selectedMessages.size} ข้อความของตัวเอง`;
        
    if (!confirm(confirmMsg + '\n\nดำเนินการต่อ?')) return;
    
    try {
        const messageIds = Array.from(window.selectedMessages);
        const { data: userData } = await supabaseClient.from('profiles').select('username, display_name').eq('id', window.currentUser.id).single();
        const deletedByName = userData?.display_name || userData?.username || (window.isAdminMode ? 'แอดมิน' : 'ผู้ใช้');
        
        const { error } = await supabaseClient.from('messages').update({
            is_deleted: true,
            deleted_by: window.currentUser.id,
            deleted_at: new Date().toISOString(),
            message: `[ข้อความถูกลบโดย ${deletedByName}]`
        }).in('id', messageIds);
        
        if (error) throw error;
        
        alert(`✅ ลบ ${messageIds.length} ข้อความสำเร็จ`);
        window.clearSelectedMessages();
        await window.loadMessages(window.currentRoomId);
        
    } catch (error) {
        console.error('❌ Error deleting messages:', error);
        alert('ไม่สามารถลบข้อความได้: ' + error.message);
    }
};

window.toggleSelectMessage = function(messageId, element) {
    if (window.selectedMessages.has(messageId)) { 
        window.selectedMessages.delete(messageId); 
        element.classList.remove('selected'); 
    } else { 
        window.selectedMessages.add(messageId); 
        element.classList.add('selected'); 
    }
    
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
    if (deleteSelectedBtn) {
        deleteSelectedBtn.style.display = window.selectedMessages.size > 0 ? 'flex' : 'none';
        deleteSelectedBtn.innerHTML = `🗑️ ลบ ${window.selectedMessages.size} ข้อความ`;
    }
};

window.clearSelectedMessages = function() {
    window.selectedMessages.clear();
    document.querySelectorAll('.message.selected').forEach(el => el.classList.remove('selected'));
    document.getElementById('deleteSelectedBtn').style.display = 'none';
};

// ========== KICK MODAL ==========
window.showKickModal = function(userId, username) {
    window.kickMemberId = userId;
    document.getElementById('kickMemberName').textContent = `ต้องการเตะ "${username}" ออกจากห้อง?`;
    document.getElementById('kickMemberModal').classList.add('active');
};

window.closeKickModal = function() {
    window.kickMemberId = null;
    document.getElementById('kickMemberModal').classList.remove('active');
};

// ========== JOIN PRIVATE MODAL ==========
window.showJoinPrivateModal = function(room) {
    document.getElementById('joinRoomName').textContent = `ห้อง: ${room.name}`;
    const modal = document.getElementById('joinPrivateRoomModal');
    modal.dataset.roomId = room.id;
    modal.classList.add('active');
};

window.closeJoinPrivateModal = function() {
    document.getElementById('joinPrivateRoomModal').classList.remove('active');
    document.getElementById('joinRoomPassword').value = '';
};

// ========== DELETE ROOM MODAL ==========
window.showDeleteRoomModal = function() {
    if (!window.currentRoom) return;
    document.getElementById('deleteRoomName').innerHTML = `ต้องการลบห้อง: <strong>${window.currentRoom.name}</strong>?`;
    document.getElementById('deleteRoomModal').classList.add('active');
};

window.closeDeleteRoomModal = function() { 
    document.getElementById('deleteRoomModal').classList.remove('active'); 
};

// ========== INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', async () => {
    try {
        window.messagesContainer = document.getElementById('messagesContainer');
        window.messageInput = document.getElementById('messageInput');
        window.sendButton = document.getElementById('sendButton');

        window.currentUser = await window.checkUser();
        if (!window.currentUser) {
            window.location.href = 'login.html';
            return;
        }

        console.log('✅ User logged in:', window.currentUser.email);
        
        window.setupSessionManager();
        await window.checkAdminStatus();
        window.displayUserInfo();
        await window.loadRooms();
        
        const lastRoomId = localStorage.getItem(STORAGE_KEY);
        const initialRoomId = lastRoomId || PUBLIC_ROOM_ID;
        
        await window.selectRoom(initialRoomId);
        window.setupEventListeners();
        
        setTimeout(() => {
            window.loadYouTubeAPI();
        }, 1000);

        console.log('✅ Chat initialized');
        
    } catch (error) {
        console.error('❌ Init error:', error);
        window.location.href = 'login.html';
    }
});

// ========== LOAD ROOMS ==========
window.loadRooms = async function(filter = 'all') {
    try {
        let query = supabaseClient.from('rooms')
            .select('*, owner:owner_id(username, display_name), room_members(user_id, role)')
            .order('created_at', { ascending: false });
        
        if (filter === 'public') query = query.eq('room_type', 'public');
        else if (filter === 'private') query = query.eq('room_type', 'private');
        
        const { data: rooms, error } = await query;
        if (error) throw error;
        window.displayRooms(rooms);
    } catch (error) {
        console.error('❌ Error loading rooms:', error);
    }
};

window.displayRooms = function(rooms) {
    const roomList = document.getElementById('roomList');
    if (!roomList) return;
    if (rooms.length === 0) {
        roomList.innerHTML = '<div style="text-align: center; padding: 40px 20px; color: #a0aec0;">📭 ยังไม่มีห้องแชท<br><small>คลิก "สร้างห้องใหม่" เพื่อเริ่มต้น</small></div>';
        return;
    }
    roomList.innerHTML = rooms.map(room => {
        const isOwner = room.owner_id === window.currentUser?.id;
        const memberCount = room.room_members?.length || 0;
        const isActive = window.currentRoomId === room.id;
        return `<div class="room-item ${isActive ? 'active' : ''}" onclick="window.selectRoom('${room.id}')">
            <div class="room-header">
                <span class="room-name">${room.room_type === 'private' ? '🔒' : '🌍'} ${room.name}</span>
                <span class="room-type-badge">${room.room_type === 'private' ? 'ส่วนตัว' : 'สาธารณะ'}</span>
            </div>
            <div class="room-meta">
                <span>👤 ${room.owner?.display_name || 'ไม่มีเจ้าของ'}</span>
                <span>👥 ${memberCount} คน</span>
                ${isOwner ? '<span style="color: #48bb78;">👑 เจ้าของ</span>' : ''}
            </div>
            ${room.description ? `<small style="color: #718096;">${room.description}</small>` : ''}
        </div>`;
    }).join('');
};

window.selectRoom = async function(roomId) {
    try {
        const { data: room, error } = await supabaseClient.from('rooms').select('*').eq('id', roomId).single();
        if (error) throw error;
        
        window.currentRoom = room;
        window.currentRoomId = room.id;
        
        localStorage.setItem(STORAGE_KEY, room.id);
        
        document.getElementById('currentRoomTitle').innerHTML = `${room.room_type === 'private' ? '🔒' : '💬'} ${room.name}`;
        document.getElementById('currentRoomTypeBadge').textContent = room.room_type === 'private' ? 'ส่วนตัว' : 'สาธารณะ';
        
        document.getElementById('messageInputArea').style.display = 'block';
        
        await window.loadMessages(room.id);
        await window.loadYoutubePlaylist();
        
        window.loadRooms();
    } catch (error) {
        console.error('❌ Error selecting room:', error);
    }
};

window.loadMessages = async function(roomId) {
    try {
        if (!window.messagesContainer) return;
        
        const { data: messages, error } = await supabaseClient.from('messages')
            .select('*, profiles:user_id(username, display_name, avatar_url)')
            .eq('room_id', roomId).order('created_at', { ascending: true }).limit(50);
        
        if (error) throw error;
        
        window.messagesContainer.innerHTML = '';
        
        if (messages.length === 0) {
            window.messagesContainer.innerHTML = '<div style="text-align: center; padding: 50px; color: #a0aec0;">💬 ยังไม่มีข้อความ<br><small>เริ่มต้นแชทกันเลย!</small></div>';
        } else {
            messages.forEach(msg => window.displayMessage(msg));
        }
        
        window.scrollToBottom();
    } catch (error) {
        console.error('❌ Error loading messages:', error);
    }
};

window.displayMessage = function(message) {
    if (!window.messagesContainer) return;
    
    const isOwnMessage = message.user_id === window.currentUser?.id;
    const author = message.profiles?.display_name || message.profiles?.username || 'ผู้ใช้';
    const avatarUrl = message.profiles?.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(author)}&background=667eea&color=fff`;
    
    let messageText = message.message || '';
    let imageHtml = '';
    const imageMatch = messageText.match(/\[IMAGE\](.*?)\[\/IMAGE\]/);
    if (imageMatch) {
        const imageUrl = imageMatch[1];
        imageHtml = `<img src="${imageUrl}" class="message-image" onclick="window.openLightbox('${imageUrl}')">`;
        messageText = messageText.replace(/\[IMAGE\].*?\[\/IMAGE\]/, '').trim();
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isOwnMessage ? 'own-message' : ''}`;
    messageDiv.dataset.messageId = message.id;
    
    messageDiv.innerHTML = `
        <img src="${avatarUrl}" alt="${author}" class="message-avatar" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(author)}&background=667eea&color=fff'">
        <div class="message-content">
            <div class="message-header">
                <span class="message-author">${author}</span>
                <span class="message-time">${window.formatTime(message.created_at)}</span>
            </div>
            ${messageText ? `<div class="message-body">${window.linkify(messageText)}</div>` : ''}
            ${imageHtml}
        </div>
    `;
    
    window.messagesContainer.appendChild(messageDiv);
    window.scrollToBottom();
};

window.sendMessage = async function() {
    const message = window.messageInput.value.trim();
    const hasImage = window.selectedImageFile !== null;
    if (!message && !hasImage) return;
    if (!window.currentRoomId) { 
        alert('❌ กรุณาเลือกห้องก่อนส่งข้อความ'); 
        return; 
    }
    
    try {
        let imageUrl = null;
        if (hasImage) {
            const fileExt = window.selectedImageFile.name.split('.').pop();
            const fileName = `${window.currentUser.id}/${Date.now()}.${fileExt}`;
            const { error: uploadError } = await supabaseClient.storage.from('chat_files').upload(fileName, window.selectedImageFile);
            if (uploadError) throw uploadError;
            const { data: { publicUrl } } = supabaseClient.storage.from('chat_files').getPublicUrl(fileName);
            imageUrl = publicUrl;
        }
        const messageText = imageUrl ? `${message} [IMAGE]${imageUrl}[/IMAGE]` : message;
        const { error } = await supabaseClient.from('messages').insert([{
            user_id: window.currentUser.id,
            room_id: window.currentRoomId,
            message: messageText,
            created_at: new Date().toISOString()
        }]);
        if (error) throw error;
        window.messageInput.value = '';
        window.clearImagePreview();
    } catch (error) {
        console.error('❌ Error sending message:', error);
        alert('ไม่สามารถส่งข้อความได้: ' + error.message);
    }
};

// ========== UTILITIES ==========
window.formatTime = function(timestamp) {
    if (!timestamp) return '';
    const date = new Date(timestamp);
    const now = new Date();
    if (date.toDateString() === now.toDateString()) return date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
    return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
};

window.linkify = function(text) {
    if (!text) return '';
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    return text.replace(urlRegex, url => `<a href="${url}" target="_blank">${url}</a>`);
};

window.scrollToBottom = function() { 
    if (window.messagesContainer) window.messagesContainer.scrollTop = window.messagesContainer.scrollHeight; 
};

window.logout = async function() { 
    try {
        if (window.currentUser) {
            await supabaseClient
                .from('profiles')
                .update({ 
                    is_online: false,
                    last_seen: new Date().toISOString() 
                })
                .eq('id', window.currentUser.id);
        }
        
        if (window.messageSubscription) window.messageSubscription.unsubscribe();
        await supabaseClient.auth.signOut();
        localStorage.removeItem(STORAGE_KEY);
        window.location.href = 'login.html'; 
    } catch (error) {
        console.error('Logout error:', error);
        window.location.href = 'login.html';
    }
};

window.checkAdminStatus = async function() {
    try {
        if (!window.currentUser) return false;
        const { data, error } = await supabaseClient.from('profiles').select('is_admin').eq('id', window.currentUser.id).single();
        if (error) throw error;
        window.isAdmin = data?.is_admin || false;
        const adminBtn = document.getElementById('adminModeBtn');
        if (adminBtn) adminBtn.style.display = window.isAdmin ? 'inline-block' : 'none';
        return window.isAdmin;
    } catch (error) { return false; }
};

window.displayUserInfo = function() {
    const userProfile = document.getElementById('userProfile');
    const username = window.currentUser.user_metadata?.display_name || window.currentUser.user_metadata?.username || 'ผู้ใช้';
    userProfile.innerHTML = `<img src="https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=667eea&color=fff" alt="${username}" class="avatar"><span class="username">${username} ${window.isAdmin ? '👑' : ''}</span>`;
};

// ========== EVENT LISTENERS ==========
window.setupEventListeners = function() {
    if (window.sendButton) { 
        window.sendButton.addEventListener('click', window.sendMessage); 
    }
    if (window.messageInput) {
        window.messageInput.addEventListener('keydown', function(e) { 
            if (e.key === 'Enter' && !e.shiftKey) { 
                e.preventDefault(); 
                window.sendMessage(); 
            } 
        });
        window.messageInput.addEventListener('input', function() {
            const count = this.value.length;
            const charCount = document.getElementById('charCount');
            if (charCount) charCount.textContent = `${count}/500`;
            if (count > 500) this.value = this.value.slice(0, 500);
        });
    }
    
    const createRoomForm = document.getElementById('createRoomForm');
    if (createRoomForm) { 
        createRoomForm.addEventListener('submit', window.createRoom); 
    }
    
    const createActivityForm = document.getElementById('createActivityForm');
    if (createActivityForm) {
        createActivityForm.addEventListener('submit', window.createActivity);
    }
    
    const searchInput = document.getElementById('youtubeSearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            if (window.searchTimeout) clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(() => {
                if (this.value.trim().length >= 3) window.searchYoutube();
            }, 500);
        });
    }
};

// ฟังก์ชันพื้นฐานอื่นๆ
window.toggleMobileSidebar = function() {
    const sidebar = document.querySelector('.rooms-panel');
    const overlay = document.getElementById('sidebarOverlay');
    if (!sidebar) return;
    sidebar.classList.toggle('mobile-active');
    if (overlay) overlay.classList.toggle('active', sidebar.classList.contains('mobile-active'));
};

window.filterRooms = function(filter, btn) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    window.loadRooms(filter);
};

window.toggleMembersPanel = function() {
    document.getElementById('membersPanel')?.classList.toggle('active');
    if (document.getElementById('membersPanel').classList.contains('active')) {
        window.loadRoomMembers(window.currentRoomId);
    }
};

window.toggleActivitiesPanel = function() {
    const panel = document.getElementById('activitiesPanel');
    if (panel) {
        panel.classList.toggle('active');
        if (panel.classList.contains('active')) window.loadActivities();
    }
};

window.openEmojiPicker = function() {
    const modal = document.getElementById('emojiPickerModal');
    const grid = document.getElementById('emojiGrid');
    if (!modal || !grid) return;
    grid.innerHTML = emojiList.map(emoji => `<div class="emoji-item" onclick="window.insertEmoji('${emoji}')">${emoji}</div>`).join('');
    modal.classList.add('active');
};

window.closeEmojiPicker = function() { 
    document.getElementById('emojiPickerModal')?.classList.remove('active'); 
};

window.insertEmoji = function(emoji) { 
    if (window.messageInput) { 
        window.messageInput.value += emoji; 
        window.messageInput.focus(); 
        window.closeEmojiPicker(); 
    } 
};

window.uploadImage = function() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            window.selectedImageFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagePreview');
                const img = document.getElementById('previewImg');
                if (preview && img) { img.src = e.target.result; preview.style.display = 'inline-block'; }
            };
            reader.readAsDataURL(file);
        }
    };
    input.click();
};

window.clearImagePreview = function() {
    window.selectedImageFile = null;
    const preview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    if (preview) preview.style.display = 'none';
    if (previewImg) previewImg.src = '';
};

window.openLightbox = function(imageUrl) {
    const lightbox = document.createElement('div');
    lightbox.className = 'lightbox';
    lightbox.onclick = function() { document.body.removeChild(lightbox); };
    const img = document.createElement('img');
    img.src = imageUrl;
    const closeBtn = document.createElement('span');
    closeBtn.className = 'lightbox-close';
    closeBtn.innerHTML = '✕';
    closeBtn.onclick = function(e) { e.stopPropagation(); document.body.removeChild(lightbox); };
    lightbox.appendChild(img);
    lightbox.appendChild(closeBtn);
    document.body.appendChild(lightbox);
};

window.showCreateRoomModal = function() { 
    document.getElementById('createRoomModal')?.classList.add('active'); 
};

window.closeCreateRoomModal = function() {
    const modal = document.getElementById('createRoomModal');
    const form = document.getElementById('createRoomForm');
    const passwordField = document.getElementById('passwordField');
    if (modal) modal.classList.remove('active');
    if (form) form.reset();
    if (passwordField) passwordField.classList.remove('show');
};

window.togglePasswordField = function() {
    const roomType = document.getElementById('roomType');
    const passwordField = document.getElementById('passwordField');
    if (roomType && passwordField) passwordField.classList.toggle('show', roomType.value === 'private');
};
    </script>
</body>
</html>



