<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ChatApp - ‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ========== ROOM STYLES ========== */
        .rooms-panel {
            width: 300px;
            background: #f7fafc;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .rooms-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .create-room-btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .create-room-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        
        .room-tabs {
            display: flex;
            padding: 16px 20px;
            gap: 8px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .tab-btn {
            flex: 1;
            padding: 8px;
            background: transparent;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .room-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .room-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        
        .room-item:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }
        
        .room-item.active {
            background: #667eea;
            color: white;
        }
        
        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .room-name {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .room-type-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .room-item.active .room-type-badge {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .room-meta {
            font-size: 12px;
            color: #718096;
            display: flex;
            gap: 12px;
        }
        
        .room-item.active .room-meta {
            color: rgba(255,255,255,0.8);
        }
        
        /* ========== ROOM ACTIONS ========== */
        .room-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }
        
        .delete-room-btn {
            padding: 6px 12px;
            background: #f56565;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .delete-room-btn:hover {
            background: #e53e3e;
        }
        
        /* ========== MEMBERS PANEL ========== */
        .members-panel {
            width: 280px;
            background: white;
            border-left: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .members-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .members-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .member-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #f7fafc;
        }
        
        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }
        
        .member-info {
            flex: 1;
        }
        
        .member-name {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .member-role {
            font-size: 12px;
            color: #718096;
        }
        
        .kick-btn {
            padding: 6px 12px;
            background: #f56565;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .kick-btn:hover {
            background: #e53e3e;
        }
        
        /* ========== MODAL STYLES ========== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            width: 450px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .password-field {
            display: none;
        }
        
        .password-field.show {
            display: block;
        }
        
        /* ========== MOBILE RESPONSIVE ========== */
        @media (max-width: 768px) {
            .chat-main {
                flex-direction: column;
            }
            
            .rooms-panel {
                width: 100%;
                max-height: 300px;
            }
            
            .members-panel {
                position: fixed;
                right: -100%;
                top: 0;
                width: 85%;
                height: 100vh;
                z-index: 1500;
                transition: right 0.3s;
            }
            
            .members-panel.active {
                right: 0;
            }
            
            .chat-sidebar {
                display: none;
            }
        }
        
        .chat-main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .chat-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .current-room-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .room-badge {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 20px;
            background: #e2e8f0;
            color: #4a5568;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Header -->
        <div class="chat-header">
            <div class="chat-header-left">
                <div class="current-room-info">
                    <h2 id="currentRoomTitle">üí¨ ‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞</h2>
                    <span class="room-badge" id="currentRoomTypeBadge">‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞</span>
                    <div id="roomActions" class="room-actions"></div>
                </div>
                <span class="online-status" id="onlineStatus">üü¢ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</span>
            </div>
            <div class="chat-header-right">
                <div class="user-profile" id="userProfile"></div>
                <button onclick="window.logout()" class="btn btn-outline">
                    ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="chat-main">
            <!-- Rooms Panel (‡∏ã‡πâ‡∏≤‡∏¢) -->
            <div class="rooms-panel">
                <div class="rooms-header">
                    <button class="create-room-btn" onclick="window.showCreateRoomModal()">
                        + ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                    </button>
                </div>
                
                <div class="room-tabs">
                    <button class="tab-btn active" onclick="window.filterRooms('all', this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    <button class="tab-btn" onclick="window.filterRooms('public', this)">‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞</button>
                    <button class="tab-btn" onclick="window.filterRooms('private', this)">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</button>
                </div>
                
                <div class="room-list" id="roomList">
                    <div style="text-align: center; padding: 40px 20px; color: #a0aec0;">
                        ‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡πâ‡∏≠‡∏á...
                    </div>
                </div>
            </div>
            
            <!-- Messages Area (‡∏Å‡∏•‡∏≤‡∏á) -->
            <div class="chat-content">
                <div class="messages-container" id="messagesContainer">
                    <!-- Messages will be loaded here -->
                </div>
                
                <!-- Typing Indicator -->
                <div id="typingIndicator" class="typing-indicator"></div>
                
                <!-- Input Area -->
                <div class="message-input-area" id="messageInputArea" style="display: none;">
                    <div class="input-wrapper">
                        <textarea 
                            id="messageInput" 
                            placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." 
                            rows="1"
                        ></textarea>
                        <button id="sendButton" class="btn-send">
                            üì§ ‡∏™‡πà‡∏á
                        </button>
                    </div>
                    <div class="input-footer">
                        <span class="character-count" id="charCount">0/500</span>
                    </div>
                </div>
            </div>
            
            <!-- Members Panel (‡∏Ç‡∏ß‡∏≤) -->
            <div class="members-panel" id="membersPanel">
                <div class="members-header">
                    <h3>üë• ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á</h3>
                    <button onclick="window.toggleMembersPanel()" style="background: none; border: none; font-size: 20px; cursor: pointer;">‚úï</button>
                </div>
                <div class="members-list" id="membersList"></div>
            </div>
        </div>
    </div>

    <!-- Modal: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á -->
    <div id="createRoomModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 24px;">üìù ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</h2>
            <form id="createRoomForm">
                <div class="form-group">
                    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á <span style="color: #e53e3e;">*</span></label>
                    <input type="text" id="roomName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°" required>
                </div>
                
                <div class="form-group">
                    <label>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
                    <textarea id="roomDescription" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡πâ‡∏≠‡∏á..." rows="2"></textarea>
                </div>
                
                <div class="form-group">
                    <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á</label>
                    <select id="roomType" onchange="window.togglePasswordField()">
                        <option value="public">üåç ‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞ - ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏î‡πâ</option>
                        <option value="private">üîí ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß - ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</option>
                    </select>
                </div>
                
                <div id="passwordField" class="password-field">
                    <div class="form-group">
                        <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏´‡πâ‡∏≠‡∏á</label>
                        <input type="password" id="roomPassword" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                    </div>
                    <div class="form-group">
                        <label>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                        <input type="password" id="confirmPassword" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á">
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á</button>
                    <button type="button" class="btn btn-secondary" onclick="window.closeCreateRoomModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal: ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß -->
    <div id="joinPrivateRoomModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 24px;">üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h2>
            <p id="joinRoomName" style="margin-bottom: 20px; font-weight: 600;"></p>
            
            <div class="form-group">
                <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏´‡πâ‡∏≠‡∏á</label>
                <input type="password" id="joinRoomPassword" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button onclick="window.confirmJoinPrivateRoom()" class="btn btn-primary" style="flex: 1;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</button>
                <button onclick="window.closeJoinPrivateModal()" class="btn btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: ‡πÄ‡∏ï‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å -->
    <div id="kickMemberModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 24px;">‚ö†Ô∏è ‡πÄ‡∏ï‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
            <p id="kickMemberName" style="margin-bottom: 20px;"></p>
            <p style="color: #718096; margin-bottom: 24px;">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á?</p>
            
            <div style="display: flex; gap: 12px;">
                <button onclick="window.confirmKickMember()" class="btn" style="flex: 1; background: #f56565; color: white;">‡πÄ‡∏ï‡∏∞‡∏≠‡∏≠‡∏Å</button>
                <button onclick="window.closeKickModal()" class="btn btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: ‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á -->
    <div id="deleteRoomModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 24px; color: #f56565;">‚ö†Ô∏è ‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á</h2>
            <p id="deleteRoomName" style="margin-bottom: 20px; font-weight: 600;"></p>
            <p style="color: #718096; margin-bottom: 24px;">
                ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£<br>
                <strong>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ!</strong>
            </p>
            
            <div style="display: flex; gap: 12px;">
                <button onclick="window.confirmDeleteRoom()" class="btn" style="flex: 1; background: #f56565; color: white;">
                    üóëÔ∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
                </button>
                <button onclick="window.closeDeleteRoomModal()" class="btn btn-secondary" style="flex: 1;">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="supabase-client.js"></script>
<script>
        // ========== GLOBAL VARIABLES ==========
        window.currentUser = null;
        window.currentRoom = null;
        window.currentRoomId = '00000000-0000-0000-0000-000000000000';
        window.messageSubscription = null;
        window.messagesContainer = document.getElementById('messagesContainer');
        window.messageInput = document.getElementById('messageInput');
        window.sendButton = document.getElementById('sendButton');
        
        const PUBLIC_ROOM_ID = '00000000-0000-0000-0000-000000000000';

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                window.currentUser = await checkUser();
                if (!window.currentUser) {
                    window.location.href = 'login.html';
                    return;
                }

                displayUserInfo();
                await loadRooms();
                await selectRoom(PUBLIC_ROOM_ID);
                await loadOnlineUsers();
                setupEventListeners();
                initMobileHandler();
                
                console.log('‚úÖ Chat initialized');
            } catch (error) {
                console.error('‚ùå Init error:', error);
            }
        });

        // ========== USER INFO ==========
        window.displayUserInfo = function() {
            const userProfile = document.getElementById('userProfile');
            const username = window.currentUser.user_metadata?.display_name || 
                            window.currentUser.user_metadata?.username || 
                            '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
            
            userProfile.innerHTML = `
                <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=667eea&color=fff" 
                     alt="${username}" 
                     class="avatar">
                <span class="username">${username}</span>
            `;
        };

        // ========== ROOM MANAGEMENT ==========
        window.loadRooms = async function(filter = 'all') {
            try {
                let query = supabaseClient
                    .from('rooms')
                    .select(`
                        *,
                        owner:owner_id (
                            username,
                            display_name
                        ),
                        room_members (
                            user_id,
                            role
                        )
                    `)
                    .order('created_at', { ascending: false });
                
                if (filter === 'public') {
                    query = query.eq('room_type', 'public');
                } else if (filter === 'private') {
                    query = query.eq('room_type', 'private');
                }
                
                const { data: rooms, error } = await query;
                if (error) throw error;
                
                displayRooms(rooms);
            } catch (error) {
                console.error('‚ùå Error loading rooms:', error);
            }
        };

        window.displayRooms = function(rooms) {
            const roomList = document.getElementById('roomList');
            if (!roomList) return;
            
            if (rooms.length === 0) {
                roomList.innerHTML = '<div style="text-align: center; padding: 40px 20px; color: #a0aec0;">üì≠ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó<br><small>‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</small></div>';
                return;
            }
            
            roomList.innerHTML = rooms.map(room => {
                const isOwner = room.owner_id === window.currentUser?.id;
                const memberCount = room.room_members?.length || 0;
                const isActive = window.currentRoomId === room.id;
                
                return `
                    <div class="room-item ${isActive ? 'active' : ''}" onclick="window.selectRoom('${room.id}')">
                        <div class="room-header">
                            <span class="room-name">
                                ${room.room_type === 'private' ? 'üîí' : 'üåç'} ${room.name}
                            </span>
                            <span class="room-type-badge">
                                ${room.room_type === 'private' ? '‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß' : '‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞'}
                            </span>
                        </div>
                        <div class="room-meta">
                            <span>üë§ ${room.owner?.display_name || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á'}</span>
                            <span>üë• ${memberCount} ‡∏Ñ‡∏ô</span>
                            ${isOwner ? '<span style="color: #48bb78;">üëë ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</span>' : ''}
                        </div>
                        ${room.description ? `<small style="color: #718096;">${room.description}</small>` : ''}
                    </div>
                `;
            }).join('');
        };

        window.selectRoom = async function(roomId) {
            try {
                const { data: room, error } = await supabaseClient
                    .from('rooms')
                    .select('*')
                    .eq('id', roomId)
                    .single();
                    
                if (error) throw error;
                
                if (room.room_type === 'private') {
                    const { data: member } = await supabaseClient
                        .from('room_members')
                        .select('*')
                        .eq('room_id', roomId)
                        .eq('user_id', window.currentUser.id)
                        .maybeSingle();
                        
                    if (!member && room.owner_id !== window.currentUser.id) {
                        showJoinPrivateModal(room);
                        return;
                    }
                }
                
                await joinRoom(room);
                
            } catch (error) {
                console.error('‚ùå Error selecting room:', error);
            }
        };

        window.joinRoom = async function(room) {
            try {
                const { data: existingMember } = await supabaseClient
                    .from('room_members')
                    .select('*')
                    .eq('room_id', room.id)
                    .eq('user_id', window.currentUser.id)
                    .maybeSingle();
                    
                if (!existingMember) {
                    await supabaseClient
                        .from('room_members')
                        .insert([{
                            room_id: room.id,
                            user_id: window.currentUser.id,
                            role: room.owner_id === window.currentUser.id ? 'owner' : 'member',
                            joined_at: new Date().toISOString()
                        }]);
                }
                
                window.currentRoom = room;
                window.currentRoomId = room.id;
                
                document.getElementById('currentRoomTitle').innerHTML = `
                    ${room.room_type === 'private' ? 'üîí' : 'üí¨'} ${room.name}
                `;
                document.getElementById('currentRoomTypeBadge').textContent = 
                    room.room_type === 'private' ? '‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß' : '‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞';
                
                const roomActions = document.getElementById('roomActions');
                if (room.owner_id === window.currentUser.id && room.id !== PUBLIC_ROOM_ID) {
                    roomActions.innerHTML = `
                        <button onclick="window.showDeleteRoomModal()" class="delete-room-btn">
                            üóëÔ∏è ‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á
                        </button>
                    `;
                } else {
                    roomActions.innerHTML = '';
                }
                
                document.getElementById('messageInputArea').style.display = 'block';
                
                await loadMessages(room.id);
                await loadRoomMembers(room.id);
                setupMessageSubscription(room.id);
                loadRooms();
                
            } catch (error) {
                console.error('‚ùå Error joining room:', error);
            }
        };

        // ========== DELETE ROOM ==========
        window.showDeleteRoomModal = function() {
            if (!window.currentRoom) return;
            document.getElementById('deleteRoomName').innerHTML = 
                `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á: <strong>${window.currentRoom.name}</strong>?`;
            document.getElementById('deleteRoomModal').classList.add('active');
        };

        window.closeDeleteRoomModal = function() {
            document.getElementById('deleteRoomModal').classList.remove('active');
        };

        window.confirmDeleteRoom = async function() {
            if (!window.currentRoomId || window.currentRoomId === PUBLIC_ROOM_ID) {
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞‡πÑ‡∏î‡πâ');
                window.closeDeleteRoomModal();
                return;
            }
            
            try {
                console.log('üóëÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á:', window.currentRoomId);
                
                const { error } = await supabaseClient
                    .from('rooms')
                    .delete()
                    .eq('id', window.currentRoomId)
                    .eq('owner_id', window.currentUser.id);
                
                if (error) throw error;
                
                alert('‚úÖ ‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                window.closeDeleteRoomModal();
                
                await selectRoom(PUBLIC_ROOM_ID);
                await loadRooms();
                
            } catch (error) {
                console.error('‚ùå Error deleting room:', error);
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ' + error.message);
                window.closeDeleteRoomModal();
            }
        };

        // ========== MESSAGES ==========
        window.loadMessages = async function(roomId) {
            try {
                const { data: messages, error } = await supabaseClient
                    .from('messages')
                    .select(`
                        *,
                        profiles:user_id (
                            username,
                            display_name,
                            avatar_url
                        )
                    `)
                    .eq('room_id', roomId)
                    .order('created_at', { ascending: true })
                    .limit(50);
                    
                if (error) throw error;
                
                window.messagesContainer.innerHTML = '';
                
                if (messages.length === 0) {
                    window.messagesContainer.innerHTML = '<div style="text-align: center; padding: 50px; color: #a0aec0;">üí¨ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°<br><small>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢!</small></div>';
                } else {
                    messages.forEach(msg => displayMessage(msg));
                }
                
                scrollToBottom();
                
            } catch (error) {
                console.error('‚ùå Error loading messages:', error);
            }
        };

        window.displayMessage = function(message) {
            if (!window.messagesContainer) return;
            
            const isOwnMessage = message.user_id === window.currentUser?.id;
            const author = message.profiles?.display_name || message.profiles?.username || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
            const avatarUrl = message.profiles?.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(author)}&background=667eea&color=fff`;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isOwnMessage ? 'own-message' : ''}`;
            messageDiv.innerHTML = `
                <img src="${avatarUrl}" alt="${author}" class="message-avatar"
                     onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(author)}&background=667eea&color=fff'">
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">${author}</span>
                        <span class="message-time">${formatTime(message.created_at)}</span>
                    </div>
                    <div class="message-body">${linkify(message.message)}</div>
                </div>
            `;
            
            window.messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        };

        window.sendMessage = async function() {
            const message = window.messageInput.value.trim();
            if (!message || !window.currentRoomId) return;
            
            try {
                const { error } = await supabaseClient
                    .from('messages')
                    .insert([{
                        user_id: window.currentUser.id,
                        room_id: window.currentRoomId,
                        message: message,
                        created_at: new Date().toISOString()
                    }]);
                    
                if (error) throw error;
                
                window.messageInput.value = '';
                document.getElementById('charCount').textContent = '0/500';
                
            } catch (error) {
                console.error('‚ùå Error sending message:', error);
            }
        };

        // ========== REALTIME ==========
        window.setupMessageSubscription = function(roomId) {
            if (window.messageSubscription) {
                window.messageSubscription.unsubscribe();
            }
            
            window.messageSubscription = supabaseClient
                .channel(`room-${roomId}`)
                .on(
                    'postgres_changes',
                    {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'messages',
                        filter: `room_id=eq.${roomId}`
                    },
                    async (payload) => {
                        const { data: profile } = await supabaseClient
                            .from('profiles')
                            .select('username, display_name, avatar_url')
                            .eq('id', payload.new.user_id)
                            .single();
                            
                        displayMessage({
                            ...payload.new,
                            profiles: profile
                        });
                    }
                )
                .subscribe();
        };

        // ========== ROOM MEMBERS ==========
        window.loadRoomMembers = async function(roomId) {
            try {
                const { data: members, error } = await supabaseClient
                    .from('room_members')
                    .select(`
                        user_id,
                        role,
                        joined_at,
                        profiles:user_id (
                            username,
                            display_name,
                            avatar_url
                        )
                    `)
                    .eq('room_id', roomId);
                    
                if (error) throw error;
                
                displayRoomMembers(members);
            } catch (error) {
                console.error('‚ùå Error loading members:', error);
            }
        };

        window.displayRoomMembers = function(members) {
            const container = document.getElementById('membersList');
            if (!container) return;
            
            const isOwner = window.currentRoom?.owner_id === window.currentUser.id;
            
            container.innerHTML = members.map(member => {
                const profile = member.profiles;
                const isCurrentUser = member.user_id === window.currentUser.id;
                const canKick = isOwner && !isCurrentUser && member.role !== 'owner';
                
                return `
                    <div class="member-item">
                        <img src="${profile?.avatar_url || `https://ui-avatars.com/api/?name=${profile?.display_name || profile?.username}`}" 
                             alt="${profile?.display_name}" 
                             class="member-avatar">
                        <div class="member-info">
                            <div class="member-name">
                                ${profile?.display_name || profile?.username}
                                ${isCurrentUser ? ' (‡∏Ñ‡∏∏‡∏ì)' : ''}
                            </div>
                            <div class="member-role">
                                ${member.role === 'owner' ? 'üëë ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á' : 'üë§ ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å'}
                            </div>
                        </div>
                        ${canKick ? `
                            <button class="kick-btn" onclick="window.showKickModal('${member.user_id}', '${profile?.display_name || profile?.username}')">
                                ‡πÄ‡∏ï‡∏∞‡∏≠‡∏≠‡∏Å
                            </button>
                        ` : ''}
                    </div>
                `;
            }).join('');
        };

        // ========== KICK MEMBER ==========
        window.kickMemberId = null;

        window.showKickModal = function(userId, username) {
            window.kickMemberId = userId;
            document.getElementById('kickMemberName').textContent = `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏∞ "${username}" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á?`;
            document.getElementById('kickMemberModal').classList.add('active');
        };

        window.closeKickModal = function() {
            window.kickMemberId = null;
            document.getElementById('kickMemberModal').classList.remove('active');
        };

        window.confirmKickMember = async function() {
            if (!window.kickMemberId || !window.currentRoomId) return;
            
            try {
                const { error } = await supabaseClient
                    .from('room_members')
                    .delete()
                    .eq('room_id', window.currentRoomId)
                    .eq('user_id', window.kickMemberId);
                    
                if (error) throw error;
                
                alert('‚úÖ ‡πÄ‡∏ï‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß');
                closeKickModal();
                await loadRoomMembers(window.currentRoomId);
                
            } catch (error) {
                console.error('‚ùå Error kicking member:', error);
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ï‡∏∞‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÑ‡∏î‡πâ');
            }
        };

        // ========== CREATE ROOM ==========
        window.createRoom = async function(event) {
            event.preventDefault();
            
            try {
                const name = document.getElementById('roomName').value;
                const description = document.getElementById('roomDescription').value;
                const roomType = document.getElementById('roomType').value;
                const password = document.getElementById('roomPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (roomType === 'private') {
                    if (!password) {
                        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß');
                        return;
                    }
                    if (password !== confirmPassword) {
                        alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
                        return;
                    }
                }
                
                const { data: room, error } = await supabaseClient
                    .from('rooms')
                    .insert([{
                        name: name,
                        description: description,
                        room_type: roomType,
                        password: roomType === 'private' ? password : null,
                        owner_id: window.currentUser.id,
                        created_at: new Date().toISOString()
                    }])
                    .select()
                    .single();
                    
                if (error) throw error;
                
                await supabaseClient
                    .from('room_members')
                    .insert([{
                        room_id: room.id,
                        user_id: window.currentUser.id,
                        role: 'owner',
                        joined_at: new Date().toISOString()
                    }]);
                
                alert('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                closeCreateRoomModal();
                await loadRooms();
                await selectRoom(room.id);
                
            } catch (error) {
                console.error('‚ùå Error creating room:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á');
            }
        };

        // ========== ONLINE USERS ==========
        window.loadOnlineUsers = async function() {
            try {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('username, display_name, avatar_url')
                    .eq('is_online', true)
                    .limit(30);
                    
                if (error) throw error;
                
                const userMap = new Map();
                data.forEach(user => {
                    if (!userMap.has(user.username)) {
                        userMap.set(user.username, user);
                    }
                });
                
                const uniqueUsers = Array.from(userMap.values());
                
                const usersList = document.getElementById('onlineUsersList');
                const totalUsers = document.getElementById('totalUsers');
                
                if (usersList) {
                    if (uniqueUsers.length === 0) {
                        usersList.innerHTML = '<div style="text-align: center; padding: 20px; color: #a0aec0;">üü° ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>';
                    } else {
                        usersList.innerHTML = uniqueUsers.map(user => `
                            <div class="online-user">
                                <img src="${user.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.display_name || user.username)}&background=667eea&color=fff`}" 
                                     alt="${user.display_name || user.username}" 
                                     class="user-avatar">
                                <span class="user-name">${user.display_name || user.username}</span>
                                <span class="online-dot"></span>
                            </div>
                        `).join('');
                    }
                }
                
                if (totalUsers) {
                    totalUsers.textContent = uniqueUsers.length;
                }
                
            } catch (error) {
                console.error('‚ùå Error loading online users:', error);
            }
        };

        // ========== MODAL CONTROLS ==========
        window.showCreateRoomModal = function() {
            document.getElementById('createRoomModal').classList.add('active');
        };

        window.closeCreateRoomModal = function() {
            document.getElementById('createRoomModal').classList.remove('active');
            document.getElementById('createRoomForm').reset();
            document.getElementById('passwordField').classList.remove('show');
        };

        window.togglePasswordField = function() {
            const roomType = document.getElementById('roomType').value;
            const passwordField = document.getElementById('passwordField');
            passwordField.classList.toggle('show', roomType === 'private');
        };

        window.showJoinPrivateModal = function(room) {
            document.getElementById('joinRoomName').textContent = `‡∏´‡πâ‡∏≠‡∏á: ${room.name}`;
            document.getElementById('joinPrivateRoomModal').dataset.roomId = room.id;
            document.getElementById('joinPrivateRoomModal').classList.add('active');
        };

        window.closeJoinPrivateModal = function() {
            document.getElementById('joinPrivateRoomModal').classList.remove('active');
            document.getElementById('joinRoomPassword').value = '';
        };

        // ========== ‚úÖ FIXED: JOIN PRIVATE ROOM ==========
        window.confirmJoinPrivateRoom = async function() {
            const roomId = document.getElementById('joinPrivateRoomModal').dataset.roomId;
            const password = document.getElementById('joinRoomPassword').value;
            
            if (!password) {
                alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô');
                return;
            }
            
            try {
                console.log('üîê ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏´‡πâ‡∏≠‡∏á:', roomId);
                
                // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
                const { data: room, error } = await supabaseClient
                    .from('rooms')
                    .select('*')
                    .eq('id', roomId)
                    .single();
                    
                if (error) throw error;
                
                // 2. ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
                if (room.password !== password) {
                    alert('‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                    return;
                }
                
                console.log('‚úÖ ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                
                // 3. ‡∏õ‡∏¥‡∏î modal
                window.closeJoinPrivateModal();
                
                // 4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
                const { data: existingMember } = await supabaseClient
                    .from('room_members')
                    .select('*')
                    .eq('room_id', roomId)
                    .eq('user_id', window.currentUser.id)
                    .maybeSingle();
                
                if (!existingMember) {
                    console.log('‚ûï ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà');
                    const { error: insertError } = await supabaseClient
                        .from('room_members')
                        .insert([{
                            room_id: roomId,
                            user_id: window.currentUser.id,
                            role: 'member',
                            joined_at: new Date().toISOString()
                        }]);
                        
                    if (insertError) throw insertError;
                    console.log('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                }
                
                // 5. ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á
                console.log('üö™ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á:', room.name);
                await window.selectRoom(roomId);
                
            } catch (error) {
                console.error('‚ùå Error joining private room:', error);
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ' + error.message);
            }
        };

        // ========== UI CONTROLS ==========
        window.filterRooms = function(filter, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            loadRooms(filter);
        };

        window.toggleMembersPanel = function() {
            document.getElementById('membersPanel').classList.toggle('active');
        };

        // ========== EVENT LISTENERS ==========
        window.setupEventListeners = function() {
            if (window.sendButton) {
                window.sendButton.addEventListener('click', window.sendMessage);
            }
            
            if (window.messageInput) {
                window.messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        window.sendMessage();
                    }
                });
                
                window.messageInput.addEventListener('input', () => {
                    const count = window.messageInput.value.length;
                    const charCount = document.getElementById('charCount');
                    if (charCount) {
                        charCount.textContent = `${count}/500`;
                    }
                    
                    if (count > 500) {
                        window.messageInput.value = window.messageInput.value.slice(0, 500);
                    }
                });
            }
            
            document.getElementById('createRoomForm').addEventListener('submit', window.createRoom);
        };

        // ========== MOBILE HANDLER ==========
        window.initMobileHandler = function() {
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            if (!isMobile) return;
            
            let originalHeight = window.innerHeight;
            
            window.addEventListener('resize', () => {
                const newHeight = window.innerHeight;
                if (originalHeight - newHeight > 150) {
                    document.body.classList.add('keyboard-open');
                    setTimeout(() => {
                        if (window.messageInput) {
                            window.messageInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 300);
                } else {
                    document.body.classList.remove('keyboard-open');
                }
            });
        };

        // ========== UTILITIES ==========
        window.formatTime = function(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
            }
            if (diff < 86400000 * 2) {
                return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô';
            }
            return date.toLocaleDateString('th-TH', {
                day: 'numeric',
                month: 'short',
                hour: '2-digit',
                minute: '2-digit'
            });
        };

        window.linkify = function(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, url => 
                `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`
            );
        };

        window.scrollToBottom = function() {
            if (window.messagesContainer) {
                window.messagesContainer.scrollTop = window.messagesContainer.scrollHeight;
            }
        };

        // ========== LOGOUT ==========
        window.logout = async function() {
            await supabaseClient.auth.signOut();
            window.location.href = 'index.html';
        };

        // ========== CLEANUP ==========
        window.addEventListener('beforeunload', () => {
            if (window.messageSubscription) {
                window.messageSubscription.unsubscribe();
            }
        });
    </script>
</body>
</html>

