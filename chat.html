<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ChatApp - ห้องแชท</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ========== GLOBAL VARIABLES ========== */
        :root {
            --primary-color: #667eea;
            --primary-dark: #5a67d8;
            --secondary-color: #48bb78;
            --danger-color: #f56565;
            --danger-dark: #e53e3e;
            --text-dark: #2d3748;
            --text-light: #718096;
            --bg-light: #f7fafc;
            --bg-white: #ffffff;
            --border-color: #e2e8f0;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 20px;
            --radius-full: 9999px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-dark);
            line-height: 1.5;
        }

        /* ========== CHAT CONTAINER ========== */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: var(--bg-white);
        }

        /* ========== CHAT HEADER ========== */
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: var(--bg-white);
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .chat-header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .current-room-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .current-room-info h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-dark);
            margin: 0;
        }

        .room-badge {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: var(--radius-xl);
            background: var(--bg-light);
            color: var(--text-light);
            font-weight: 500;
        }

        .online-status {
            font-size: 14px;
            color: var(--secondary-color);
            background: #f0fff4;
            padding: 4px 12px;
            border-radius: var(--radius-xl);
            font-weight: 500;
        }

        /* ========== MOBILE MENU BUTTON ========== */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            color: var(--text-light);
            transition: color 0.2s;
            min-width: 44px;
            min-height: 44px;
        }

        .mobile-menu-btn:hover {
            color: var(--primary-color);
        }

        /* ========== ROOM ACTIONS ========== */
        .room-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }

        .delete-room-btn {
            padding: 6px 12px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .delete-room-btn:hover {
            background: var(--danger-dark);
            transform: translateY(-2px);
        }

        .admin-delete-room-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.2s;
        }

        .admin-delete-room-btn:hover {
            background: var(--danger-dark);
            transform: translateY(-2px);
        }

        /* ========== MAIN CHAT AREA ========== */
        .chat-main {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* ========== ROOMS PANEL (ซ้าย) ========== */
        .rooms-panel {
            width: 300px;
            background: var(--bg-light);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .rooms-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .create-room-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .create-room-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .room-tabs {
            display: flex;
            padding: 16px 20px;
            gap: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-btn {
            flex: 1;
            padding: 8px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            color: var(--text-light);
        }

        .tab-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .room-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .room-item {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid transparent;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
            cursor: pointer !important;
            pointer-events: auto !important;
        }

        .room-item:hover {
            border-color: var(--primary-color);
            transform: translateX(5px);
            box-shadow: var(--shadow-md);
        }

        .room-item.active {
            background: var(--primary-color);
            color: white;
        }

        .room-item * {
            pointer-events: none;
        }

        .room-item button {
            pointer-events: auto;
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .room-name {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .room-type-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: var(--radius-xl);
            background: var(--bg-light);
            color: var(--text-light);
        }

        .room-item.active .room-type-badge {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .room-meta {
            font-size: 12px;
            color: var(--text-light);
            display: flex;
            gap: 12px;
            margin-bottom: 4px;
        }

        .room-item.active .room-meta {
            color: rgba(255,255,255,0.8);
        }

        /* ========== CHAT CONTENT (กลาง) ========== */
        .chat-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-white);
        }

        .messages-container {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            position: relative;
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 70%;
            animation: fadeIn 0.3s ease;
            position: relative;
            transition: all 0.2s;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .own-message {
            margin-left: auto;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .message-content {
            background: var(--bg-light);
            padding: 12px 16px;
            border-radius: 18px 18px 18px 4px;
            box-shadow: var(--shadow-sm);
            max-width: 100%;
            word-break: break-word;
        }

        .own-message .message-content {
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            color: white;
            border-radius: 18px 18px 4px 18px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .message-author {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 14px;
        }

        .own-message .message-author {
            color: rgba(255,255,255,0.95);
        }

        .message-time {
            font-size: 11px;
            color: var(--text-light);
            margin-left: 8px;
        }

        .own-message .message-time {
            color: rgba(255,255,255,0.8);
        }

        .message-body {
            line-height: 1.5;
            font-size: 14px;
        }

        .message-body a {
            color: inherit;
            text-decoration: underline;
        }

        .message.deleted-message {
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: 12px 16px;
            margin-bottom: 12px;
            opacity: 0.7;
            max-width: 100%;
        }

        .deleted-content {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-light);
            font-style: italic;
        }

        .delete-message-btn {
            background: none;
            border: none;
            color: #a0aec0;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            opacity: 0;
            margin-left: 8px;
            font-size: 14px;
        }

        .message:hover .delete-message-btn {
            opacity: 1;
        }

        .delete-message-btn:hover {
            background: #fed7d7;
            color: var(--danger-dark);
        }

        .message-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: var(--radius-lg);
            margin-top: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            border: 2px solid transparent;
        }

        .message-image:hover {
            transform: scale(1.02);
            border-color: var(--primary-color);
        }

        /* ========== LONG PRESS SELECTION MODE ========== */
        .selection-hint {
            position: sticky;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            display: none;
            align-items: center;
            justify-content: space-between;
            z-index: 100;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            animation: slideDown 0.3s ease;
        }

        .selection-hint span {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .selection-hint .btn-icon {
            color: white;
            opacity: 0.9;
            transition: all 0.2s;
        }

        .selection-hint .btn-icon:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Messages Container ในโหมดเลือก */
        .messages-container.selection-mode .message {
            cursor: pointer;
            padding-left: 50px;
        }

        .messages-container.selection-mode .own-message {
            padding-left: 16px;
            padding-right: 50px;
        }

        .messages-container.selection-mode .message:hover {
            background-color: rgba(102, 126, 234, 0.05);
        }

        /* Checkbox สไตล์ */
        .message-checkbox {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .own-message .message-checkbox {
            left: auto;
            right: 10px;
        }

        .message-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary-color);
            border-radius: 4px;
            transition: all 0.2s;
            margin: 0;
        }

        .message-checkbox input[type="checkbox"]:checked {
            transform: scale(1.1);
        }

        /* ข้อความที่ถูกเลือก */
        .message.selected {
            background-color: rgba(102, 126, 234, 0.15);
            border-radius: 12px;
            transform: scale(0.99);
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
        }

        .message.selected .message-content {
            background-color: transparent;
        }

        .own-message.selected {
            background-color: rgba(102, 126, 234, 0.25);
        }

        /* Animation ตอนกดค้าง */
        .message:active {
            transform: scale(0.98);
            background-color: rgba(102, 126, 234, 0.1);
            transition: all 0.1s;
        }

        /* ปุ่มลบหลายข้อความ */
        .delete-selected-btn {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            padding: 16px 32px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 16px;
            box-shadow: 0 8px 25px rgba(229, 62, 62, 0.4);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 2000;
            animation: slideUp 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.5px;
        }

        .delete-selected-btn:hover {
            transform: translateX(-50%) scale(1.05);
            box-shadow: 0 12px 30px rgba(229, 62, 62, 0.5);
        }

        .delete-selected-btn:active {
            transform: translateX(-50%) scale(0.95);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* Tooltip แนะนำ */
        .long-press-tip {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1999;
            animation: fadeInOut 3s ease forwards;
            pointer-events: none;
            white-space: nowrap;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(10px); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            90% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
        }

        /* ========== INPUT AREA ========== */
        .message-input-area {
            padding: 16px 24px;
            background: var(--bg-white);
            border-top: 1px solid var(--border-color);
        }

        .input-toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            padding: 0 4px;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            padding: 8px 16px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-light);
        }

        .toolbar-btn:hover {
            background: var(--bg-light);
            border-color: var(--primary-color);
            transform: translateY(-2px);
            color: var(--primary-color);
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            background: var(--bg-light);
            border-radius: var(--radius-xl);
            padding: 4px 4px 4px 20px;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .input-wrapper:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-wrapper textarea {
            flex: 1;
            border: none;
            background: transparent;
            padding: 12px 0;
            max-height: 120px;
            font-size: 15px;
            line-height: 1.5;
            resize: none;
        }

        .input-wrapper textarea:focus {
            outline: none;
        }

        .btn-send {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-xl);
            padding: 10px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-send:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .input-footer {
            margin-top: 8px;
            display: flex;
            justify-content: flex-end;
            color: #a0aec0;
            font-size: 13px;
        }

        .image-preview {
            position: relative;
            margin-top: 12px;
            padding: 12px;
            background: var(--bg-light);
            border-radius: var(--radius-md);
            display: inline-block;
        }

        .image-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: var(--radius-md);
            border: 2px solid var(--border-color);
        }

        .remove-preview {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }

        .remove-preview:hover {
            background: var(--danger-dark);
            transform: scale(1.1);
        }

        /* ========== MEMBERS PANEL ========== */
        .members-panel {
            width: 280px;
            background: var(--bg-white);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .members-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .members-header h3 {
            font-size: 16px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .members-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .member-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            background: var(--bg-light);
            transition: all 0.2s;
        }

        .member-item:hover {
            background: #e2e8f0;
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 14px;
        }

        .member-role {
            font-size: 12px;
            color: var(--text-light);
        }

        .kick-btn {
            padding: 6px 12px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .kick-btn:hover {
            background: var(--danger-dark);
            transform: translateY(-2px);
        }

        /* ========== ACTIVITIES PANEL ========== */
        .activities-panel {
            width: 320px;
            background: var(--bg-white);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .activities-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .activities-header h3 {
            font-size: 16px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .create-activity-btn-container {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .activities-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .activity-item {
            background: var(--bg-light);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 16px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .activity-item:hover {
            border-color: var(--primary-color);
            transform: translateX(5px);
            box-shadow: var(--shadow-md);
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .activity-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 16px;
        }

        .activity-type-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: var(--radius-xl);
            background: var(--bg-white);
            color: var(--text-light);
            text-transform: uppercase;
        }

        .activity-creator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            color: var(--text-light);
        }

        .activity-creator-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
        }

        .activity-description {
            font-size: 14px;
            color: var(--text-dark);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .activity-meta {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            font-size: 12px;
            color: var(--text-light);
        }

        .activity-actions {
            display: flex;
            gap: 12px;
        }

        .join-activity-btn {
            flex: 1;
            padding: 8px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .join-activity-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .join-activity-btn.joined {
            background: var(--danger-color);
        }

        .join-activity-btn.joined:hover {
            background: var(--danger-dark);
        }

        .view-activity-btn {
            padding: 8px 16px;
            background: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-activity-btn:hover {
            background: var(--bg-light);
            border-color: var(--primary-color);
        }

        /* ========== PARTICIPANTS LIST ========== */
        .participants-list {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 16px;
        }

        .participant-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            width: 70px;
        }

        .participant-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid var(--primary-color);
            object-fit: cover;
        }

        .participant-name {
            font-size: 12px;
            color: var(--text-light);
            text-align: center;
            word-break: break-word;
        }

        /* ========== READ RECEIPTS ========== */
        .read-by-container {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-top: 8px;
            padding-top: 4px;
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        .own-message .read-by-container {
            justify-content: flex-start;
            flex-direction: row-reverse;
        }

        .read-icon {
            font-size: 12px;
            color: var(--secondary-color);
            margin-right: 6px;
            font-weight: 600;
        }

        .read-by-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 4px;
            border: 2px solid var(--bg-white);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .read-by-avatar:hover {
            transform: scale(1.2);
            z-index: 10;
        }

        .read-by-more {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--border-color);
            color: var(--text-light);
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
        }

        .read-by-more:hover {
            background: #cbd5e0;
        }

        /* ========== MUSIC PLAYER ========== */
        .music-playlist {
            margin-top: 20px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }

        .playlist-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .playlist-item:hover {
            background: var(--bg-light);
        }

        .playlist-info {
            flex: 1;
        }

        .playlist-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .playlist-artist {
            font-size: 12px;
            color: var(--text-light);
        }

        .playlist-controls {
            display: flex;
            gap: 8px;
        }

        .playlist-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
        }

        .playlist-btn:hover {
            background: var(--border-color);
            transform: scale(1.1);
        }

        /* ========== MUSIC BAR ========== */
        .music-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 2000;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
        }

        .music-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .music-icon {
            font-size: 20px;
        }

        .music-title {
            font-weight: 600;
            font-size: 14px;
        }

        .music-controls {
            display: flex;
            gap: 16px;
        }

        .music-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .music-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        /* ========== ADMIN BUTTON ========== */
        .btn-admin {
            background: #805ad5;
            color: white;
            padding: 8px 16px;
            border-radius: var(--radius-md);
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 8px;
        }

        .btn-admin.active {
            background: #6b46c1;
            box-shadow: 0 0 0 2px rgba(128, 90, 213, 0.3);
        }

        .btn-admin:hover {
            background: #6b46c1;
            transform: translateY(-2px);
        }

        /* ========== MODAL STYLES ========== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-white);
            padding: 30px;
            border-radius: var(--radius-lg);
            width: 450px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        /* ========== EMOJI GRID ========== */
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            padding: 8px;
            max-height: 300px;
            overflow-y: auto;
            background: var(--bg-light);
            border-radius: var(--radius-md);
        }

        .emoji-item {
            font-size: 24px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            border-radius: var(--radius-md);
            transition: all 0.2s;
        }

        .emoji-item:hover {
            background: var(--primary-color);
            transform: scale(1.2);
            color: white;
        }

        /* ========== PASSWORD FIELD ========== */
        .password-field {
            display: none;
        }

        .password-field.show {
            display: block;
        }

        /* ========== ACTIVITY FIELDS ========== */
        .activity-field {
            margin-bottom: 16px;
        }

        /* ========== LIGHTBOX ========== */
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            cursor: pointer;
        }

        .lightbox img {
            max-width: 90%;
            max-height: 90%;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
        }

        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transition: all 0.2s;
        }

        .lightbox-close:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        /* ========== BUTTON STYLES ========== */
        .btn {
            display: inline-block;
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--border-color);
            color: var(--text-light);
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-icon {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: var(--bg-light);
        }

        /* ========== FORM STYLES ========== */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-dark);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group small {
            display: block;
            margin-top: 4px;
            color: var(--text-light);
            font-size: 12px;
        }

        /* ========== USER PROFILE ========== */
        .user-profile {
            display: flex;
            align-items: center;
            margin-right: 16px;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .username {
            font-weight: 600;
            color: var(--text-dark);
        }

        /* ========== UTILITIES ========== */
        .text-center {
            text-align: center;
        }

        .text-muted {
            color: var(--text-light);
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
        }

        .sidebar-overlay.active {
            display: block;
        }

        body.sidebar-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        /* ========== YOUTUBE PLAYER MODAL ========== */
        #youtubePlayerModal .modal-content {
            max-width: 900px;
            width: 90%;
            padding: 20px;
        }

        #youtubePlayerContainer {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        #youtube-player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #youtube-player-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .youtube-controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        #youtubePlayerState {
            color: var(--text-light);
            font-size: 14px;
            text-align: center;
            margin-bottom: 12px;
        }

        /* ========== JITSI CALL MODAL ========== */
        #jitsiCallModal .modal-content {
            max-width: 1000px;
            width: 95%;
            height: 80vh;
            padding: 0;
            overflow: hidden;
            border-radius: 12px;
        }

        #jitsiCallModal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: #f7fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        #jitsi-container {
            width: 100%;
            height: calc(100% - 73px);
        }

        /* ========== CALL TOAST NOTIFICATION ========== */
        .call-toast {
            animation: slideIn 0.3s ease;
            margin-bottom: 12px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* ========== MOBILE RESPONSIVE ========== */
        @media (max-width: 768px) {
            .chat-main {
                flex-direction: column;
            }

            .rooms-panel {
                position: fixed !important;
                left: -100%;
                top: 0;
                width: 85% !important;
                height: 100vh !important;
                z-index: 2000;
                transition: left 0.3s ease;
                background: var(--bg-white);
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
                overflow-y: auto;
            }

            .rooms-panel.mobile-active {
                left: 0 !important;
            }

            .rooms-panel .room-item {
                pointer-events: auto !important;
                cursor: pointer !important;
            }

            .members-panel,
            .activities-panel {
                position: fixed !important;
                right: -100%;
                top: 0;
                width: 85% !important;
                height: 100vh !important;
                z-index: 2000;
                transition: right 0.3s ease;
                background: var(--bg-white);
                box-shadow: -2px 0 10px rgba(0,0,0,0.1);
                overflow-y: auto;
            }

            .members-panel.active,
            .activities-panel.active {
                right: 0 !important;
            }

            .mobile-menu-btn {
                display: inline-block !important;
            }

            .current-room-info h2 {
                font-size: 18px;
                max-width: 200px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .room-badge,
            .online-status {
                display: none;
            }

            .user-profile .username {
                display: none;
            }

            .avatar {
                margin-right: 0;
            }

            .message {
                max-width: 85%;
            }

            .message-avatar {
                width: 32px;
                height: 32px;
            }

            .message-input-area {
                padding: 12px 16px;
            }

            .toolbar-btn {
                padding: 8px 12px;
                font-size: 14px;
            }

            .input-wrapper textarea {
                font-size: 16px;
            }

            .input-footer {
                display: none;
            }

            .participant-item {
                width: 60px;
            }

            .participant-avatar {
                width: 40px;
                height: 40px;
            }

            .emoji-grid {
                grid-template-columns: repeat(5, 1fr);
            }

            #youtubePlayerModal .modal-content {
                width: 100%;
                height: 100%;
                max-width: none;
                max-height: none;
                border-radius: 0;
                padding: 16px;
                display: flex;
                flex-direction: column;
            }

            #youtubePlayerContainer {
                flex: 1;
                padding-bottom: 0;
                height: auto;
                min-height: 0;
            }

            #youtube-player {
                position: relative;
                height: 100%;
            }

            .youtube-controls {
                margin: 12px 0;
            }

            .youtube-controls button {
                flex: 1;
                min-width: 100px;
            }

            #jitsiCallModal .modal-content {
                width: 100%;
                height: 100%;
                border-radius: 0;
            }

            #jitsi-container {
                height: calc(100% - 60px);
            }

            .call-toast {
                top: auto !important;
                bottom: 20px;
                right: 20px;
                left: 20px;
            }

            .call-toast > div {
                width: 100%;
            }

            .messages-container.selection-mode .message {
                padding-left: 45px;
            }

            .own-message.selection-mode {
                padding-left: 16px;
                padding-right: 45px;
            }

            .message-checkbox {
                width: 22px;
                height: 22px;
            }

            .message-checkbox input[type="checkbox"] {
                width: 22px;
                height: 22px;
            }

            .delete-selected-btn {
                bottom: 20px;
                padding: 14px 28px;
                font-size: 15px;
                width: calc(100% - 40px);
                justify-content: center;
            }
        }

        @media (max-width: 375px) {
            .current-room-info h2 {
                max-width: 150px;
                font-size: 16px;
            }

            .toolbar-btn {
                padding: 6px 10px;
                font-size: 13px;
            }

            .message {
                max-width: 90%;
            }

            .emoji-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* ========== KEYBOARD OPEN FIX ========== */
        .keyboard-open .chat-container {
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .keyboard-open .message-input-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-white);
            z-index: 2000;
        }

        .keyboard-open .messages-container {
            padding-bottom: 120px;
        }

        /* ========== iOS SPECIFIC FIXES ========== */
        @supports (-webkit-touch-callout: none) {
            .chat-container {
                height: -webkit-fill-available;
            }

            .message-input-area {
                padding-bottom: max(12px, env(safe-area-inset-bottom, 12px));
            }

            .chat-header {
                padding-top: max(12px, env(safe-area-inset-top, 12px));
            }
        }

        /* ========== ANIMATIONS ========== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }

        @keyframes slideOut {
            from { transform: translateX(0); }
            to { transform: translateX(-100%); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* ========== SCROLLBAR STYLING ========== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-light);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: var(--radius-full);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-light);
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- ========== HEADER ========== -->
        <div class="chat-header">
            <div class="chat-header-left">
                <button class="mobile-menu-btn" onclick="window.toggleMobileSidebar()">☰</button>
                <div class="current-room-info">
                    <h2 id="currentRoomTitle">💬 ห้องแชทสาธารณะ</h2>
                    <span class="room-badge" id="currentRoomTypeBadge">สาธารณะ</span>
                    <div id="roomActions" class="room-actions"></div>
                </div>
                <span class="online-status" id="onlineStatus">🟢 ออนไลน์</span>
            </div>
            <div class="chat-header-right">
                <div class="user-profile" id="userProfile"></div>
                <button id="adminModeBtn" onclick="window.toggleAdminMode()" class="btn btn-admin" style="display: none;">👑 แอดมิน (ปิด)</button>
                <button onclick="window.logout()" class="btn btn-outline">ออกจากระบบ</button>
            </div>
        </div>

        <!-- ========== MAIN CHAT AREA ========== -->
        <div class="chat-main">
            <!-- ROOMS PANEL (ซ้าย) -->
            <div class="rooms-panel">
                <div class="rooms-header">
                    <button class="create-room-btn" onclick="window.showCreateRoomModal()">+ สร้างห้องใหม่</button>
                </div>
                <div class="room-tabs">
                    <button class="tab-btn active" onclick="window.filterRooms('all', this)">ทั้งหมด</button>
                    <button class="tab-btn" onclick="window.filterRooms('public', this)">สาธารณะ</button>
                    <button class="tab-btn" onclick="window.filterRooms('private', this)">ส่วนตัว</button>
                </div>
                <div class="room-list" id="roomList">
                    <div style="text-align: center; padding: 40px 20px; color: #a0aec0;">⏳ กำลังโหลดห้อง...</div>
                </div>
            </div>

            <!-- MESSAGES AREA (กลาง) -->
            <div class="chat-content">
                <div class="messages-container" id="messagesContainer">
                    <!-- Messages will be loaded here -->
                </div>
                
                <!-- Selection Hint -->
                <div id="selectionHint" class="selection-hint">
                    <span>✅ เลือกข้อความที่ต้องการลบ</span>
                    <button onclick="window.exitSelectionMode()" class="btn-icon" style="color: white;">✕</button>
                </div>
                
                <div id="typingIndicator" class="typing-indicator"></div>
                <div id="deleteSelectedBtn" class="delete-selected-btn" onclick="window.deleteSelectedMessages()">🗑️ ลบ 0 ข้อความ</div>
                
                <!-- Input Area -->
                <div class="message-input-area" id="messageInputArea">
                    <div class="input-toolbar">
                        <button type="button" class="toolbar-btn" onclick="window.openEmojiPicker()" title="อิโมจิ">😊</button>
                        <button type="button" class="toolbar-btn" onclick="window.uploadImage()" title="รูปภาพ">📷</button>
                        <button type="button" class="toolbar-btn" onclick="window.openMusicPlayer()" title="เพลง">🎵</button>
                        <button type="button" class="toolbar-btn" onclick="window.toggleActivitiesPanel()" title="กิจกรรม">🎮</button>
                        <button type="button" class="toolbar-btn" onclick="window.startCall()" title="โทร">📞 โทร</button>
                        <button type="button" class="toolbar-btn" onclick="window.toggleMembersPanel()" title="สมาชิก">👥</button>
                    </div>
                    
                    <div class="input-wrapper">
                        <textarea id="messageInput" placeholder="พิมพ์ข้อความ..." rows="1"></textarea>
                        <button id="sendButton" class="btn-send">📤 ส่ง</button>
                    </div>
                    
                    <div id="imagePreview" class="image-preview" style="display: none;">
                        <img id="previewImg" src="" alt="Preview">
                        <button type="button" class="remove-preview" onclick="window.clearImagePreview()">✕</button>
                    </div>
                    
                    <div class="input-footer">
                        <span class="character-count" id="charCount">0/500</span>
                    </div>
                </div>
            </div>

            <!-- MEMBERS PANEL (ขวา) -->
            <div class="members-panel" id="membersPanel">
                <div class="members-header">
                    <h3>👥 สมาชิกในห้อง</h3>
                    <button onclick="window.toggleMembersPanel()" class="btn-icon">✕</button>
                </div>
                <div class="members-list" id="membersList"></div>
            </div>

            <!-- ACTIVITIES PANEL (กิจกรรม) -->
            <div class="activities-panel" id="activitiesPanel">
                <div class="activities-header">
                    <h3>🎮 กิจกรรมในห้อง</h3>
                    <button onclick="window.toggleActivitiesPanel()" class="btn-icon">✕</button>
                </div>
                
                <div class="create-activity-btn-container">
                    <button onclick="window.showCreateActivityModal()" class="btn btn-primary" style="width: 100%;">
                        ➕ สร้างกิจกรรม
                    </button>
                </div>
                
                <div class="activities-list" id="activitiesList">
                    <div style="text-align: center; padding: 40px 20px; color: #718096;">
                        🎮 ยังไม่มีกิจกรรม<br>
                        <small>คลิก "สร้างกิจกรรม" เพื่อเริ่มต้น</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SIDEBAR OVERLAY -->
    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <!-- ========== MODAL: อิโมจิ ========== -->
    <div id="emojiPickerModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                <span>😊</span> เลือกอิโมจิ
            </h3>
            <div class="emoji-grid" id="emojiGrid"></div>
            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button onclick="window.closeEmojiPicker()" class="btn btn-secondary" style="flex: 1;">ปิด</button>
            </div>
        </div>
    </div>

    <!-- ========== MODAL: สร้างห้อง ========== -->
    <div id="createRoomModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 24px;">📝 สร้างห้องใหม่</h2>
            <form id="createRoomForm">
                <div class="form-group">
                    <label>ชื่อห้อง <span style="color: #e53e3e;">*</span></label>
                    <input type="text" id="roomName" placeholder="เช่น ห้องเล่นเกม" required>
                </div>
                <div class="form-group">
                    <label>คำอธิบาย</label>
                    <textarea id="roomDescription" placeholder="รายละเอียดห้อง..." rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>ประเภทห้อง</label>
                    <select id="roomType" onchange="window.togglePasswordField()">
                        <option value="public">🌍 สาธารณะ - ทุกคนเข้าได้</option>
                        <option value="private">🔒 ส่วนตัว - ต้องใช้รหัสผ่าน</option>
                    </select>
                </div>
                <div id="passwordField" class="password-field">
                    <div class="form-group">
                        <label>รหัสผ่านห้อง</label>
                        <input type="password" id="roomPassword" placeholder="ตั้งรหัสผ่าน">
                    </div>
                    <div class="form-group">
                        <label>ยืนยันรหัสผ่าน</label>
                        <input type="password" id="confirmPassword" placeholder="พิมพ์รหัสผ่านอีกครั้ง">
                    </div>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">สร้างห้อง</button>
                    <button type="button" class="btn btn-secondary" onclick="window.closeCreateRoomModal()">ยกเลิก</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ========== MODAL: เข้าร่วมห้องส่วนตัว ========== -->
    <div id="joinPrivateRoomModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 24px;">🔐 เข้าร่วมห้องส่วนตัว</h2>
            <p id="joinRoomName" style="margin-bottom: 20px; font-weight: 600;"></p>
            <div class="form-group">
                <label>รหัสผ่านห้อง</label>
                <input type="password" id="joinRoomPassword" placeholder="กรอกรหัสผ่าน">
            </div>
            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button onclick="window.confirmJoinPrivateRoom()" class="btn btn-primary" style="flex: 1;">เข้าร่วม</button>
                <button onclick="window.closeJoinPrivateModal()" class="btn btn-secondary">ยกเลิก</button>
            </div>
        </div>
    </div>

    <!-- ========== MODAL: เตะสมาชิก ========== -->
    <div id="kickMemberModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 24px;">⚠️ เตะสมาชิก</h2>
            <p id="kickMemberName" style="margin-bottom: 20px;"></p>
            <p style="color: #718096; margin-bottom: 24px;">คุณแน่ใจหรือไม่ว่าต้องการเตะสมาชิกคนนี้ออกจากห้อง?</p>
            <div style="display: flex; gap: 12px;">
                <button onclick="window.confirmKickMember()" class="btn" style="flex: 1; background: #f56565; color: white;">เตะออก</button>
                <button onclick="window.closeKickModal()" class="btn btn-secondary">ยกเลิก</button>
            </div>
        </div>
    </div>

    <!-- ========== MODAL: ลบห้อง ========== -->
    <div id="deleteRoomModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 24px; color: #f56565;">⚠️ ลบห้อง</h2>
            <p id="deleteRoomName" style="margin-bottom: 20px; font-weight: 600;"></p>
            <p style="color: #718096; margin-bottom: 24px;">ข้อความและสมาชิกทั้งหมดจะถูกลบอย่างถาวร<br><strong>การดำเนินการนี้ไม่สามารถเรียกคืนได้!</strong></p>
            <div style="display: flex; gap: 12px;">
                <button onclick="window.confirmDeleteRoom()" class="btn" style="flex: 1; background: #f56565; color: white;">🗑️ ยืนยันการลบ</button>
                <button onclick="window.closeDeleteRoomModal()" class="btn btn-secondary" style="flex: 1;">ยกเลิก</button>
            </div>
        </div>
    </div>

    <!-- ========== MODAL: JITSI CALL ========== -->
    <div id="jitsiCallModal" class="modal" style="z-index: 2100;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="display: flex; align-items: center; gap: 8px;">
                    <span>📞</span> <span id="jitsiRoomName">ห้องสนทนา</span>
                </h3>
                <div style="display: flex; gap: 8px;">
                    <button onclick="window.copyCallLink()" class="btn btn-outline" style="padding: 6px 12px; font-size: 13px;">
                        🔗 แชร์ลิงก์
                    </button>
                    <button onclick="window.endCall()" class="btn-icon" style="font-size: 24px;">✕</button>
                </div>
            </div>
            <div id="jitsi-container"></div>
        </div>
    </div>

    <!-- ========== MODAL: สร้างกิจกรรม ========== -->
    <div id="createActivityModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                <span>🎮</span> สร้างกิจกรรมใหม่
            </h3>
            <form id="createActivityForm">
                <div class="form-group">
                    <label>ชื่อกิจกรรม <span style="color: #e53e3e;">*</span></label>
                    <input type="text" id="activityTitle" placeholder="เช่น ดูหนังด้วยกัน, เล่นเกม" required>
                </div>
                <div class="form-group">
                    <label>ประเภทกิจกรรม</label>
                    <select id="activityType" onchange="window.toggleActivityTypeFields()">
                        <option value="youtube">📺 ดู YouTube ด้วยกัน</option>
                        <option value="game">🎮 เล่นเกม</option>
                        <option value="poll">📊 โหวต</option>
                        <option value="custom">✨ กิจกรรมทั่วไป</option>
                    </select>
                </div>
                <div id="youtubeField" class="activity-field">
                    <div class="form-group">
                        <label>URL YouTube</label>
                        <input type="text" id="youtubeUrl" placeholder="https://youtube.com/watch?v=...">
                        <small>📌 รองรับ youtube.com และ youtu.be</small>
                    </div>
                </div>
                <div id="gameField" class="activity-field" style="display: none;">
                    <div class="form-group">
                        <label>ชื่อเกม</label>
                        <input type="text" id="gameName" placeholder="เช่น Among Us, Valorant">
                    </div>
                </div>
                <div id="pollField" class="activity-field" style="display: none;">
                    <div class="form-group">
                        <label>ตัวเลือก (คั่นด้วย ,)</label>
                        <input type="text" id="pollOptions" placeholder="ตัวเลือก1, ตัวเลือก2, ตัวเลือก3">
                    </div>
                </div>
                <div class="form-group">
                    <label>คำอธิบาย</label>
                    <textarea id="activityDescription" placeholder="รายละเอียดกิจกรรม..." rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>จำนวนผู้เข้าร่วมสูงสุด (0 = ไม่จำกัด)</label>
                    <input type="number" id="maxParticipants" value="0" min="0" max="50">
                </div>
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">สร้างกิจกรรม</button>
                    <button type="button" class="btn btn-secondary" onclick="window.closeCreateActivityModal()">ยกเลิก</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ========== YOUTUBE PLAYER MODAL ========== -->
    <div id="youtubePlayerModal" class="modal" style="z-index: 2100;">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="display: flex; align-items: center; gap: 8px;">
                    <span>📺</span> <span id="youtubeActivityTitle">YouTube</span>
                </h3>
                <button onclick="window.closeYoutubePlayer()" class="btn-icon" style="font-size: 24px;">✕</button>
            </div>
            <div id="youtubePlayerContainer">
                <div id="youtube-player"></div>
            </div>
            <div class="youtube-controls">
                <button onclick="window.syncPlayPause()" id="syncPlayPauseBtn" class="btn btn-primary" style="display: flex; align-items: center; gap: 4px;">▶️ เล่น</button>
                <button onclick="window.syncSeek(-10)" class="btn btn-secondary" style="display: flex; align-items: center; gap: 4px;">⏪ -10</button>
                <button onclick="window.syncSeek(10)" class="btn btn-secondary" style="display: flex; align-items: center; gap: 4px;">⏩ +10</button>
                <button onclick="window.syncRestart()" class="btn btn-secondary" style="display: flex; align-items: center; gap: 4px;">🔄 เริ่มใหม่</button>
            </div>
            <div id="youtubePlayerState" style="color: var(--text-light); font-size: 14px; text-align: center; margin-bottom: 12px;">⏸️ หยุด</div>
            <div class="activity-participants">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h4 style="display: flex; align-items: center; gap: 8px;">👥 ผู้เข้าร่วม <span id="youtubeParticipantsCount">(0)</span></h4>
                </div>
                <div id="youtubeParticipants" class="participants-list"></div>
            </div>
        </div>
    </div>

    <!-- ========== MUSIC PLAYER MODAL ========== -->
    <div id="musicPlayerModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                <span>🎵</span> เครื่องเล่นเพลง
            </h3>
            <div class="form-group">
                <label>URL เพลง (MP3 เท่านั้น)</label>
                <input type="text" id="musicUrlInput" placeholder="https://example.com/song.mp3">
                <small style="color: #e53e3e;">⚠️ รองรับเฉพาะไฟล์ .mp3 เท่านั้น</small>
            </div>
            <button onclick="window.addMusicToRoom()" class="btn btn-primary" style="width: 100%; margin-bottom: 20px;">➕ เพิ่มเพลง</button>
            <div class="music-playlist">
                <h4 style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">📋 เพลย์ลิสต์</h4>
                <div id="playlistItems" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button onclick="window.closeMusicPlayer()" class="btn btn-secondary" style="flex: 1;">ปิด</button>
            </div>
        </div>
    </div>

    <!-- ========== MUSIC BAR ========== -->
    <div id="currentMusicBar" class="music-bar" style="display: none;">
        <div class="music-info">
            <span class="music-icon">🎵</span>
            <span id="currentMusicTitle" class="music-title">กำลังเล่นเพลง...</span>
        </div>
        <div class="music-controls">
            <button onclick="window.togglePlayPause()" id="playPauseBtn" class="music-btn">⏸️</button>
            <button onclick="window.stopMusic()" class="music-btn">⏹️</button>
            <button onclick="window.hideMusicBar()" class="music-btn">✕</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="https://meet.jit.si/external_api.js"></script>
    <script src="supabase-client.js"></script>
    <script>
        // ========== GLOBAL VARIABLES ==========
        window.currentUser = null;
        window.currentRoom = null;
        window.currentRoomId = '00000000-0000-0000-0000-000000000000';
        window.messageSubscription = null;
        window.messagesContainer = document.getElementById('messagesContainer');
        window.messageInput = document.getElementById('messageInput');
        window.sendButton = document.getElementById('sendButton');
        window.isAdmin = false;
        window.isAdminMode = false;
        window.selectedMessages = new Set();
        window.selectedImageFile = null;
        window.currentMusic = null;
        window.audioPlayer = null;
        window.readReceiptObserver = null;
        window.readReceiptsSubscription = null;
        
        // YouTube Variables
        window.youtubePlayer = null;
        window.youtubeActivityId = null;
        window.youtubeSyncInterval = null;
        window.youtubeIsSeeking = false;
        window.activitiesSubscription = null;
        window.activitySyncSubscription = null;
        window.youtubeApiReady = false;
        window.youtubePlayerReady = false;
        window.pendingYoutubeActivity = null;

        // Long Press Variables
        window.longPressTimer = null;
        window.isSelectionMode = false;
        window.longPressThreshold = 500;

        // Call Variables
        window.jitsiApi = null;
        window.currentCallRoom = null;
        window.activeCall = {
            isActive: false,
            roomId: null,
            callRoom: null,
            participants: new Set()
        };
        window.callStatusSubscription = null;

        const PUBLIC_ROOM_ID = '00000000-0000-0000-0000-000000000000';
        const STORAGE_KEY = 'chat_last_room_id';
        
        const emojiList = ['😀','😃','😄','😁','😆','😅','😂','🤣','😊','😇','🙂','🙃','😉','😌','😍','🥰','😘','😗','😙','😚','😋','😛','😝','😜','🤪','🤨','🧐','🤓','😎','🥳','😏','😒','😞','😔','😟','😕','🙁','☹️','😣','😖','😫','😩','🥺','😢','😭','😤','😠','😡','🤬','🤯','😳','🥵','🥶','😱','😨','😰','😥','😓','🤗','🤔','🤭','🤫','🤥','😶','😐','😑','😬','🙄','😯','😦','😧','😮','😲','🥱','😴','🤤','😪','😵','🤐','🥴','🤢','🤮','🤧','😷','🤒','🤕','🤑','🤠','😈','👿','👹','👺','🤡','💩','👻','💀','☠️','👽','👾','🤖','🎃','😺','😸','😹','😻','😼','😽','🙀','😿','😾'];

        // ========== LONG PRESS SELECTION ==========
        window.startLongPress = function(messageId, element, event) {
            if (!event) return;
            event.preventDefault();
            event.stopPropagation();
            
            if (window.isSelectionMode) return;
            
            window.longPressTimer = setTimeout(() => {
                window.enterSelectionMode(messageId, element);
            }, window.longPressThreshold);
        };

        window.cancelLongPress = function(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            clearTimeout(window.longPressTimer);
        };

        window.enterSelectionMode = function(messageId, element) {
            if (window.isSelectionMode) return;
            
            console.log('✅ Enter selection mode');
            window.isSelectionMode = true;
            
            // Add class to container
            const container = document.querySelector('.messages-container');
            if (container) {
                container.classList.add('selection-mode');
            }
            
            // Show hint
            const hint = document.getElementById('selectionHint');
            if (hint) {
                hint.style.display = 'flex';
            }
            
            // Add checkboxes to all messages
            document.querySelectorAll('.message').forEach(msg => {
                if (!msg.querySelector('.message-checkbox')) {
                    const checkbox = document.createElement('div');
                    checkbox.className = 'message-checkbox';
                    checkbox.innerHTML = '<input type="checkbox">';
                    msg.insertBefore(checkbox, msg.firstChild);
                    
                    const chk = checkbox.querySelector('input[type="checkbox"]');
                    chk.addEventListener('change', function(e) {
                        e.stopPropagation();
                        const msgId = msg.dataset.messageId;
                        if (this.checked) {
                            window.selectedMessages.add(msgId);
                            msg.classList.add('selected');
                        } else {
                            window.selectedMessages.delete(msgId);
                            msg.classList.remove('selected');
                        }
                        window.updateDeleteButton();
                    });
                }
            });
            
            // Select the long-pressed message
            setTimeout(() => {
                const targetMsg = document.querySelector(`.message[data-message-id="${messageId}"]`);
                if (targetMsg) {
                    const chk = targetMsg.querySelector('.message-checkbox input');
                    if (chk) {
                        chk.checked = true;
                        window.selectedMessages.add(messageId);
                        targetMsg.classList.add('selected');
                        window.updateDeleteButton();
                    }
                }
            }, 50);
        };

        window.exitSelectionMode = function() {
            window.isSelectionMode = false;
            window.selectedMessages.clear();
            
            // Remove selection class
            document.querySelectorAll('.message').forEach(el => {
                el.classList.remove('selected');
                const checkbox = el.querySelector('.message-checkbox');
                if (checkbox) {
                    checkbox.remove();
                }
            });
            
            // Remove container class
            const container = document.querySelector('.messages-container');
            if (container) {
                container.classList.remove('selection-mode');
            }
            
            // Hide hint
            const hint = document.getElementById('selectionHint');
            if (hint) {
                hint.style.display = 'none';
            }
            
            // Hide delete button
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            if (deleteBtn) {
                deleteBtn.style.display = 'none';
            }
        };

        window.updateDeleteButton = function() {
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            if (!deleteBtn) return;
            
            if (window.selectedMessages.size > 0) {
                deleteBtn.style.display = 'flex';
                deleteBtn.innerHTML = `🗑️ ลบ ${window.selectedMessages.size} ข้อความ`;
            } else {
                deleteBtn.style.display = 'none';
                window.exitSelectionMode();
            }
        };

        // ========== YOUTUBE API ==========
        window.loadYouTubeAPI = function() {
            if (window.YT && window.YT.Player) {
                window.youtubeApiReady = true;
                return;
            }
            const tag = document.createElement('script');
            tag.id = 'youtube-iframe-api';
            tag.src = 'https://www.youtube.com/iframe_api';
            document.getElementsByTagName('script')[0].parentNode.insertBefore(tag, document.getElementsByTagName('script')[0]);
        };

        window.onYouTubeIframeAPIReady = function() {
            window.youtubeApiReady = true;
            if (window.pendingYoutubeActivity) {
                const { activityId, videoId } = window.pendingYoutubeActivity;
                window.pendingYoutubeActivity = null;
                window.openYoutubePlayer(activityId, videoId);
            }
        };

        // ========== YOUTUBE PLAYER ==========
        window.openYoutubePlayer = function(activityId, videoId) {
            if (!activityId || !videoId) {
                alert('ข้อมูลไม่ครบถ้วน');
                return;
            }
            
            const modal = document.getElementById('youtubePlayerModal');
            const container = document.getElementById('youtube-player');
            
            if (!modal || !container) {
                alert('ไม่พบ YouTube Player');
                return;
            }
            
            if (!window.youtubeApiReady) {
                window.pendingYoutubeActivity = { activityId, videoId };
                window.loadYouTubeAPI();
                alert('กำลังโหลด YouTube Player กรุณารอสักครู่...');
                return;
            }
            
            if (window.youtubePlayer) {
                try { window.youtubePlayer.destroy(); } catch (e) {}
                window.youtubePlayer = null;
            }
            
            container.innerHTML = '';
            container.style.position = 'absolute';
            container.style.top = '0';
            container.style.left = '0';
            container.style.width = '100%';
            container.style.height = '100%';
            
            const playerContainer = document.createElement('div');
            playerContainer.id = 'youtube-player-container';
            playerContainer.style.width = '100%';
            playerContainer.style.height = '100%';
            container.appendChild(playerContainer);
            
            modal.classList.add('active');
            window.youtubeActivityId = activityId;
            
            try {
                window.youtubePlayer = new YT.Player('youtube-player-container', {
                    height: '100%',
                    width: '100%',
                    videoId: videoId,
                    playerVars: {
                        'autoplay': 0,
                        'controls': 1,
                        'rel': 0,
                        'modestbranding': 1,
                        'enablejsapi': 1,
                        'origin': window.location.origin,
                        'playsinline': 1
                    },
                    events: {
                        'onReady': onPlayerReady,
                        'onStateChange': onPlayerStateChange,
                        'onError': onPlayerError
                    }
                });
            } catch (e) {
                alert('ไม่สามารถสร้าง YouTube Player ได้');
            }
            
            if (typeof window.loadActivityParticipants === 'function') {
                window.loadActivityParticipants(activityId);
            }
            if (typeof window.subscribeToActivitySync === 'function') {
                window.subscribeToActivitySync(activityId);
            }
        };

        window.closeYoutubePlayer = function() {
            const modal = document.getElementById('youtubePlayerModal');
            if (modal) modal.classList.remove('active');
            if (window.youtubePlayer) {
                try { window.youtubePlayer.destroy(); } catch (e) {}
                window.youtubePlayer = null;
            }
            window.youtubePlayerReady = false;
            window.youtubeActivityId = null;
            const container = document.getElementById('youtube-player');
            if (container) container.innerHTML = '';
        };

        function onPlayerReady(event) {
            window.youtubePlayerReady = true;
            window.youtubeIsSeeking = false;
        }

        function onPlayerStateChange(event) {
            if (!window.youtubePlayer) return;
            const state = event.data;
            if (!window.youtubeIsSeeking && state !== YT.PlayerState.BUFFERING) {
                syncStateToServer(state);
            }
        }

        function onPlayerError(event) {
            let msg = 'ไม่สามารถเล่นวิดีโอนี้ได้';
            if (event.data === 2) msg = '❌ Video ID ไม่ถูกต้อง';
            if (event.data === 5) msg = '❌ ไม่สามารถเล่น HTML5 player ได้';
            if (event.data === 100) msg = '❌ วิดีโอไม่พบหรือถูกลบ';
            if (event.data === 101 || event.data === 150) msg = '❌ ไม่ได้รับอนุญาตให้เล่น';
            alert(msg);
        }

        // ========== JITSI CALL ==========
        window.startCall = async function() {
            if (!window.currentRoomId) {
                alert('❌ กรุณาเลือกห้องก่อนโทร');
                return;
            }
            
            try {
                const callRoom = `chatapp-${window.currentRoomId}-${Date.now()}`;
                const modal = document.getElementById('jitsiCallModal');
                const roomEl = document.getElementById('jitsiRoomName');
                roomEl.textContent = `📞 ${window.currentRoom?.name || 'ประชุม'}`;
                modal.classList.add('active');
                
                await initJitsiCall(callRoom);
                
                await sendRealtimeNotification({
                    type: 'call_started',
                    roomId: window.currentRoomId,
                    callRoom: callRoom,
                    startedBy: window.currentUser.id,
                    startedByName: window.currentUser.user_metadata?.display_name || window.currentUser.user_metadata?.username || 'ผู้ใช้',
                    timestamp: new Date().toISOString()
                });
                
                subscribeToCallStatus(window.currentRoomId);
                
            } catch (error) {
                console.error('❌ Error starting call:', error);
                alert('ไม่สามารถเริ่มการโทรได้');
            }
        };

        async function initJitsiCall(callRoom) {
            return new Promise((resolve, reject) => {
                try {
                    const container = document.getElementById('jitsi-container');
                    container.innerHTML = '';
                    
                    const domain = 'meet.jit.si';
                    const options = {
                        roomName: callRoom,
                        width: '100%',
                        height: '100%',
                        parentNode: container,
                        configOverwrite: {
                            startWithAudioMuted: false,
                            startWithVideoMuted: false,
                            enableWelcomePage: false,
                            enableClosePage: false,
                            disableInviteFunctions: true,
                            prejoinPageEnabled: false,
                            resolution: 720
                        },
                        interfaceConfigOverwrite: {
                            TOOLBAR_BUTTONS: [
                                'microphone', 'camera', 'desktop', 'fullscreen',
                                'hangup', 'chat', 'settings', 'raisehand',
                                'videoquality', 'filmstrip', 'tileview'
                            ],
                            SHOW_JITSI_WATERMARK: false,
                            SHOW_WATERMARK_FOR_GUESTS: false,
                            DEFAULT_BACKGROUND: '#0a0a0a',
                            MOBILE_APP_PROMO: false,
                            TOOLBAR_ALWAYS_VISIBLE: true
                        },
                        userInfo: {
                            displayName: window.currentUser?.user_metadata?.display_name || 
                                        window.currentUser?.user_metadata?.username || 'ผู้ใช้',
                            email: window.currentUser?.email || ''
                        }
                    };
                    
                    window.jitsiApi = new JitsiMeetExternalAPI(domain, options);
                    
                    window.jitsiApi.addEventListeners({
                        readyToClose: () => endCall(),
                        videoConferenceJoined: () => {
                            window.activeCall.isActive = true;
                            window.activeCall.callRoom = callRoom;
                        },
                        participantJoined: (participant) => {
                            window.activeCall.participants.add(participant.id);
                            sendSystemMessage(`👤 ${participant.displayName} เข้าร่วมการโทร`);
                            updateParticipantsCount();
                        },
                        participantLeft: (participant) => {
                            window.activeCall.participants.delete(participant.id);
                            sendSystemMessage(`👤 ${participant.displayName} ออกจากการโทร`);
                            updateParticipantsCount();
                        }
                    });
                    
                    resolve();
                } catch (error) {
                    reject(error);
                }
            });
        }

        window.endCall = async function() {
            const modal = document.getElementById('jitsiCallModal');
            modal.classList.remove('active');
            
            if (window.jitsiApi) {
                window.jitsiApi.dispose();
                window.jitsiApi = null;
            }
            
            if (window.activeCall.isActive) {
                await sendSystemMessage(`การโทรสิ้นสุดลง`);
            }
            
            window.activeCall = {
                isActive: false,
                roomId: null,
                callRoom: null,
                participants: new Set()
            };
            window.currentCallRoom = null;
            
            const container = document.getElementById('jitsi-container');
            container.innerHTML = '';
        };

        window.copyCallLink = function() {
            if (!window.currentCallRoom) return;
            const url = `https://meet.jit.si/${window.currentCallRoom}`;
            navigator.clipboard.writeText(url).then(() => {
                alert('✅ คัดลอกลิงก์เชิญแล้ว');
            }).catch(() => {
                prompt('📋 คัดลอกลิงก์นี้:', url);
            });
        };

        window.joinCall = async function(callRoom) {
            if (!callRoom) return;
            
            if (window.activeCall.isActive) {
                if (!confirm('คุณกำลังอยู่ในการโทรอยู่แล้ว ต้องการออกจากการโทรเดิมและเข้าร่วมใหม่หรือไม่?')) {
                    return;
                }
                await endCall();
            }
            
            window.currentCallRoom = callRoom;
            const modal = document.getElementById('jitsiCallModal');
            modal.classList.add('active');
            await initJitsiCall(callRoom);
        };

        function updateParticipantsCount() {
            const count = window.activeCall.participants.size;
            const title = document.getElementById('jitsiRoomName');
            if (title) {
                title.innerHTML = `📞 ${window.currentRoom?.name || 'ประชุม'} <span style="font-size: 14px; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 12px;">${count} คน</span>`;
            }
        }

        async function sendRealtimeNotification(data) {
            if (!window.currentRoomId) return;
            try {
                await supabaseClient
                    .from('call_notifications')
                    .insert([{
                        room_id: window.currentRoomId,
                        call_data: data,
                        created_at: new Date().toISOString()
                    }]);
                    
                if (data.type === 'call_started') {
                    await sendSystemMessage(`📞 ${data.startedByName} เริ่มการโทร - คลิกปุ่ม 📞 เพื่อเข้าร่วม`);
                }
            } catch (error) {
                console.error('❌ Error sending notification:', error);
            }
        }

        function subscribeToCallStatus(roomId) {
            if (window.callStatusSubscription) {
                window.callStatusSubscription.unsubscribe();
            }
            
            window.callStatusSubscription = supabaseClient
                .channel(`call-status-${roomId}`)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'call_notifications',
                    filter: `room_id=eq.${roomId}`
                }, (payload) => {
                    const data = payload.new.call_data;
                    if (data.type === 'call_started' && data.startedBy !== window.currentUser.id) {
                        showCallNotification(data);
                    }
                })
                .subscribe();
        }

        function showCallNotification(data) {
            const toast = document.createElement('div');
            toast.className = 'call-toast';
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <span style="font-size: 24px;">📞</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${data.startedByName} เริ่มการโทร</div>
                        <div style="font-size: 12px; opacity: 0.9;">คลิกเพื่อเข้าร่วม</div>
                    </div>
                    <button onclick="window.joinCall('${data.callRoom}')" style="padding: 8px 16px; background: white; color: #667eea; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        เข้าร่วม
                    </button>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer;">✕</button>
                </div>
            `;
            
            toast.style.position = 'fixed';
            toast.style.top = '20px';
            toast.style.right = '20px';
            toast.style.zIndex = '9999';
            toast.style.animation = 'slideIn 0.3s ease';
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 10000);
        }

        window.sendSystemMessage = async function(text) {
            if (!window.currentRoomId) return;
            try {
                await supabaseClient.from('messages').insert([{
                    user_id: '00000000-0000-0000-0000-000000000000',
                    room_id: window.currentRoomId,
                    message: `📢 ${text}`,
                    created_at: new Date().toISOString()
                }]);
            } catch (error) {
                console.error('Error sending system message:', error);
            }
        };

        // ========== SYNC FUNCTIONS ==========
        async function syncStateToServer(state) {
            if (!window.youtubeActivityId || !window.youtubePlayer || !window.currentUser) return;
            try {
                const currentTime = window.youtubePlayer.getCurrentTime();
                await supabaseClient
                    .from('activity_sync')
                    .upsert({
                        activity_id: window.youtubeActivityId,
                        user_id: window.currentUser.id,
                        player_state: state,
                        playback_time: currentTime || 0,
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'activity_id,user_id' });
            } catch (error) {
                console.error('❌ Error syncing state:', error);
            }
        }

        window.subscribeToActivitySync = function(activityId) {
            if (window.activitySyncSubscription) {
                window.activitySyncSubscription.unsubscribe();
            }
            
            window.activitySyncSubscription = supabaseClient
                .channel(`activity-sync-${activityId}`)
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'activity_sync',
                    filter: `activity_id=eq.${activityId}`
                }, (payload) => {
                    if (!window.youtubePlayer || !window.youtubePlayerReady || payload.new.user_id === window.currentUser?.id) return;
                    
                    if (payload.new.player_state === YT.PlayerState.PLAYING) {
                        window.youtubePlayer.playVideo();
                    } else if (payload.new.player_state === YT.PlayerState.PAUSED) {
                        window.youtubePlayer.pauseVideo();
                    }
                    
                    if (!window.youtubeIsSeeking && payload.new.playback_time) {
                        const currentTime = window.youtubePlayer.getCurrentTime();
                        if (Math.abs(currentTime - payload.new.playback_time) > 2) {
                            window.youtubePlayer.seekTo(payload.new.playback_time, true);
                        }
                    }
                })
                .subscribe();
            
            return window.activitySyncSubscription;
        };

        window.syncPlayPause = function() {
            if (!window.youtubePlayer || !window.youtubePlayerReady) return;
            const state = window.youtubePlayer.getPlayerState();
            if (state === YT.PlayerState.PLAYING) {
                window.youtubePlayer.pauseVideo();
            } else {
                window.youtubePlayer.playVideo();
            }
        };

        window.syncSeek = function(seconds) {
            if (!window.youtubePlayer || !window.youtubePlayerReady) return;
            try {
                const time = window.youtubePlayer.getCurrentTime();
                window.youtubePlayer.seekTo(time + seconds, true);
            } catch (e) {}
        };

        window.syncRestart = function() {
            if (!window.youtubePlayer || !window.youtubePlayerReady) return;
            window.youtubePlayer.seekTo(0, true);
            window.youtubePlayer.playVideo();
        };

        // ========== DISPLAY MESSAGE ==========
        window.displayMessage = function(message) {
            if (!window.messagesContainer) return;
            
            if (message.is_deleted) {
                const deletedDiv = document.createElement('div');
                deletedDiv.className = 'message deleted-message';
                const deleterName = message.deleter?.display_name || message.deleter?.username || 'ระบบ';
                deletedDiv.innerHTML = `<div class="deleted-content"><span class="deleted-icon">🗑️</span><span class="deleted-text">${message.message || `ข้อความถูกลบโดย ${deleterName}`}</span><span class="deleted-time">${formatTime(message.deleted_at || message.created_at)}</span></div>`;
                window.messagesContainer.appendChild(deletedDiv);
                return;
            }
            
            const isOwnMessage = message.user_id === window.currentUser?.id;
            const author = message.profiles?.display_name || message.profiles?.username || 'ผู้ใช้';
            const avatarUrl = message.profiles?.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(author)}&background=667eea&color=fff`;
            
            let messageText = message.message || '';
            let imageHtml = '';
            const imageMatch = messageText.match(/\[IMAGE\](.*?)\[\/IMAGE\]/);
            if (imageMatch) {
                const imageUrl = imageMatch[1];
                imageHtml = `<img src="${imageUrl}" class="message-image" onclick="window.openLightbox('${imageUrl}')">`;
                messageText = messageText.replace(/\[IMAGE\].*?\[\/IMAGE\]/, '').trim();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isOwnMessage ? 'own-message' : ''}`;
            messageDiv.dataset.messageId = message.id;
            messageDiv.dataset.userId = message.user_id;
            
            // Long press events
            messageDiv.addEventListener('touchstart', (e) => window.startLongPress(message.id, messageDiv, e), { passive: false });
            messageDiv.addEventListener('touchend', (e) => window.cancelLongPress(e), { passive: false });
            messageDiv.addEventListener('touchmove', (e) => window.cancelLongPress(e), { passive: false });
            messageDiv.addEventListener('touchcancel', (e) => window.cancelLongPress(e), { passive: false });
            messageDiv.addEventListener('mousedown', (e) => {
                if (e.button === 0) window.startLongPress(message.id, messageDiv, e);
            });
            messageDiv.addEventListener('mouseup', (e) => window.cancelLongPress(e));
            messageDiv.addEventListener('mouseleave', (e) => window.cancelLongPress(e));
            
            // Click event for selection mode
            messageDiv.addEventListener('click', (e) => {
                if (window.isSelectionMode) {
                    e.preventDefault();
                    e.stopPropagation();
                    const checkbox = messageDiv.querySelector('.message-checkbox input');
                    if (checkbox) {
                        checkbox.checked = !checkbox.checked;
                        const event = new Event('change', { bubbles: true });
                        checkbox.dispatchEvent(event);
                    }
                }
            });
            
            const canDelete = window.isAdminMode || isOwnMessage;
            
            messageDiv.innerHTML = `
                <img src="${avatarUrl}" alt="${author}" class="message-avatar" 
                     onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(author)}&background=667eea&color=fff'">
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">${author}</span>
                        <span class="message-time">${formatTime(message.created_at)}</span>
                        ${canDelete ? `<button onclick="window.deleteSingleMessage('${message.id}', '${message.user_id}')" class="delete-message-btn">🗑️</button>` : ''}
                    </div>
                    ${messageText ? `<div class="message-body">${linkify(messageText)}</div>` : ''}
                    ${imageHtml}
                </div>
            `;
            
            window.messagesContainer.appendChild(messageDiv);
            
            if (isOwnMessage) {
                window.displayReadReceipts(messageDiv, message.id, true);
            }
            if (!isOwnMessage && window.readReceiptObserver) {
                window.readReceiptObserver.observe(messageDiv);
            }
            
            scrollToBottom();
        };

        // ========== DELETE MESSAGES ==========
        window.deleteSelectedMessages = async function() {
            if (window.selectedMessages.size === 0) return;
            
            if (!window.isAdminMode) {
                const messageIds = Array.from(window.selectedMessages);
                const { data: messages } = await supabaseClient.from('messages').select('user_id').in('id', messageIds);
                const hasOtherMessages = messages.some(msg => msg.user_id !== window.currentUser.id);
                if (hasOtherMessages) {
                    alert('❌ คุณสามารถลบได้เฉพาะข้อความของตัวเองเท่านั้น');
                    return;
                }
            }
            
            const confirmMsg = window.isAdminMode 
                ? `⚠️ คุณกำลังจะลบ ${window.selectedMessages.size} ข้อความ (ในฐานะแอดมิน)` 
                : `⚠️ คุณกำลังจะลบ ${window.selectedMessages.size} ข้อความของตัวเอง`;
                
            if (!confirm(confirmMsg + '\n\nดำเนินการต่อ?')) return;
            
            try {
                const messageIds = Array.from(window.selectedMessages);
                const { data: userData } = await supabaseClient.from('profiles').select('username, display_name').eq('id', window.currentUser.id).single();
                const deletedByName = userData?.display_name || userData?.username || (window.isAdminMode ? 'แอดมิน' : 'ผู้ใช้');
                
                const { error } = await supabaseClient.from('messages').update({
                    is_deleted: true,
                    deleted_by: window.currentUser.id,
                    deleted_at: new Date().toISOString(),
                    message: `[ข้อความถูกลบโดย ${deletedByName}]`
                }).in('id', messageIds);
                
                if (error) throw error;
                
                alert(`✅ ลบ ${messageIds.length} ข้อความสำเร็จ`);
                window.exitSelectionMode();
                await window.loadMessages(window.currentRoomId);
                
            } catch (error) {
                console.error('❌ Error deleting messages:', error);
                alert('ไม่สามารถลบข้อความได้: ' + error.message);
            }
        };

        window.deleteSingleMessage = async function(messageId, userId) {
            const canDelete = window.isAdminMode || userId === window.currentUser.id;
            if (!canDelete) {
                alert('❌ คุณไม่มีสิทธิ์ลบข้อความนี้');
                return;
            }
            if (!confirm('⚠️ ลบข้อความนี้?')) return;
            
            try {
                const { data: userData } = await supabaseClient.from('profiles').select('username, display_name').eq('id', window.currentUser.id).single();
                const deletedByName = userData?.display_name || userData?.username || (window.isAdminMode ? 'แอดมิน' : 'ผู้ใช้');
                
                const { error } = await supabaseClient.from('messages').update({
                    is_deleted: true,
                    deleted_by: window.currentUser.id,
                    deleted_at: new Date().toISOString(),
                    message: `[ข้อความถูกลบโดย ${deletedByName}]`
                }).eq('id', messageId);
                
                if (error) throw error;
                
                if (window.isSelectionMode) {
                    window.exitSelectionMode();
                }
                
                await window.loadMessages(window.currentRoomId);
                
            } catch (error) {
                console.error('❌ Error deleting message:', error);
                alert('ไม่สามารถลบข้อความได้');
            }
        };

        // ========== LOAD MESSAGES ==========
        window.loadMessages = async function(roomId) {
            try {
                if (!window.messagesContainer) window.messagesContainer = document.getElementById('messagesContainer');
                if (!window.messagesContainer) return;
                
                const { data: messages, error } = await supabaseClient.from('messages')
                    .select('*, profiles:user_id(username, display_name, avatar_url), deleter:deleted_by(username, display_name)')
                    .eq('room_id', roomId).order('created_at', { ascending: true }).limit(50);
                
                if (error) throw error;
                
                window.messagesContainer.innerHTML = '';
                
                if (window.readReceiptObserver) window.readReceiptObserver.disconnect();
                window.setupReadReceiptObserver();
                
                if (messages.length === 0) {
                    window.messagesContainer.innerHTML = '<div style="text-align: center; padding: 50px; color: #a0aec0;">💬 ยังไม่มีข้อความ<br><small>เริ่มต้นแชทกันเลย!</small></div>';
                } else {
                    messages.forEach(msg => window.displayMessage(msg));
                }
                
                window.exitSelectionMode();
                scrollToBottom();
            } catch (error) {
                console.error('❌ Error loading messages:', error);
            }
        };

        // ========== SEND MESSAGE ==========
        window.sendMessage = async function() {
            const messageInput = document.getElementById('messageInput');
            if (!messageInput) return;
            const message = messageInput.value.trim();
            const hasImage = window.selectedImageFile !== null;
            if (!message && !hasImage) return;
            if (!window.currentRoomId) {
                alert('❌ กรุณาเลือกห้องก่อนส่งข้อความ');
                return;
            }
            
            try {
                let imageUrl = null;
                if (hasImage) {
                    const fileExt = window.selectedImageFile.name.split('.').pop();
                    const fileName = `${window.currentUser.id}/${Date.now()}.${fileExt}`;
                    const { error: uploadError } = await supabaseClient.storage.from('chat_files').upload(fileName, window.selectedImageFile);
                    if (uploadError) throw uploadError;
                    const { data: { publicUrl } } = supabaseClient.storage.from('chat_files').getPublicUrl(fileName);
                    imageUrl = publicUrl;
                }
                
                const messageText = imageUrl ? `${message} [IMAGE]${imageUrl}[/IMAGE]` : message;
                
                const { error } = await supabaseClient.from('messages').insert([{
                    user_id: window.currentUser.id,
                    room_id: window.currentRoomId,
                    message: messageText,
                    created_at: new Date().toISOString()
                }]);
                
                if (error) throw error;
                
                messageInput.value = '';
                window.clearImagePreview();
                
                const charCount = document.getElementById('charCount');
                if (charCount) charCount.textContent = '0/500';
            } catch (error) {
                console.error('❌ Error sending message:', error);
                alert('ไม่สามารถส่งข้อความได้: ' + error.message);
            }
        };

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                window.messagesContainer = document.getElementById('messagesContainer');
                window.messageInput = document.getElementById('messageInput');
                window.sendButton = document.getElementById('sendButton');

                window.currentUser = await checkUser();
                if (!window.currentUser) {
                    window.location.href = 'login.html';
                    return;
                }

                await checkAdminStatus();
                displayUserInfo();
                await loadRooms();
                
                const lastRoomId = localStorage.getItem(STORAGE_KEY);
                const initialRoomId = lastRoomId || PUBLIC_ROOM_ID;
                
                await selectRoom(initialRoomId);
                await loadOnlineUsers();
                setupEventListeners();
                initMobileHandler();
                
                setTimeout(() => window.loadYouTubeAPI(), 1000);

                const overlay = document.getElementById('sidebarOverlay');
                if (overlay) {
                    overlay.addEventListener('click', window.closeMobileSidebar);
                }

                console.log('✅ Chat initialized');
            } catch (error) {
                console.error('❌ Init error:', error);
            }
        });

        // ========== MOBILE SIDEBAR ==========
        window.toggleMobileSidebar = function() {
            const sidebar = document.querySelector('.rooms-panel');
            const overlay = document.getElementById('sidebarOverlay');
            if (!sidebar) return;
            sidebar.classList.toggle('mobile-active');
            if (overlay) {
                overlay.classList.toggle('active', sidebar.classList.contains('mobile-active'));
            }
            document.body.style.overflow = sidebar.classList.contains('mobile-active') ? 'hidden' : '';
        };

        window.closeMobileSidebar = function() {
            const sidebar = document.querySelector('.rooms-panel');
            const overlay = document.getElementById('sidebarOverlay');
            if (sidebar) sidebar.classList.remove('mobile-active');
            if (overlay) overlay.classList.remove('active');
            document.body.style.overflow = '';
        };

        window.initMobileHandler = function() {
            if (!/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) return;
            let originalHeight = window.innerHeight;
            window.addEventListener('resize', () => {
                const newHeight = window.innerHeight;
                if (originalHeight - newHeight > 150) {
                    document.body.classList.add('keyboard-open');
                    setTimeout(() => {
                        if (window.messageInput) {
                            window.messageInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 300);
                } else {
                    document.body.classList.remove('keyboard-open');
                }
            });
        };

        // ========== PANEL CONTROLS ==========
        window.toggleMembersPanel = function() {
            const panel = document.getElementById('membersPanel');
            if (panel) panel.classList.toggle('active');
        };

        window.toggleActivitiesPanel = function() {
            const panel = document.getElementById('activitiesPanel');
            if (panel) {
                panel.classList.toggle('active');
                if (panel.classList.contains('active')) {
                    window.loadActivities();
                }
            }
        };
        // ========== LOAD ROOMS ==========
        window.loadRooms = async function(filter = 'all') {
            try {
                let query = supabaseClient.from('rooms')
                    .select('*, owner:owner_id(username, display_name), room_members(user_id, role)')
                    .order('created_at', { ascending: false });
                
                if (filter === 'public') query = query.eq('room_type', 'public');
                else if (filter === 'private') query = query.eq('room_type', 'private');
                
                const { data: rooms, error } = await query;
                if (error) throw error;
                displayRooms(rooms);
            } catch (error) {
                console.error('❌ Error loading rooms:', error);
            }
        };

        window.displayRooms = function(rooms) {
            const roomList = document.getElementById('roomList');
            if (!roomList) return;
            if (rooms.length === 0) {
                roomList.innerHTML = '<div style="text-align: center; padding: 40px 20px; color: #a0aec0;">📭 ยังไม่มีห้องแชท<br><small>คลิก "สร้างห้องใหม่" เพื่อเริ่มต้น</small></div>';
                return;
            }
            roomList.innerHTML = rooms.map(room => {
                const isOwner = room.owner_id === window.currentUser?.id;
                const memberCount = room.room_members?.length || 0;
                const isActive = window.currentRoomId === room.id;
                return `<div class="room-item ${isActive ? 'active' : ''}" onclick="window.selectRoom('${room.id}')">
                    <div class="room-header">
                        <span class="room-name">${room.room_type === 'private' ? '🔒' : '🌍'} ${room.name}</span>
                        <span class="room-type-badge">${room.room_type === 'private' ? 'ส่วนตัว' : 'สาธารณะ'}</span>
                    </div>
                    <div class="room-meta">
                        <span>👤 ${room.owner?.display_name || 'ไม่มีเจ้าของ'}</span>
                        <span>👥 ${memberCount} คน</span>
                        ${isOwner ? '<span style="color: #48bb78;">👑 เจ้าของ</span>' : ''}
                    </div>
                    ${room.description ? `<small style="color: #718096;">${room.description}</small>` : ''}
                </div>`;
            }).join('');
        };

        // ========== SELECT ROOM ==========
        window.selectRoom = async function(roomId) {
            window.closeMobileSidebar();
            try {
                const { data: room, error } = await supabaseClient.from('rooms').select('*').eq('id', roomId).single();
                if (error) throw error;
                
                if (room.room_type === 'private') {
                    const { data: member } = await supabaseClient.from('room_members').select('*').eq('room_id', roomId).eq('user_id', window.currentUser.id).maybeSingle();
                    if (!member && room.owner_id !== window.currentUser.id && !window.isAdmin) {
                        showJoinPrivateModal(room);
                        return;
                    }
                }
                
                await joinRoom(room);
            } catch (error) {
                console.error('❌ Error selecting room:', error);
            }
        };

        // ========== JOIN ROOM ==========
        window.joinRoom = async function(room) {
            try {
                const { data: existingMember } = await supabaseClient.from('room_members').select('*').eq('room_id', room.id).eq('user_id', window.currentUser.id).maybeSingle();
                if (!existingMember && !window.isAdmin) {
                    await supabaseClient.from('room_members').insert([{
                        room_id: room.id,
                        user_id: window.currentUser.id,
                        role: room.owner_id === window.currentUser.id ? 'owner' : 'member',
                        joined_at: new Date().toISOString()
                    }]);
                }
                
                window.currentRoom = room;
                window.currentRoomId = room.id;
                
                localStorage.setItem(STORAGE_KEY, room.id);
                
                document.getElementById('currentRoomTitle').innerHTML = `${room.room_type === 'private' ? '🔒' : '💬'} ${room.name}`;
                document.getElementById('currentRoomTypeBadge').textContent = room.room_type === 'private' ? 'ส่วนตัว' : 'สาธารณะ';
                
                const roomActions = document.getElementById('roomActions');
                roomActions.innerHTML = '';
                if (room.owner_id === window.currentUser.id && room.id !== PUBLIC_ROOM_ID) {
                    roomActions.innerHTML += `<button onclick="window.showDeleteRoomModal()" class="delete-room-btn">🗑️ ลบห้อง</button>`;
                }
                if (window.isAdmin && room.id !== PUBLIC_ROOM_ID) {
                    roomActions.innerHTML += `<button onclick="window.adminDeleteRoom('${room.id}', '${room.name}')" class="admin-delete-room-btn">👑 ลบห้อง (แอดมิน)</button>`;
                }
                
                document.getElementById('messageInputArea').style.display = 'block';
                
                await loadMessages(room.id);
                await loadRoomMembers(room.id);
                await loadActivities();
                setupMessageSubscription(room.id);
                setupActivitiesSubscription(room.id);
                
                if (window.readReceiptsSubscription) window.readReceiptsSubscription.unsubscribe();
                window.readReceiptsSubscription = window.subscribeToReadReceipts(room.id);
                
                loadRooms();
            } catch (error) {
                console.error('❌ Error joining room:', error);
            }
        };

        // ========== MESSAGES ==========
        window.loadMessages = async function(roomId) {
            try {
                if (!window.messagesContainer) window.messagesContainer = document.getElementById('messagesContainer');
                if (!window.messagesContainer) return;
                
                const { data: messages, error } = await supabaseClient.from('messages')
                    .select('*, profiles:user_id(username, display_name, avatar_url), deleter:deleted_by(username, display_name)')
                    .eq('room_id', roomId).order('created_at', { ascending: true }).limit(50);
                
                if (error) throw error;
                
                window.messagesContainer.innerHTML = '';
                window.clearSelectedMessages();
                
                if (window.readReceiptObserver) window.readReceiptObserver.disconnect();
                window.setupReadReceiptObserver();
                
                if (messages.length === 0) {
                    window.messagesContainer.innerHTML = '<div style="text-align: center; padding: 50px; color: #a0aec0;">💬 ยังไม่มีข้อความ<br><small>เริ่มต้นแชทกันเลย!</small></div>';
                } else {
                    messages.forEach(msg => displayMessage(msg));
                }
                
                scrollToBottom();
            } catch (error) {
                console.error('❌ Error loading messages:', error);
            }
        };

        // ========== DISPLAY MESSAGE ==========
        window.displayMessage = function(message) {
            if (!window.messagesContainer) return;
            if (message.is_deleted) {
                const deletedDiv = document.createElement('div');
                deletedDiv.className = 'message deleted-message';
                const deleterName = message.deleter?.display_name || message.deleter?.username || 'ระบบ';
                deletedDiv.innerHTML = `<div class="deleted-content"><span class="deleted-icon">🗑️</span><span class="deleted-text">${message.message || `ข้อความถูกลบโดย ${deleterName}`}</span><span class="deleted-time">${formatTime(message.deleted_at || message.created_at)}</span></div>`;
                window.messagesContainer.appendChild(deletedDiv);
                return;
            }
            
            const isOwnMessage = message.user_id === window.currentUser?.id;
            const author = message.profiles?.display_name || message.profiles?.username || 'ผู้ใช้';
            const avatarUrl = message.profiles?.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(author)}&background=667eea&color=fff`;
            
            let messageText = message.message || '';
            let imageHtml = '';
            const imageMatch = messageText.match(/\[IMAGE\](.*?)\[\/IMAGE\]/);
            if (imageMatch) {
                const imageUrl = imageMatch[1];
                imageHtml = `<img src="${imageUrl}" class="message-image" onclick="window.openLightbox('${imageUrl}')">`;
                messageText = messageText.replace(/\[IMAGE\].*?\[\/IMAGE\]/, '').trim();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isOwnMessage ? 'own-message' : ''}`;
            messageDiv.dataset.messageId = message.id;
            messageDiv.dataset.userId = message.user_id;
            
            const canSelect = window.isAdminMode || isOwnMessage;
            const canDelete = window.isAdminMode || isOwnMessage;
            
            messageDiv.innerHTML = `
                ${canSelect ? `<div class="message-checkbox" onclick="event.stopPropagation()"><input type="checkbox" onchange="window.toggleSelectMessage('${message.id}', this.closest('.message'))"></div>` : ''}
                <img src="${avatarUrl}" alt="${author}" class="message-avatar" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(author)}&background=667eea&color=fff'">
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">${author}</span>
                        <span class="message-time">${formatTime(message.created_at)}</span>
                        ${canDelete ? `<button onclick="window.deleteSingleMessage('${message.id}', '${message.user_id}')" class="delete-message-btn">🗑️</button>` : ''}
                    </div>
                    ${messageText ? `<div class="message-body">${linkify(messageText)}</div>` : ''}
                    ${imageHtml}
                </div>
            `;
            
            window.messagesContainer.appendChild(messageDiv);
            if (isOwnMessage) window.displayReadReceipts(messageDiv, message.id, true);
            if (!isOwnMessage && window.readReceiptObserver) window.readReceiptObserver.observe(messageDiv);
            scrollToBottom();
        };

        // ========== SEND MESSAGE ==========
        window.sendMessage = async function() {
            const messageInput = document.getElementById('messageInput');
            if (!messageInput) return;
            const message = messageInput.value.trim();
            const hasImage = window.selectedImageFile !== null;
            if (!message && !hasImage) return;
            if (!window.currentRoomId) { 
                alert('❌ กรุณาเลือกห้องก่อนส่งข้อความ'); 
                return; 
            }
            
            try {
                let imageUrl = null;
                if (hasImage) {
                    const fileExt = window.selectedImageFile.name.split('.').pop();
                    const fileName = `${window.currentUser.id}/${Date.now()}.${fileExt}`;
                    const { error: uploadError } = await supabaseClient.storage.from('chat_files').upload(fileName, window.selectedImageFile);
                    if (uploadError) throw uploadError;
                    const { data: { publicUrl } } = supabaseClient.storage.from('chat_files').getPublicUrl(fileName);
                    imageUrl = publicUrl;
                }
                const messageText = imageUrl ? `${message} [IMAGE]${imageUrl}[/IMAGE]` : message;
                const { error } = await supabaseClient.from('messages').insert([{
                    user_id: window.currentUser.id,
                    room_id: window.currentRoomId,
                    message: messageText,
                    created_at: new Date().toISOString()
                }]);
                if (error) throw error;
                messageInput.value = '';
                window.clearImagePreview();
                const charCount = document.getElementById('charCount');
                if (charCount) charCount.textContent = '0/500';
            } catch (error) {
                console.error('❌ Error sending message:', error);
                alert('ไม่สามารถส่งข้อความได้: ' + error.message);
            }
        };

        // ========== DELETE MESSAGES ==========
        window.deleteSingleMessage = async function(messageId, userId) {
            const canDelete = window.isAdminMode || userId === window.currentUser.id;
            if (!canDelete) { alert('❌ คุณไม่มีสิทธิ์ลบข้อความนี้'); return; }
            if (!confirm('⚠️ ลบข้อความนี้?')) return;
            try {
                const { data: userData } = await supabaseClient.from('profiles').select('username, display_name').eq('id', window.currentUser.id).single();
                const deletedByName = userData?.display_name || userData?.username || (window.isAdminMode ? 'แอดมิน' : 'ผู้ใช้');
                const { error } = await supabaseClient.from('messages').update({
                    is_deleted: true,
                    deleted_by: window.currentUser.id,
                    deleted_at: new Date().toISOString(),
                    message: `[ข้อความถูกลบโดย ${deletedByName}]`
                }).eq('id', messageId);
                if (error) throw error;
                await window.loadMessages(window.currentRoomId);
            } catch (error) { console.error('❌ Error deleting message:', error); alert('ไม่สามารถลบข้อความได้'); }
        };

        window.deleteSelectedMessages = async function() {
            if (window.selectedMessages.size === 0) return;
            if (!window.isAdminMode) {
                const messageIds = Array.from(window.selectedMessages);
                const { data: messages } = await supabaseClient.from('messages').select('user_id').in('id', messageIds);
                const hasOtherMessages = messages.some(msg => msg.user_id !== window.currentUser.id);
                if (hasOtherMessages) { alert('❌ คุณสามารถลบได้เฉพาะข้อความของตัวเองเท่านั้น'); return; }
            }
            const confirmMsg = window.isAdminMode ? `⚠️ คุณกำลังจะลบ ${window.selectedMessages.size} ข้อความ (ในฐานะแอดมิน)` : `⚠️ คุณกำลังจะลบ ${window.selectedMessages.size} ข้อความของตัวเอง`;
            if (!confirm(confirmMsg + '\n\nดำเนินการต่อ?')) return;
            try {
                const messageIds = Array.from(window.selectedMessages);
                const { data: userData } = await supabaseClient.from('profiles').select('username, display_name').eq('id', window.currentUser.id).single();
                const deletedByName = userData?.display_name || userData?.username || (window.isAdminMode ? 'แอดมิน' : 'ผู้ใช้');
                const { error } = await supabaseClient.from('messages').update({
                    is_deleted: true,
                    deleted_by: window.currentUser.id,
                    deleted_at: new Date().toISOString(),
                    message: `[ข้อความถูกลบโดย ${deletedByName}]`
                }).in('id', messageIds);
                if (error) throw error;
                alert(`✅ ลบ ${messageIds.length} ข้อความสำเร็จ`);
                window.clearSelectedMessages();
                await window.loadMessages(window.currentRoomId);
            } catch (error) { console.error('❌ Error deleting messages:', error); alert('ไม่สามารถลบข้อความได้: ' + error.message); }
        };

        window.toggleSelectMessage = function(messageId, element) {
            if (window.selectedMessages.has(messageId)) { window.selectedMessages.delete(messageId); element.classList.remove('selected'); }
            else { window.selectedMessages.add(messageId); element.classList.add('selected'); }
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            if (deleteSelectedBtn) {
                deleteSelectedBtn.style.display = window.selectedMessages.size > 0 ? 'flex' : 'none';
                deleteSelectedBtn.innerHTML = `🗑️ ลบ ${window.selectedMessages.size} ข้อความ`;
            }
        };

        window.clearSelectedMessages = function() {
            window.selectedMessages.clear();
            document.querySelectorAll('.message.selected').forEach(el => el.classList.remove('selected'));
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            if (deleteSelectedBtn) deleteSelectedBtn.style.display = 'none';
        };

        // ========== EMOJI ==========
        window.openEmojiPicker = function() {
            const modal = document.getElementById('emojiPickerModal');
            const grid = document.getElementById('emojiGrid');
            if (!modal || !grid) return;
            grid.innerHTML = emojiList.map(emoji => `<div class="emoji-item" onclick="window.insertEmoji('${emoji}')">${emoji}</div>`).join('');
            modal.classList.add('active');
        };
        window.closeEmojiPicker = function() { const modal = document.getElementById('emojiPickerModal'); if (modal) modal.classList.remove('active'); };
        window.insertEmoji = function(emoji) { const input = document.getElementById('messageInput'); if (input) { input.value += emoji; input.focus(); window.closeEmojiPicker(); } };

        // ========== IMAGE ==========
        window.uploadImage = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    window.selectedImageFile = file;
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById('imagePreview');
                        const img = document.getElementById('previewImg');
                        if (preview && img) { img.src = e.target.result; preview.style.display = 'inline-block'; }
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        };
        window.clearImagePreview = function() {
            window.selectedImageFile = null;
            const preview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            if (preview) preview.style.display = 'none';
            if (previewImg) previewImg.src = '';
        };

        // ========== LIGHTBOX ==========
        window.openLightbox = function(imageUrl) {
            const lightbox = document.createElement('div');
            lightbox.className = 'lightbox';
            lightbox.onclick = function() { document.body.removeChild(lightbox); };
            const img = document.createElement('img');
            img.src = imageUrl;
            const closeBtn = document.createElement('span');
            closeBtn.className = 'lightbox-close';
            closeBtn.innerHTML = '✕';
            closeBtn.onclick = function(e) { e.stopPropagation(); document.body.removeChild(lightbox); };
            lightbox.appendChild(img);
            lightbox.appendChild(closeBtn);
            document.body.appendChild(lightbox);
        };

        // ========== READ RECEIPTS ==========
        window.markAsRead = async function(messageId, roomId) {
            if (!window.currentUser || !messageId || !roomId || messageId === 'undefined') return;
            try {
                const { data: existing } = await supabaseClient.from('read_receipts').select('id').eq('message_id', messageId).eq('user_id', window.currentUser.id).maybeSingle();
                if (!existing) {
                    await supabaseClient.from('read_receipts').insert([{
                        message_id: messageId,
                        user_id: window.currentUser.id,
                        room_id: roomId,
                        read_at: new Date().toISOString()
                    }]);
                }
            } catch (error) { console.error('❌ Error marking as read:', error); }
        };

        window.getReadReceipts = async function(messageId) {
            try {
                const { data, error } = await supabaseClient.from('read_receipts')
                    .select('user_id, read_at, profiles:user_id(username, display_name, avatar_url)')
                    .eq('message_id', messageId).order('read_at', { ascending: true });
                if (error) throw error;
                return data || [];
            } catch (error) { console.error('❌ Error getting read receipts:', error); return []; }
        };

        window.displayReadReceipts = async function(messageDiv, messageId, isOwnMessage) {
            if (!isOwnMessage || !messageDiv || !messageId) return;
            const receipts = await window.getReadReceipts(messageId);
            if (receipts.length === 0) return;
            const otherReaders = receipts.filter(r => r.user_id !== window.currentUser.id);
            if (otherReaders.length === 0) return;
            let readByContainer = messageDiv.querySelector('.read-by-container');
            if (readByContainer) readByContainer.remove();
            readByContainer = document.createElement('div');
            readByContainer.className = 'read-by-container';
            otherReaders.slice(0, 5).forEach(reader => {
                const avatar = document.createElement('img');
                avatar.src = reader.profiles?.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(reader.profiles?.display_name || reader.profiles?.username)}&background=667eea&color=fff`;
                avatar.alt = reader.profiles?.display_name || reader.profiles?.username || 'ผู้ใช้';
                avatar.className = 'read-by-avatar';
                avatar.title = `${reader.profiles?.display_name || reader.profiles?.username} อ่านเมื่อ ${window.formatTime(reader.read_at)}`;
                readByContainer.appendChild(avatar);
            });
            if (otherReaders.length > 5) {
                const more = document.createElement('span');
                more.className = 'read-by-more';
                more.textContent = `+${otherReaders.length - 5}`;
                more.title = `${otherReaders.length} คนอ่านแล้ว`;
                readByContainer.appendChild(more);
            }
            const readIcon = document.createElement('span');
            readIcon.className = 'read-icon';
            readIcon.innerHTML = '✓✓';
            readIcon.title = `อ่านแล้ว ${otherReaders.length} คน`;
            readByContainer.prepend(readIcon);
            const messageContent = messageDiv.querySelector('.message-content');
            if (messageContent) messageContent.appendChild(readByContainer);
        };

        window.setupReadReceiptObserver = function() {
            window.readReceiptObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const messageDiv = entry.target;
                        const messageId = messageDiv.dataset.messageId;
                        const roomId = window.currentRoomId;
                        if (messageId && roomId && messageId !== 'undefined' && messageDiv.dataset.userId !== window.currentUser.id) {
                            window.markAsRead(messageId, roomId);
                        }
                    }
                });
            }, { threshold: 0.5, rootMargin: '0px' });
        };

        window.subscribeToReadReceipts = function(roomId) {
            return supabaseClient.channel(`read-receipts-${roomId}`)
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'read_receipts', filter: `room_id=eq.${roomId}` }, async (payload) => {
                    const messageDiv = document.querySelector(`[data-message-id="${payload.new.message_id}"]`);
                    if (messageDiv && messageDiv.dataset.userId === window.currentUser.id) {
                        const oldContainer = messageDiv.querySelector('.read-by-container');
                        if (oldContainer) oldContainer.remove();
                        await window.displayReadReceipts(messageDiv, payload.new.message_id, true);
                    }
                }).subscribe();
        };

        // ========== ROOM MEMBERS ==========
        window.loadRoomMembers = async function(roomId) {
            try {
                const { data: members, error } = await supabaseClient.from('room_members')
                    .select('user_id, role, joined_at, profiles:user_id(username, display_name, avatar_url, is_admin)')
                    .eq('room_id', roomId);
                if (error) throw error;
                displayRoomMembers(members);
            } catch (error) { console.error('❌ Error loading members:', error); }
        };

        window.displayRoomMembers = function(members) {
            const container = document.getElementById('membersList');
            if (!container) return;
            const isOwner = window.currentRoom?.owner_id === window.currentUser.id;
            container.innerHTML = members.map(member => {
                const profile = member.profiles;
                const isCurrentUser = member.user_id === window.currentUser.id;
                const canKick = (isOwner || window.isAdmin) && !isCurrentUser && member.role !== 'owner';
                return `<div class="member-item">
                    <img src="${profile?.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(profile?.display_name || profile?.username)}&background=667eea&color=fff`}" alt="${profile?.display_name}" class="member-avatar">
                    <div class="member-info">
                        <div class="member-name">${profile?.display_name || profile?.username}${isCurrentUser ? ' (คุณ)' : ''}${profile?.is_admin ? ' 👑' : ''}</div>
                        <div class="member-role">${member.role === 'owner' ? '👑 เจ้าของห้อง' : '👤 สมาชิก'}</div>
                    </div>
                    ${canKick ? `<button class="kick-btn" onclick="window.showKickModal('${member.user_id}', '${profile?.display_name || profile?.username}')">เตะออก</button>` : ''}
                </div>`;
            }).join('');
        };

        // ========== KICK MEMBER ==========
        window.kickMemberId = null;
        window.showKickModal = function(userId, username) {
            window.kickMemberId = userId;
            const modal = document.getElementById('kickMemberModal');
            const nameEl = document.getElementById('kickMemberName');
            if (nameEl) nameEl.textContent = `ต้องการเตะ "${username}" ออกจากห้อง?`;
            if (modal) modal.classList.add('active');
        };
        window.closeKickModal = function() {
            window.kickMemberId = null;
            const modal = document.getElementById('kickMemberModal');
            if (modal) modal.classList.remove('active');
        };
        window.confirmKickMember = async function() {
            if (!window.kickMemberId || !window.currentRoomId) return;
            try {
                const { error } = await supabaseClient.from('room_members').delete().eq('room_id', window.currentRoomId).eq('user_id', window.kickMemberId);
                if (error) throw error;
                alert('✅ เตะสมาชิกออกจากห้องแล้ว');
                window.closeKickModal();
                await window.loadRoomMembers(window.currentRoomId);
            } catch (error) { console.error('❌ Error kicking member:', error); alert('ไม่สามารถเตะสมาชิกได้'); }
        };

        // ========== ADMIN FUNCTIONS ==========
        window.checkAdminStatus = async function() {
            try {
                if (!window.currentUser) return false;
                const { data, error } = await supabaseClient.from('profiles').select('is_admin').eq('id', window.currentUser.id).single();
                if (error) throw error;
                window.isAdmin = data?.is_admin || false;
                const adminBtn = document.getElementById('adminModeBtn');
                if (adminBtn) adminBtn.style.display = window.isAdmin ? 'inline-block' : 'none';
                return window.isAdmin;
            } catch (error) { return false; }
        };

        window.toggleAdminMode = async function() {
            if (!window.isAdmin) { alert('คุณไม่ใช่แอดมิน'); return; }
            window.isAdminMode = !window.isAdminMode;
            const adminBtn = document.getElementById('adminModeBtn');
            if (adminBtn) {
                adminBtn.innerHTML = window.isAdminMode ? '👑 แอดมิน (เปิด)' : '👑 แอดมิน (ปิด)';
                adminBtn.classList.toggle('active', window.isAdminMode);
            }
            await window.loadMessages(window.currentRoomId);
            alert(window.isAdminMode ? '✅ โหมดแอดมินเปิดใช้งาน' : '❌ โหมดแอดมินปิดใช้งาน');
        };

        window.adminDeleteRoom = async function(roomId, roomName) {
            if (!window.isAdmin) { alert('เฉพาะแอดมินเท่านั้นที่ลบห้องนี้ได้'); return; }
            if (!confirm(`⚠️ คุณกำลังจะลบห้อง "${roomName}" ในฐานะแอดมิน\n\nข้อความและสมาชิกทั้งหมดจะถูกลบ!\n\nดำเนินการต่อ?`)) return;
            try {
                const { error } = await supabaseClient.from('rooms').delete().eq('id', roomId);
                if (error) throw error;
                alert('✅ ลบห้องสำเร็จ');
                if (window.currentRoomId === roomId) {
                    await window.selectRoom(PUBLIC_ROOM_ID);
                } else {
                    await window.loadRooms();
                }
            } catch (error) { console.error('❌ Error deleting room:', error); alert('ไม่สามารถลบห้องได้: ' + error.message); }
        };

        // ========== DELETE ROOM (OWNER) ==========
        window.showDeleteRoomModal = function() {
            if (!window.currentRoom) return;
            document.getElementById('deleteRoomName').innerHTML = `ต้องการลบห้อง: <strong>${window.currentRoom.name}</strong>?`;
            document.getElementById('deleteRoomModal').classList.add('active');
        };
        window.closeDeleteRoomModal = function() { document.getElementById('deleteRoomModal').classList.remove('active'); };
        window.confirmDeleteRoom = async function() {
            if (!window.currentRoomId || window.currentRoomId === PUBLIC_ROOM_ID) { alert('ไม่สามารถลบห้องสาธารณะได้'); window.closeDeleteRoomModal(); return; }
            try {
                const { error } = await supabaseClient.from('rooms').delete().eq('id', window.currentRoomId).eq('owner_id', window.currentUser.id);
                if (error) throw error;
                alert('✅ ลบห้องสำเร็จ');
                window.closeDeleteRoomModal();
                if (localStorage.getItem(STORAGE_KEY) === window.currentRoomId) {
                    localStorage.removeItem(STORAGE_KEY);
                }
                await selectRoom(PUBLIC_ROOM_ID);
                await loadRooms();
            } catch (error) { console.error('❌ Error deleting room:', error); alert('ไม่สามารถลบห้องได้: ' + error.message); window.closeDeleteRoomModal(); }
        };

        // ========== CREATE ROOM ==========
        window.createRoom = async function(event) {
            event.preventDefault();
            try {
                const name = document.getElementById('roomName').value;
                const description = document.getElementById('roomDescription').value;
                const roomType = document.getElementById('roomType').value;
                const password = document.getElementById('roomPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (roomType === 'private') {
                    if (!password) { alert('กรุณาตั้งรหัสผ่านสำหรับห้องส่วนตัว'); return; }
                    if (password !== confirmPassword) { alert('รหัสผ่านไม่ตรงกัน'); return; }
                    if (password.length < 4) { alert('รหัสผ่านต้องมีอย่างน้อย 4 ตัวอักษร'); return; }
                }
                
                const { data: room, error } = await supabaseClient.from('rooms').insert([{
                    name, description, room_type: roomType,
                    password: roomType === 'private' ? password : null,
                    owner_id: window.currentUser.id,
                    created_at: new Date().toISOString()
                }]).select().single();
                
                if (error) throw error;
                await supabaseClient.from('room_members').insert([{
                    room_id: room.id,
                    user_id: window.currentUser.id,
                    role: 'owner',
                    joined_at: new Date().toISOString()
                }]);
                alert('✅ สร้างห้องสำเร็จ!');
                window.closeCreateRoomModal();
                await window.loadRooms();
                await window.selectRoom(room.id);
            } catch (error) { console.error('❌ Error creating room:', error); alert('เกิดข้อผิดพลาดในการสร้างห้อง: ' + error.message); }
        };

        // ========== ONLINE USERS ==========
        window.loadOnlineUsers = async function() {
            try {
                const { data, error } = await supabaseClient.from('profiles')
                    .select('username, display_name, avatar_url, is_admin')
                    .eq('is_online', true).limit(30);
                if (error) throw error;
                const userMap = new Map();
                data.forEach(user => { if (!userMap.has(user.username)) userMap.set(user.username, user); });
                const uniqueUsers = Array.from(userMap.values());
                const usersList = document.getElementById('onlineUsersList');
                const totalUsers = document.getElementById('totalUsers');
                if (usersList) {
                    if (uniqueUsers.length === 0) usersList.innerHTML = '<div style="text-align: center; padding: 20px; color: #a0aec0;">🟡 ไม่มีสมาชิกออนไลน์</div>';
                    else usersList.innerHTML = uniqueUsers.map(user => `<div class="online-user"><img src="${user.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.display_name || user.username)}&background=667eea&color=fff`}" alt="${user.display_name || user.username}" class="user-avatar"><span class="user-name">${user.display_name || user.username} ${user.is_admin ? '👑' : ''}</span><span class="online-dot"></span></div>`).join('');
                }
                if (totalUsers) totalUsers.textContent = uniqueUsers.length;
            } catch (error) { console.error('❌ Error loading online users:', error); }
        };

        // ========== ACTIVITIES ==========
        window.loadActivities = async function() {
            if (!window.currentRoomId) return;
            try {
                const { data: activities, error } = await supabaseClient
                    .from('activities')
                    .select(`
                        *,
                        creator:user_id (
                            username,
                            display_name,
                            avatar_url
                        ),
                        participants:activity_participants (
                            user_id,
                            joined_at,
                            profiles:user_id (
                                username,
                                display_name,
                                avatar_url
                            )
                        )
                    `)
                    .eq('room_id', window.currentRoomId)
                    .eq('status', 'active')
                    .order('created_at', { ascending: false });
                if (error) throw error;
                displayActivities(activities || []);
            } catch (error) { console.error('❌ Error loading activities:', error); }
        };

        window.displayActivities = function(activities) {
            const container = document.getElementById('activitiesList');
            if (!container) return;
            if (activities.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px 20px; color: #718096;">🎮 ยังไม่มีกิจกรรม<br><small>คลิก "สร้างกิจกรรม" เพื่อเริ่มต้น</small></div>';
                return;
            }
            container.innerHTML = activities.map(activity => {
                const isCreator = activity.user_id === window.currentUser.id;
                const isJoined = activity.participants?.some(p => p.user_id === window.currentUser.id);
                const participantsCount = activity.participants?.length || 1;
                let activityIcon = '✨';
                if (activity.activity_type === 'youtube') activityIcon = '📺';
                else if (activity.activity_type === 'game') activityIcon = '🎮';
                else if (activity.activity_type === 'poll') activityIcon = '📊';
                return `<div class="activity-item" id="activity-${activity.id}">
                    <div class="activity-header">
                        <div class="activity-title"><span>${activityIcon}</span> ${activity.title}</div>
                        <span class="activity-type-badge">${activity.activity_type}</span>
                    </div>
                    <div class="activity-creator">
                        <img src="${activity.creator?.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(activity.creator?.display_name || activity.creator?.username)}&background=667eea&color=fff`}" alt="creator" class="activity-creator-avatar">
                        <span>${activity.creator?.display_name || activity.creator?.username}</span>
                        ${isCreator ? '<span style="color: #48bb78;">👑</span>' : ''}
                    </div>
                    ${activity.description ? `<div class="activity-description">${activity.description}</div>` : ''}
                    <div class="activity-meta">
                        <span>👥 ${participantsCount}/${activity.max_participants || '∞'}</span>
                        <span>🕐 ${formatTime(activity.created_at)}</span>
                    </div>
                    <div class="activity-actions">
                        ${activity.activity_type === 'youtube' && activity.content ? `
                            <button type="button" 
                                    class="view-activity-btn" 
                                    onclick="window.openYoutubePlayer('${activity.id}', '${activity.content}')">
                                📺 ดู
                            </button>
                        ` : ''}
                        <button onclick="window.toggleJoinActivity('${activity.id}')" 
                                class="join-activity-btn ${isJoined ? 'joined' : ''}">
                            ${isJoined ? '❌ ออก' : '✅ เข้าร่วม'}
                        </button>
                        ${isCreator || window.isAdmin ? `
                            <button onclick="window.endActivity('${activity.id}')" class="btn" style="background: #f56565; color: white; padding: 8px; border-radius: 6px;">
                                ✕ จบ
                            </button>
                        ` : ''}
                    </div>
                </div>`;
            }).join('');
        };

        window.createActivity = async function(event) {
            event.preventDefault();
            try {
                const title = document.getElementById('activityTitle').value;
                const description = document.getElementById('activityDescription').value;
                const activityType = document.getElementById('activityType').value;
                const maxParticipants = parseInt(document.getElementById('maxParticipants').value) || 0;
                let content = '';
                let videoId = '';
                
                if (activityType === 'youtube') {
                    let url = document.getElementById('youtubeUrl').value;
                    if (!url) {
                        alert('❌ กรุณาใส่ URL YouTube');
                        return;
                    }
                    
                    if (url.includes('youtube.com/watch?v=')) {
                        videoId = url.split('v=')[1]?.split('&')[0];
                    } else if (url.includes('youtu.be/')) {
                        videoId = url.split('youtu.be/')[1];
                    } else if (url.includes('youtube.com/embed/')) {
                        videoId = url.split('/embed/')[1].split('?')[0];
                    }
                    
                    if (!videoId) {
                        alert('❌ ไม่พบ Video ID กรุณาตรวจสอบ URL');
                        return;
                    }
                    content = videoId;
                } else if (activityType === 'game') {
                    content = document.getElementById('gameName').value;
                } else if (activityType === 'poll') {
                    content = document.getElementById('pollOptions').value;
                }
                
                const { data, error } = await supabaseClient.from('activities').insert([{
                    room_id: window.currentRoomId,
                    user_id: window.currentUser.id,
                    title,
                    description,
                    activity_type: activityType,
                    content,
                    max_participants: maxParticipants,
                    participants_count: 1,
                    status: 'active',
                    created_at: new Date().toISOString()
                }]).select().single();
                
                if (error) throw error;
                
                await supabaseClient.from('activity_participants').insert([{
                    activity_id: data.id,
                    user_id: window.currentUser.id
                }]);
                
                if (activityType === 'youtube' && videoId) {
                    await supabaseClient.from('activity_sync').upsert({
                        activity_id: data.id,
                        user_id: window.currentUser.id,
                        player_state: 2,
                        playback_time: 0,
                        video_id: videoId,
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'activity_id,user_id' });
                }
                
                alert('✅ สร้างกิจกรรมสำเร็จ!');
                window.closeCreateActivityModal();
                window.loadActivities();
            } catch (error) { 
                console.error('❌ Error creating activity:', error); 
                alert('ไม่สามารถสร้างกิจกรรมได้: ' + error.message); 
            }
        };

        window.toggleJoinActivity = async function(activityId) {
            try {
                const { data: existing } = await supabaseClient.from('activity_participants')
                    .select('*').eq('activity_id', activityId).eq('user_id', window.currentUser.id).maybeSingle();
                
                if (existing) {
                    await supabaseClient.from('activity_participants').delete()
                        .eq('activity_id', activityId).eq('user_id', window.currentUser.id);
                    await supabaseClient.from('activity_sync').delete()
                        .eq('activity_id', activityId).eq('user_id', window.currentUser.id);
                } else {
                    await supabaseClient.from('activity_participants').insert([{
                        activity_id: activityId,
                        user_id: window.currentUser.id
                    }]);
                    
                    const { data: activity } = await supabaseClient.from('activities')
                        .select('activity_type, content').eq('id', activityId).single();
                    
                    if (activity?.activity_type === 'youtube') {
                        const { data: otherSync } = await supabaseClient.from('activity_sync')
                            .select('video_id, playback_time, player_state')
                            .eq('activity_id', activityId)
                            .neq('user_id', window.currentUser.id)
                            .limit(1)
                            .maybeSingle();
                        
                        await supabaseClient.from('activity_sync').upsert({
                            activity_id: activityId,
                            user_id: window.currentUser.id,
                            player_state: otherSync?.player_state || 2,
                            playback_time: otherSync?.playback_time || 0,
                            video_id: otherSync?.video_id || activity.content,
                            updated_at: new Date().toISOString()
                        }, { onConflict: 'activity_id,user_id' });
                    }
                }
                
                const { data: participants } = await supabaseClient.from('activity_participants')
                    .select('*').eq('activity_id', activityId);
                await supabaseClient.from('activities').update({ 
                    participants_count: participants.length 
                }).eq('id', activityId);
                
                window.loadActivities();
                if (window.youtubeActivityId === activityId) {
                    window.loadActivityParticipants(activityId);
                }
            } catch (error) { 
                console.error('❌ Error joining activity:', error); 
                alert('ไม่สามารถเข้าร่วมกิจกรรมได้'); 
            }
        };

        // ========== MODAL CONTROLS ==========
        window.showCreateActivityModal = function() {
            const modal = document.getElementById('createActivityModal');
            if (modal) modal.classList.add('active');
            window.toggleActivityTypeFields();
        };

        window.closeCreateActivityModal = function() {
            const modal = document.getElementById('createActivityModal');
            const form = document.getElementById('createActivityForm');
            if (modal) modal.classList.remove('active');
            if (form) form.reset();
        };

        window.toggleActivityTypeFields = function() {
            const type = document.getElementById('activityType').value;
            document.getElementById('youtubeField').style.display = type === 'youtube' ? 'block' : 'none';
            document.getElementById('gameField').style.display = type === 'game' ? 'block' : 'none';
            document.getElementById('pollField').style.display = type === 'poll' ? 'block' : 'none';
        };

        // ========== MUSIC PLAYER ==========
        window.openMusicPlayer = function() { 
            const modal = document.getElementById('musicPlayerModal'); 
            if (modal) { 
                modal.classList.add('active'); 
                window.loadPlaylist(); 
            } 
        };

        window.closeMusicPlayer = function() { 
            const modal = document.getElementById('musicPlayerModal'); 
            if (modal) modal.classList.remove('active'); 
        };

        window.addMusicToRoom = async function() {
            const urlInput = document.getElementById('musicUrlInput');
            if (!urlInput) return;
            const url = urlInput.value.trim();
            if (!url) { alert('❌ กรุณาใส่ URL เพลง'); return; }
            if (!url.toLowerCase().endsWith('.mp3')) {
                alert('❌ รองรับเฉพาะไฟล์ .mp3 เท่านั้น');
                return;
            }
            try {
                const musicInfo = { 
                    title: url.split('/').pop() || 'เพลงไม่มีชื่อ', 
                    artist: window.currentUser.user_metadata?.username || 'ผู้ใช้' 
                };
                const { error } = await supabaseClient.from('room_music').insert([{
                    room_id: window.currentRoomId,
                    user_id: window.currentUser.id,
                    music_url: url,
                    music_title: musicInfo.title,
                    music_artist: musicInfo.artist,
                    is_playing: false
                }]);
                if (error) throw error;
                urlInput.value = '';
                alert('✅ เพิ่มเพลงสำเร็จ');
                window.loadPlaylist();
            } catch (error) { 
                console.error('❌ Error adding music:', error); 
                alert('ไม่สามารถเพิ่มเพลงได้'); 
            }
        };

        window.loadPlaylist = async function() {
            if (!window.currentRoomId) return;
            try {
                const { data: playlist, error } = await supabaseClient.from('room_music')
                    .select('*, profiles:user_id(username, display_name)')
                    .eq('room_id', window.currentRoomId)
                    .order('created_at', { ascending: false });
                if (error) throw error;
                const container = document.getElementById('playlistItems');
                if (!container) return;
                if (playlist.length === 0) { 
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096;">🎵 ยังไม่มีเพลงในเพลย์ลิสต์</div>'; 
                    return; 
                }
                container.innerHTML = playlist.map(song => `
                    <div class="playlist-item">
                        <div class="playlist-info">
                            <div class="playlist-title">${song.music_title}</div>
                            <div class="playlist-artist">เพิ่มโดย ${song.profiles?.display_name || song.profiles?.username}</div>
                        </div>
                        <div class="playlist-controls">
                            <button onclick="window.playMusic('${song.id}', '${song.music_url}')" class="playlist-btn">▶️</button>
                            ${song.user_id === window.currentUser.id || window.isAdmin ? 
                                `<button onclick="window.removeMusic('${song.id}')" class="playlist-btn">🗑️</button>` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (error) { console.error('❌ Error loading playlist:', error); }
        };

        window.playMusic = async function(musicId, url) {
            try {
                if (window.audioPlayer) { 
                    window.audioPlayer.pause(); 
                    window.audioPlayer = null; 
                }
                if (!url.toLowerCase().endsWith('.mp3')) {
                    alert('❌ รองรับเฉพาะไฟล์ .mp3 เท่านั้น');
                    return;
                }
                window.audioPlayer = new Audio(url);
                await window.audioPlayer.play();
                window.currentMusic = { id: musicId, url };
                const musicBar = document.getElementById('currentMusicBar');
                const musicTitle = document.getElementById('currentMusicTitle');
                const playPauseBtn = document.getElementById('playPauseBtn');
                if (musicBar) musicBar.style.display = 'flex';
                if (musicTitle) musicTitle.textContent = document.querySelector(`[onclick*="${musicId}"]`)?.closest('.playlist-item')?.querySelector('.playlist-title')?.textContent || 'กำลังเล่นเพลง...';
                if (playPauseBtn) playPauseBtn.innerHTML = '⏸️';
                await supabaseClient.from('room_music').update({ is_playing: true }).eq('id', musicId);
            } catch (error) { 
                console.error('❌ Error playing music:', error); 
                alert('ไม่สามารถเล่นเพลงได้'); 
            }
        };

        window.togglePlayPause = function() {
            if (!window.audioPlayer) return;
            const playPauseBtn = document.getElementById('playPauseBtn');
            if (!playPauseBtn) return;
            if (window.audioPlayer.paused) { 
                window.audioPlayer.play(); 
                playPauseBtn.innerHTML = '⏸️'; 
            } else { 
                window.audioPlayer.pause(); 
                playPauseBtn.innerHTML = '▶️'; 
            }
        };

        window.stopMusic = function() {
            if (window.audioPlayer) { 
                window.audioPlayer.pause(); 
                window.audioPlayer.currentTime = 0; 
                window.audioPlayer = null; 
            }
            window.currentMusic = null;
            const musicBar = document.getElementById('currentMusicBar');
            if (musicBar) musicBar.style.display = 'none';
        };

        window.hideMusicBar = function() { 
            const musicBar = document.getElementById('currentMusicBar'); 
            if (musicBar) musicBar.style.display = 'none'; 
            if (window.audioPlayer) window.audioPlayer.pause();
        };

        window.removeMusic = async function(musicId) {
            if (!confirm('🗑️ ลบเพลงนี้ออกจากเพลย์ลิสต์?')) return;
            try {
                const { error } = await supabaseClient.from('room_music').delete().eq('id', musicId);
                if (error) throw error;
                if (window.currentMusic?.id === musicId) window.stopMusic();
                alert('✅ ลบเพลงสำเร็จ');
                window.loadPlaylist();
            } catch (error) { console.error('❌ Error removing music:', error); alert('ไม่สามารถลบเพลงได้'); }
        };
// ========== REAL-TIME CALL NOTIFICATIONS ==========

// สถานะการโทรปัจจุบัน
window.activeCall = {
    isActive: false,
    roomId: null,
    callRoom: null,
    participants: new Set()
};

// เริ่มการโทร (เรียลไทม์)
window.startCall = async function() {
    if (!window.currentRoomId) {
        alert('❌ กรุณาเลือกห้องก่อนโทร');
        return;
    }
    
    try {
        // สร้างชื่อห้องประชุม
        const callRoom = `chatapp-${window.currentRoomId}-${Date.now()}`;
        
        // แสดง modal
        const modal = document.getElementById('jitsiCallModal');
        const roomEl = document.getElementById('jitsiRoomName');
        roomEl.textContent = `📞 ${window.currentRoom?.name || 'ประชุม'}`;
        modal.classList.add('active');
        
        // สร้าง Jitsi Meet
        await initJitsiCall(callRoom);
        
        // ✅ ส่ง Realtime Notification ไปทั้งห้อง
        await sendRealtimeNotification({
            type: 'call_started',
            roomId: window.currentRoomId,
            callRoom: callRoom,
            startedBy: window.currentUser.id,
            startedByName: window.currentUser.user_metadata?.display_name || 
                          window.currentUser.user_metadata?.username || 
                          'ผู้ใช้',
            timestamp: new Date().toISOString()
        });
        
        // ✅ บันทึกประวัติการโทร
        await logCallActivity(callRoom);
        
        // ✅ Subscribe สถานะการโทร
        subscribeToCallStatus(window.currentRoomId);
        
    } catch (error) {
        console.error('❌ Error starting call:', error);
        alert('ไม่สามารถเริ่มการโทรได้');
    }
};

// ========== JITSI INIT ==========
async function initJitsiCall(callRoom) {
    return new Promise((resolve, reject) => {
        try {
            const container = document.getElementById('jitsi-container');
            container.innerHTML = '';
            
            const domain = 'meet.jit.si';
            const options = {
                roomName: callRoom,
                width: '100%',
                height: '100%',
                parentNode: container,
                configOverwrite: {
                    startWithAudioMuted: false,
                    startWithVideoMuted: false,
                    enableWelcomePage: false,
                    enableClosePage: false,
                    disableInviteFunctions: true,
                    prejoinPageEnabled: false,
                    resolution: 720,
                    constraints: {
                        video: {
                            height: { ideal: 720, max: 720, min: 240 }
                        }
                    }
                },
                interfaceConfigOverwrite: {
                    TOOLBAR_BUTTONS: [
                        'microphone', 'camera', 'closedcaptions', 'desktop',
                        'fullscreen', 'fodeviceselection', 'hangup',
                        'profile', 'chat', 'recording', 'etherpad',
                        'settings', 'raisehand', 'videoquality', 
                        'filmstrip', 'stats', 'shortcuts', 'tileview'
                    ],
                    SHOW_JITSI_WATERMARK: false,
                    SHOW_WATERMARK_FOR_GUESTS: false,
                    DEFAULT_BACKGROUND: '#0a0a0a',
                    DEFAULT_LOGO_URL: null,
                    MOBILE_APP_PROMO: false,
                    TOOLBAR_ALWAYS_VISIBLE: true
                },
                userInfo: {
                    displayName: window.currentUser?.user_metadata?.display_name || 
                                window.currentUser?.user_metadata?.username || 
                                'ผู้ใช้',
                    email: window.currentUser?.email || ''
                }
            };
            
            window.jitsiApi = new JitsiMeetExternalAPI(domain, options);
            
            // ✅ Event Listeners แบบ Real-time
            window.jitsiApi.addEventListeners({
                readyToClose: () => endCall(),
                videoConferenceJoined: (participant) => {
                    console.log('✅ Joined call:', participant);
                    window.activeCall.isActive = true;
                    window.activeCall.participants.add(participant.id);
                    
                    // ส่ง Notification เข้าร่วม
                    sendRealtimeNotification({
                        type: 'call_joined',
                        callRoom: callRoom,
                        userId: window.currentUser.id,
                        userName: options.userInfo.displayName,
                        timestamp: new Date().toISOString()
                    });
                },
                participantJoined: (participant) => {
                    console.log('👤 Participant joined:', participant);
                    window.activeCall.participants.add(participant.id);
                    
                    // ส่งข้อความในแชท
                    sendSystemMessage(`👤 ${participant.displayName} เข้าร่วมการโทร`);
                    
                    // อัปเดตจำนวนผู้เข้าร่วม Real-time
                    updateParticipantsCount();
                },
                participantLeft: (participant) => {
                    console.log('👤 Participant left:', participant);
                    window.activeCall.participants.delete(participant.id);
                    
                    sendSystemMessage(`👤 ${participant.displayName} ออกจากการโทร`);
                    updateParticipantsCount();
                },
                audioMuteStatusChanged: (data) => {
                    // อัปเดตสถานะไมค์ (optional)
                },
                videoMuteStatusChanged: (data) => {
                    // อัปเดตสถานะกล้อง (optional)
                },
                screenSharingStatusChanged: (data) => {
                    // อัปเดตสถานะแชร์หน้าจอ (optional)
                }
            });
            
            resolve();
            
        } catch (error) {
            reject(error);
        }
    });
}
        // ========== REAL-TIME NOTIFICATIONS ==========
        async function sendRealtimeNotification(data) {
            if (!window.currentRoomId) return;
            
            try {
                // ✅ 1. ส่งผ่าน Supabase Realtime
                await supabaseClient
                    .from('call_notifications')
                    .insert([{
                        room_id: window.currentRoomId,
                        call_data: data,
                        created_at: new Date().toISOString()
                    }]);
                    
                // ✅ 2. ส่งข้อความในแชท
                if (data.type === 'call_started') {
                    await sendSystemMessage(`📞 ${data.startedByName} เริ่มการโทร - คลิกปุ่ม 📞 เพื่อเข้าร่วม`);
                }
                
            } catch (error) {
                console.error('❌ Error sending notification:', error);
            }
        }
        
        // ========== SUBSCRIBE CALL STATUS ==========
        function subscribeToCallStatus(roomId) {
            if (window.callStatusSubscription) {
                window.callStatusSubscription.unsubscribe();
            }
            
            window.callStatusSubscription = supabaseClient
                .channel(`call-status-${roomId}`)
                .on(
                    'postgres_changes',
                    {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'call_notifications',
                        filter: `room_id=eq.${roomId}`
                    },
                    (payload) => {
                        // ✅ รับ Notification แบบ Real-time
                        const data = payload.new.call_data;
                        console.log('📢 Call notification:', data);
                        
                        // แสดง Toast Notification
                        if (data.type === 'call_started' && 
                            data.startedBy !== window.currentUser.id) {
                            showCallNotification(data);
                        }
                    }
                )
                .subscribe();
        }
        
        // ========== SHOW CALL NOTIFICATION ==========
        function showCallNotification(data) {
            // สร้าง Toast แจ้งเตือน
            const toast = document.createElement('div');
            toast.className = 'call-toast';
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <span style="font-size: 24px;">📞</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${data.startedByName} เริ่มการโทร</div>
                        <div style="font-size: 12px; opacity: 0.9;">คลิกเพื่อเข้าร่วม</div>
                    </div>
                    <button onclick="window.joinCall('${data.callRoom}')" style="padding: 8px 16px; background: white; color: #667eea; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        เข้าร่วม
                    </button>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer;">✕</button>
                </div>
            `;
            
            toast.style.position = 'fixed';
            toast.style.top = '20px';
            toast.style.right = '20px';
            toast.style.zIndex = '9999';
            toast.style.animation = 'slideIn 0.3s ease';
            
            document.body.appendChild(toast);
            
            // ซ่อนอัตโนมัติหลังจาก 10 วินาที
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 10000);
        }
        
        // ========== JOIN CALL ==========
        window.joinCall = async function(callRoom) {
            if (!callRoom) return;
            
            // ตรวจสอบว่ามีการโทรอยู่แล้วหรือไม่
            if (window.activeCall.isActive) {
                // อยู่ระหว่างการโทร ให้ถามก่อน
                if (!confirm('คุณกำลังอยู่ในการโทรอยู่แล้ว ต้องการออกจากการโทรเดิมและเข้าร่วมใหม่หรือไม่?')) {
                    return;
                }
                await endCall();
            }
            
            // เข้าร่วมการโทร
            window.currentCallRoom = callRoom;
            const modal = document.getElementById('jitsiCallModal');
            modal.classList.add('active');
            
            await initJitsiCall(callRoom);
            
            // ส่ง Notification เข้าร่วม
            await sendRealtimeNotification({
                type: 'call_joined',
                callRoom: callRoom,
                userId: window.currentUser.id,
                userName: window.currentUser.user_metadata?.display_name || 
                          window.currentUser.user_metadata?.username || 
                          'ผู้ใช้',
                timestamp: new Date().toISOString()
            });
        };
        
        // ========== UPDATE PARTICIPANTS COUNT ==========
        function updateParticipantsCount() {
            const count = window.activeCall.participants.size;
            const title = document.getElementById('jitsiRoomName');
            if (title) {
                title.innerHTML = `📞 ${window.currentRoom?.name || 'ประชุม'} <span style="font-size: 14px; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 12px;">${count} คน</span>`;
            }
        }
        
        // ========== SEND SYSTEM MESSAGE ==========
        window.sendSystemMessage = async function(text) {
            if (!window.currentRoomId) return;
            
            try {
                await supabaseClient.from('messages').insert([{
                    user_id: '00000000-0000-0000-0000-000000000000', // system
                    room_id: window.currentRoomId,
                    message: `📢 ${text}`,
                    created_at: new Date().toISOString()
                }]);
            } catch (error) {
                console.error('Error sending system message:', error);
            }
        };
        
        // ========== END CALL ==========
        window.endCall = async function() {
            const modal = document.getElementById('jitsiCallModal');
            modal.classList.remove('active');
            
            if (window.jitsiApi) {
                window.jitsiApi.dispose();
                window.jitsiApi = null;
            }
            
            // ส่ง Notification จบการโทร
            if (window.activeCall.isActive) {
                await sendRealtimeNotification({
                    type: 'call_ended',
                    callRoom: window.currentCallRoom,
                    userId: window.currentUser.id,
                    timestamp: new Date().toISOString()
                });
                
                await sendSystemMessage(`การโทรสิ้นสุดลง`);
            }
            
            // เคลียร์สถานะ
            window.activeCall = {
                isActive: false,
                roomId: null,
                callRoom: null,
                participants: new Set()
            };
            
            window.currentCallRoom = null;
            
            const container = document.getElementById('jitsi-container');
            container.innerHTML = '';
        };
        
        // ========== COPY CALL LINK ==========
        window.copyCallLink = function() {
            if (!window.currentCallRoom) return;
            
            const url = `https://meet.jit.si/${window.currentCallRoom}`;
            navigator.clipboard.writeText(url).then(() => {
                alert('✅ คัดลอกลิงก์เชิญแล้ว');
            }).catch(() => {
                prompt('📋 คัดลอกลิงก์นี้:', url);
            });
        };
        // ========== REALTIME ==========
        window.setupMessageSubscription = function(roomId) {
            if (window.messageSubscription) window.messageSubscription.unsubscribe();
            window.messageSubscription = supabaseClient.channel(`room-${roomId}`)
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `room_id=eq.${roomId}` }, async (payload) => {
                    const { data: profile } = await supabaseClient.from('profiles').select('username, display_name, avatar_url').eq('id', payload.new.user_id).single();
                    displayMessage({ ...payload.new, profiles: profile });
                })
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'messages', filter: `room_id=eq.${roomId}` }, async () => { await window.loadMessages(roomId); })
                .subscribe();
        };

        window.setupActivitiesSubscription = function(roomId) {
            if (window.activitiesSubscription) {
                window.activitiesSubscription.unsubscribe();
            }
            
            window.activitiesSubscription = supabaseClient.channel(`activities-${roomId}`)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'activities', filter: `room_id=eq.${roomId}` }, () => { window.loadActivities(); })
                .on('postgres_changes', { event: '*', schema: 'public', table: 'activity_participants', filter: `activity_id=in.(select id from activities where room_id = '${roomId}')` }, () => { 
                    window.loadActivities();
                    if (window.youtubeActivityId) window.loadActivityParticipants(window.youtubeActivityId);
                })
                .subscribe();
            
            return window.activitiesSubscription;
        };

        // ========== ROOM MODAL CONTROLS ==========
        window.showCreateRoomModal = function() { const modal = document.getElementById('createRoomModal'); if (modal) modal.classList.add('active'); };
        window.closeCreateRoomModal = function() {
            const modal = document.getElementById('createRoomModal');
            const form = document.getElementById('createRoomForm');
            const passwordField = document.getElementById('passwordField');
            if (modal) modal.classList.remove('active');
            if (form) form.reset();
            if (passwordField) passwordField.classList.remove('show');
        };
        window.togglePasswordField = function() {
            const roomType = document.getElementById('roomType');
            const passwordField = document.getElementById('passwordField');
            if (roomType && passwordField) passwordField.classList.toggle('show', roomType.value === 'private');
        };
        window.showJoinPrivateModal = function(room) {
            const nameEl = document.getElementById('joinRoomName');
            const modal = document.getElementById('joinPrivateRoomModal');
            if (nameEl) nameEl.textContent = `ห้อง: ${room.name}`;
            if (modal) { modal.dataset.roomId = room.id; modal.classList.add('active'); }
        };
        window.closeJoinPrivateModal = function() {
            const modal = document.getElementById('joinPrivateRoomModal');
            const passwordInput = document.getElementById('joinRoomPassword');
            if (modal) modal.classList.remove('active');
            if (passwordInput) passwordInput.value = '';
        };
        window.confirmJoinPrivateRoom = async function() {
            const modal = document.getElementById('joinPrivateRoomModal');
            const passwordInput = document.getElementById('joinRoomPassword');
            if (!modal || !passwordInput) return;
            const roomId = modal.dataset.roomId;
            const password = passwordInput.value;
            if (!password) { alert('❌ กรุณากรอกรหัสผ่าน'); return; }
            try {
                const { data: room, error } = await supabaseClient.from('rooms').select('*').eq('id', roomId).single();
                if (error) throw error;
                if (room.password !== password) { alert('❌ รหัสผ่านไม่ถูกต้อง'); return; }
                window.closeJoinPrivateModal();
                const { data: existingMember } = await supabaseClient.from('room_members').select('*').eq('room_id', roomId).eq('user_id', window.currentUser.id).maybeSingle();
                if (!existingMember) {
                    await supabaseClient.from('room_members').insert([{ room_id: roomId, user_id: window.currentUser.id, role: 'member', joined_at: new Date().toISOString() }]);
                }
                await window.selectRoom(roomId);
            } catch (error) { console.error('❌ Error joining private room:', error); alert('ไม่สามารถเข้าร่วมห้องได้: ' + error.message); }
        };

        // ========== UI CONTROLS ==========
        window.filterRooms = function(filter, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            window.loadRooms(filter);
        };
        window.displayUserInfo = function() {
            const userProfile = document.getElementById('userProfile');
            const username = window.currentUser.user_metadata?.display_name || window.currentUser.user_metadata?.username || 'ผู้ใช้';
            userProfile.innerHTML = `<img src="https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=667eea&color=fff" alt="${username}" class="avatar"><span class="username">${username} ${window.isAdmin ? '👑' : ''}</span>`;
        };

        // ========== EVENT LISTENERS ==========
        window.setupEventListeners = function() {
            if (window.sendButton) { 
                window.sendButton.removeEventListener('click', window.sendMessage); 
                window.sendButton.addEventListener('click', window.sendMessage); 
            }
            if (window.messageInput) {
                window.messageInput.removeEventListener('keydown', handleKeyDown);
                window.messageInput.addEventListener('keydown', handleKeyDown);
                window.messageInput.removeEventListener('input', handleInput);
                window.messageInput.addEventListener('input', handleInput);
            }
            const createRoomForm = document.getElementById('createRoomForm');
            if (createRoomForm) { 
                createRoomForm.removeEventListener('submit', window.createRoom); 
                createRoomForm.addEventListener('submit', window.createRoom); 
            }
            const createActivityForm = document.getElementById('createActivityForm');
            if (createActivityForm) {
                createActivityForm.removeEventListener('submit', window.createActivity);
                createActivityForm.addEventListener('submit', window.createActivity);
            }
        };

        function handleKeyDown(e) { 
            if (e.key === 'Enter' && !e.shiftKey) { 
                e.preventDefault(); 
                window.sendMessage(); 
            } 
        }

        function handleInput() {
            if (!window.messageInput) return;
            const count = window.messageInput.value.length;
            const charCount = document.getElementById('charCount');
            if (charCount) charCount.textContent = `${count}/500`;
            if (count > 500) window.messageInput.value = window.messageInput.value.slice(0, 500);
        }

        // ========== UTILITIES ==========
        window.formatTime = function(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            if (date.toDateString() === now.toDateString()) return date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
            if (diff < 86400000 * 2) return 'เมื่อวาน';
            return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
        };

        window.linkify = function(text) {
            if (!text) return '';
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
        };

        window.scrollToBottom = function() { 
            if (window.messagesContainer) window.messagesContainer.scrollTop = window.messagesContainer.scrollHeight; 
        };

        window.logout = async function() { 
            await supabaseClient.auth.signOut(); 
            window.location.href = 'index.html'; 
        };

        // ========== CLEANUP ==========
        window.addEventListener('beforeunload', () => {
            if (window.messageSubscription) window.messageSubscription.unsubscribe();
            if (window.readReceiptsSubscription) window.readReceiptsSubscription.unsubscribe();
            if (window.readReceiptObserver) window.readReceiptObserver.disconnect();
            if (window.activitiesSubscription) window.activitiesSubscription.unsubscribe();
            if (window.activitySyncSubscription) window.activitySyncSubscription.unsubscribe();
            if (window.audioPlayer) { window.audioPlayer.pause(); window.audioPlayer = null; }
            if (window.youtubePlayer) {
                try { window.youtubePlayer.destroy(); } catch (e) {}
                window.youtubePlayer = null;
            }
            if (window.youtubeSyncInterval) {
                clearInterval(window.youtubeSyncInterval);
                window.youtubeSyncInterval = null;
            }
        });

        // Auto-load YouTube API
        setTimeout(() => {
            if (!window.youtubeApiReady) {
                window.loadYouTubeAPI();
            }
        }, 2000);
    </script>
</body>
</html>



